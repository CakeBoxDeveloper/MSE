<!DOCTYPE html>
<html lang="ru">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSE - Твой спортивный прогресс</title> 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>  
        * { margin:0; padding:0; box-sizing:border-box; }
        :root { 
            --bg-primary:#000;
            --glass-bg:rgba(255,255,255,.05); 
            --glass-border:rgba(255,255,255,.1);
            --text-primary:#999;
            --text-secondary:#888;
            --text-tertiary:#666;
            --block-height:500px;
        }



/* ─── CHAT TAB DROPDOWN MENU ─── */
/* ─── CHAT TAB DROPDOWN MENU ─── */
/* ─── CHAT TAB DROPDOWN MENU ─── */
.chat-tab-menu {
    position:fixed;
    background:rgba(20,20,20,.95);
    border:1px solid var(--glass-border);
    border-radius:6px;
    padding:5px;
    display:none;
    flex-direction:column; /* ИЗМЕНИТЬ с row на column */
    gap:2px;
    z-index:500;
    backdrop-filter:blur(12px);
}
.chat-tab-menu.show { display:flex; }
.chat-tab-menu-item {
    width:34px;height:34px;
    background:transparent;
    border:none;
    border-radius:4px;
    cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    padding:0;
    transition:background .15s ease;
}
.chat-tab-menu-item:hover { background:rgba(255,255,255,.1); }
.chat-tab-menu-item img { width:14px;height:14px;opacity:.7; }
.chat-tab-menu-item span { /* ДОБАВИТЬ для текста */
    font-size:12px;
    color:var(--text-secondary);
    font-family:'Inter',sans-serif;
}

/* ДОБАВИТЬ стили для поля переименования */
.rename-input-wrap {
    position:fixed;
    background:rgba(20,20,20,.95);
    border:1px solid var(--glass-border);
    border-radius:6px;
    padding:8px;
    z-index:501;
    backdrop-filter:blur(12px);
    display:none;
}
.rename-input-wrap.show { display:block; }
.rename-input {
    width:180px;
    height:32px;
    padding:0 10px;
    background:rgba(255,255,255,.05);
    border:1px solid var(--glass-border);
    border-radius:4px;
    color:var(--text-primary);
    font-family:'Inter',sans-serif;
    font-size:12px;
}
.rename-input:focus {
    outline:none;
    background:rgba(255,255,255,.08);
    border-color:rgba(255,255,255,.2);
}
.rename-buttons {
    display:flex;
    gap:4px;
    margin-top:6px;
}
.rename-btn {
    flex:1;
    height:28px;
    background:rgba(255,255,255,.1);
    border:1px solid var(--glass-border);
    border-radius:4px;
    color:var(--text-primary);
    font-family:'Inter',sans-serif;
    font-size:11px;
    cursor:pointer;
    transition:all .15s ease;
}
.rename-btn:hover { background:rgba(255,255,255,.15); }
        
        body {
            font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
            background:var(--bg-primary);color:var(--text-primary);
            overflow-x:hidden;min-height:100vh;
            -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
        }
        .container { max-width:1400px;margin:0 auto;padding:0 20px; }
        .icon-gray { filter:invert(60%) sepia(0%) saturate(0%) brightness(100%) contrast(100%); }

        /* ─── HEADER ─── */
      header {
    position:sticky;
    top:0;
    z-index:100;
    padding:0;  /* УБРАТЬ верхний padding */
    background:transparent;
}
.header-inner {
    max-width:100%;
    margin:0 auto;
    padding:12px 20px;
    backdrop-filter:saturate(180%) blur(20px);
    background:var(--glass-bg);           /* ИЗМЕНИТЬ с red */
    border:1px solid var(--glass-border);
    border-top:none; /* ДОБАВИТЬ - убирает верхнюю линию */
    border-radius:0 0 8px 8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:20px;
}
.logo { 
    width:128px;
    height:32px;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-shrink:0;
}
       
.logo img { 
    width:100px;
    height:32px;
}

        
.header-login-btn {
    padding:6px 14px;
    background:rgba(255,255,255,.08);
    border:1px solid var(--glass-border);
    border-radius:5px;
    color:var(--text-primary);
    cursor:pointer;
    font-family:'Inter',sans-serif;
    font-size:13px;
    font-weight:500;
    transition:all .2s ease;
    /* УБРАТЬ margin-right:20px; */
}
        .header-login-btn:hover { background:rgba(255,255,255,.14); }

        /* ─── INNER TABS ─── */
        .inner-tabs { display:flex;gap:8px;margin-bottom:16px;flex-shrink:0;align-items:center; }
        .inner-tab {
            padding:8px 14px;background:transparent;border:1px solid var(--text-secondary);
            border-radius:6px;color:var(--text-secondary);cursor:pointer;font-family:'Inter',sans-serif;
            font-size:12px;font-weight:500;transition:all .2s ease;display:flex;align-items:center;gap:6px;
            height:34px;
        }
        .inner-tab-icon { width:14px;height:14px; }
        .inner-tab.active { background:var(--text-secondary);color:var(--bg-primary);border-color:var(--text-secondary); }
        .inner-tab.active .inner-tab-icon { filter:invert(0%) sepia(0%) saturate(0%) brightness(0%) contrast(100%); }
        .inner-tab:hover:not(.active) { border-color:rgba(255,255,255,.3); }

        /* ─── GRID ─── */
        .main-wrapper { margin-top:20px; }
.content-grid {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    align-items: start;
}

 
       @media(max-width:968px){
    .content-grid { flex-direction: column; } /* ИЗМЕНИТЬ */
}



/* ДОБАВИТЬ новый код */
.chat-tabs-wrapper {
    flex:1;
    min-width:0;
    position:relative;
    overflow:hidden;
    transition: mask-image 0.3s ease; /* ДОБАВИТЬ */
}

.chat-tabs-wrapper.blur-left {
  mask-image: linear-gradient(to right, transparent 0%, black 10%, black 100%);
  -webkit-mask-image: linear-gradient(to right, transparent 0%, black 10%, black 100%);
}

.chat-tabs-wrapper.blur-right {
  mask-image: linear-gradient(to right, black 0%, black 90%, transparent 100%);
  -webkit-mask-image: linear-gradient(to right, black 0%, black 90%, transparent 100%);
}

.chat-tabs-wrapper.blur-both {
  mask-image: linear-gradient(to right, transparent 0%, black 10%, black 90%, transparent 100%);
  -webkit-mask-image: linear-gradient(to right, transparent 0%, black 10%, black 90%, transparent 100%);
}
        

        /* ─── CONTENT BLOCK & MINIMIZE ANIMATION ─── */
.content-grid {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    align-items: start;
}

/* Когда оба свернуты - разносим по краям с пространством между */
.content-grid.both-collapsed {
    justify-content: space-between;
}

.content-block {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 5px;
    backdrop-filter: saturate(180%) blur(20px);
    height: var(--block-height);
    overflow: hidden;
    display: flex;
    flex-direction: row;
    flex: 1 1 0%;
    min-width: 0;
    transition: flex 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

.content-block.collapsed {
    flex: 0 0 54px;
}
        

        /* The actual body content */
.block-body {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    padding: 20px;
    overflow: hidden;
    filter: blur(0px);
    opacity: 1;
    transition: filter 0.8s ease, opacity 0.8s ease;
}

        /* Minimized vertical bar */
.minimized-bar {
    width: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: width 0.35s ease;
    cursor: pointer;
    flex-shrink: 0;
}

.minimized-bar .bar-icon {
    margin-top: 12px;
}

        .btn-minimize {
    width:34px;height:34px;background:transparent;border:1px solid var(--glass-border);
    border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;
    transition:all .15s ease;flex-shrink:0;
}
.btn-minimize:hover { background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.2); }
.btn-minimize img { width:14px;height:14px; }

/* Показываем minimize по умолчанию, maximize скрыт */
.btn-minimize .icon-minimize { display:block; }
.btn-minimize .icon-maximize { display:none; }

/* При сворачивании меняем иконки */
.content-block.minimized .btn-minimize .icon-minimize { display:none; }
.content-block.minimized .btn-minimize .icon-maximize { display:block; }

        .content-body { flex:1;display:flex;flex-direction:column;min-height:0; }

        /* ─── MATERIALS ─── */
        .materials-list { display:grid;gap:10px; }
        .material-item {
            background:rgba(255,255,255,.03);border:1px solid var(--glass-border);border-radius:5px;
            padding:14px;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;gap:12px;
        }
        .material-item:hover { background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18); }
        .material-icon {
            width:36px;height:36px;background:rgba(255,255,255,.08);border-radius:5px;
            display:flex;align-items:center;justify-content:center;flex-shrink:0;
        }
        .material-icon img { width:20px;height:20px;opacity:.7; }
        .material-info h3 { font-size:14px;font-weight:500;margin-bottom:4px;letter-spacing:-.2px; }
        .material-info p { font-size:12px;color:var(--text-secondary);letter-spacing:-.1px; }

        /* ─── CHAT PANEL ─── */
        .chat-top-bar {
            display:flex;
            align-items:center;
            gap:8px;
            flex-shrink:0;
            margin-bottom:12px;
            position:relative;
            width:100%;
            overflow:visible;
        }
        .chat-new-btn {
            width:34px;height:34px;background:transparent;border:1px solid var(--glass-border);border-radius:4px;
            color:var(--text-tertiary);font-family:'Inter',sans-serif;font-size:18px;font-weight:400;
            cursor:pointer;white-space:nowrap;transition:all .15s ease;flex-shrink:0;
            display:flex;align-items:center;justify-content:center;
        }
        .chat-new-btn:hover { background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2);color:var(--text-secondary); }

        /* ─── CHAT TABS SLIDER ─── */
        .chat-tabs-wrapper {
            flex:1;
            min-width:0;
            position:relative;
            overflow:hidden;
        }
        
       
      

        .chat-tabs {
            display:flex;gap:6px;
            overflow-x:auto;
            scrollbar-width:none;
            scroll-behavior:smooth;
        }
        .chat-tabs::-webkit-scrollbar { display:none; }

        .chat-tab {
            padding:0 10px;height:34px;background:transparent;border:1px solid var(--glass-border);border-radius:5px;
            color:var(--text-secondary);font-family:'Inter',sans-serif;font-size:11px;font-weight:500;
            cursor:pointer;white-space:nowrap;transition:all .15s ease;
            flex-shrink:0;
            display:flex;align-items:center;justify-content:center;
            position:relative;
        }
        .chat-tab:hover:not(.active) { border-color:rgba(255,255,255,.22); }
        .chat-tab.active { background:var(--text-secondary);color:var(--bg-primary);border-color:var(--text-secondary); }
.chat-tab.pinned {
    border-style:dashed;
    border-color:rgba(255,255,255,.2);
    border-width:2px;
}
.chat-tab.pinned:hover {
    border-color:rgba(255,255,255,.28);
}
         

        .chat-right-controls {
            display:flex;gap:8px;align-items:center;
            flex-shrink:0;
        }
        .chat-search-btn {
            width:34px;height:34px;background:transparent;border:1px solid var(--glass-border);border-radius:4px;
            cursor:pointer;display:flex;align-items:center;justify-content:center;
            transition:all .15s ease;flex-shrink:0;
        }
        .chat-search-btn:hover { background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2); }
        .chat-search-btn svg { width:14px;height:14px;stroke:var(--text-secondary);fill:none;stroke-width:2;stroke-linecap:round; }

        .chat-search-wrap {
            position:absolute;top:calc(100% + 8px);right:0;width:200px;
            display:none;z-index:50;
        }
        .chat-search-wrap.open { display:block; }
        .chat-search-input {
            width:100%;height:34px;padding:0 12px;background:rgba(30,30,30,.95);
            border:1px solid var(--glass-border);border-radius:5px;color:var(--text-primary);
            font-family:'Inter',sans-serif;font-size:12px;backdrop-filter:blur(10px);
        }
        .chat-search-input:focus { outline:none;border-color:rgba(255,255,255,.2);background:rgba(40,40,40,.95); }
        .chat-search-input::placeholder { color:var(--text-tertiary); }

        .chat-container { display:flex;flex-direction:column;flex:1;min-height:0; }
        .chat-messages { flex:1;overflow-y:auto;padding:10px 0;margin-bottom:12px;display:flex;flex-direction:column;gap:10px; }
        .chat-messages::-webkit-scrollbar { width:4px; }
        .chat-messages::-webkit-scrollbar-track { background:transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background:rgba(255,255,255,.2);border-radius:2px; }
        .chat-message {
            padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid var(--glass-border);
            border-radius:5px;font-size:13px;max-width:85%;line-height:1.5;letter-spacing:-.1px;
        }
        .chat-message.ai  { align-self:flex-start; }
        .chat-message.user { align-self:flex-end;background:rgba(255,255,255,.08); }

        .chat-empty-state {
            flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
            text-align:center;padding:20px 10px;gap:16px;pointer-events:none;
        }
        .chat-empty-state .sofia-icon { width:90px;height:90px;opacity:.5; }
        .chat-empty-state .sofia-icon img { width:100%;height:100%;opacity:.7; }
        .chat-empty-state p { font-size:13px;line-height:1.6;color:var(--text-secondary);letter-spacing:-.15px;max-width:260px; }

        .chat-input-wrapper { display:flex;gap:8px;flex-shrink:0;align-items:stretch; }
        .chat-input {
            flex:1;padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid var(--glass-border);
            border-radius:5px;color:var(--text-primary);font-family:'Inter',sans-serif;font-size:13px;transition:all .2s ease;
            height:40px;
        }
        .chat-input::placeholder { color:var(--text-tertiary); }
        .chat-input:focus { outline:none;background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.2); }


.chat-attach {
    width:40px;height:40px;background:rgba(255,255,255,.06);border:1px solid var(--glass-border);
    border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;
    transition:all .15s ease;flex-shrink:0;position:relative;
}
.chat-attach:hover { background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2); }
.chat-attach img { width:18px;height:18px;opacity:.7; }
.chat-attach input[type="file"] { display:none; }

.chat-file-preview {
    display:none;
    gap:4px;
    padding:4px 6px;
    flex-wrap:wrap;
    background:rgba(255,255,255,.03);
    border:1px solid var(--glass-border);
    border-radius:4px;
    margin-bottom:8px;
}


.chat-message-image {
    max-width:150px;
    max-height:150px;
    border-radius:5px;
    cursor:pointer;
    transition:opacity .2s ease;
    margin-top:6px;
}
.chat-message-image:hover { opacity:.85; }

.chat-message-attachment {
    display:flex;
    align-items:center;
    gap:6px;
    margin-top:8px;
    padding-top:8px;
    border-top:1px solid rgba(255,255,255,.05);
    font-size:12px;
    color:var(--text-secondary);
}
.chat-message-attachment img { width:14px;height:14px;opacity:.6; }

/* When attachment is the only content (no text), remove the separator line */
.chat-message-attachment.no-sep {
    border-top: none;
    padding-top: 0;
    margin-top: 0;
}

.image-modal {
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,.9);
    backdrop-filter:blur(10px);
    z-index:2000;
    display:none;
    align-items:center;
    justify-content:center;
    cursor:pointer;
}
.image-modal.show { display:flex; }
.image-modal img {
    max-width:90%;
    max-height:90%;
    border-radius:8px;
    box-shadow:0 0 40px rgba(0,0,0,.5);
}

/* PDF MODAL */
.pdf-modal-overlay {
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,.9);
    backdrop-filter:blur(10px);
    z-index:2000;
    display:none;
    align-items:center;
    justify-content:center;
    cursor:pointer;
}
.pdf-modal-overlay.show { display:flex; }

.pdf-modal-content {
    display:flex;
    flex-direction:column;
    width:90%;
    max-width:595px; /* A4 width approx in px for 96dpi */
    height:90%;
    background:rgba(255,255,255,.98);
    border-radius:8px;
    box-shadow:0 0 40px rgba(0,0,0,.5);
    overflow:hidden;
    cursor:default;
}
.pdf-modal-viewer {
    flex:1;overflow-y:auto;overflow-x:hidden;scrollbar-width:none;
}
.pdf-modal-viewer::-webkit-scrollbar{display:none}
.pdf-modal-download{padding:12px;border-top:1px solid rgba(0,0,0,.06);background:rgba(255,255,255,.98)}
.pdf-download-btn{width:100%;padding:12px 14px;background:rgba(100,100,100,.85);border-radius:6px;border:1px solid rgba(0,0,0,.08);color:#fff;font-weight:600;cursor:pointer}
.pdf-download-btn:hover{background:rgba(90,90,90,.95)}

        
.chat-file-item {
    display:flex;align-items:center;gap:4px;padding:3px 6px;
    background:rgba(255,255,255,.08);border:1px solid var(--glass-border);
    border-radius:4px;font-size:10px;color:var(--text-secondary);
}
.chat-file-item img.file-icon { width:12px;height:12px;opacity:.6; }
.chat-file-item .file-remove {
    width:12px;height:12px;cursor:pointer;opacity:.5;
    transition:opacity .15s ease;
}
.chat-file-item .file-remove:hover { opacity:1; }




        


        
        .chat-send {
    width:40px;height:40px;background:rgba(255,255,255,.06);border:1px solid var(--glass-border);
    border-radius:5px;color:var(--text-primary);font-family:'Inter',sans-serif;font-weight:500;
    cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center;
    padding:0;
}
.chat-send:hover { background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2); }
.chat-send img { width:18px;height:18px;opacity:.7; }

        /* ─── EMPTY STATE ─── */
        .empty-state { text-align:center;padding:60px 20px;color:var(--text-secondary); }
        .empty-state-icon { margin-bottom:16px;opacity:.4; }
        .empty-state-icon img { width:90px;height:90px;opacity:.7; }
        .empty-state h3 { font-size:15px;margin-bottom:8px;color:var(--text-primary);font-weight:500;letter-spacing:-.2px; }
        .empty-state p { font-size:13px;line-height:1.5;letter-spacing:-.1px; }

        /* ─── AUTH MODAL ─── */
        .auth-overlay {
            position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);
            backdrop-filter:saturate(180%) blur(20px);z-index:1000;display:flex;align-items:center;
            justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s ease;
        }
        .auth-overlay.active { opacity:1;pointer-events:all; }

        .auth-modal {
            background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:5px;padding:24px;
            backdrop-filter:saturate(180%) blur(20px);
            width:320px; /* Фиксированная начальная ширина */
            max-width:calc(100% - 40px);
            /* ПЛАВНОЕ изменение размера */
            transition:transform .3s ease, width .8s cubic-bezier(0.4,0,0.2,1);
            transform:scale(.9);
        }
        .auth-overlay.active .auth-modal { transform:scale(1); }

        .auth-form { display:flex;flex-direction:column;gap:12px;width:100%; }
        .form-group { display:flex;flex-direction:column;gap:6px;width:100%; }
        .form-input {
            padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid var(--glass-border);
            border-radius:5px;color:var(--text-primary);font-family:'Inter',sans-serif;font-size:14px;
            transition:all .2s ease;letter-spacing:-.2px;width:100%;
        }
        .form-input.error { border-color:rgba(255,80,80,.5); }
        .form-input::placeholder { color:var(--text-tertiary); }
        .form-input:focus { outline:none;background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.2); }
        .form-input.error:focus { border-color:rgba(255,80,80,.5); }
        .form-input[type="number"] { -moz-appearance:textfield; }
        .form-input[type="number"]::-webkit-outer-spin-button,
        .form-input[type="number"]::-webkit-inner-spin-button { -webkit-appearance:none;margin:0; }

        .pin-input-container { display:flex;gap:12px;justify-content:space-between;margin:0 0 16px 0;width:100%; }
        .pin-digit {
            flex:1;min-width:0;height:60px;background:rgba(255,255,255,.05);border:1px solid var(--glass-border);
            border-radius:8px;color:var(--text-primary);font-family:'Inter',sans-serif;font-size:24px;
            font-weight:600;text-align:center;transition:all .2s ease;
        }
        .pin-digit.error { border-color:rgba(255,80,80,.5) !important; }
        .pin-digit:focus { outline:none;background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.3); }
        .pin-digit.error:focus { border-color:rgba(255,80,80,.5) !important; }
        .pin-digit[type="number"] { -moz-appearance:textfield; }
        .pin-digit[type="number"]::-webkit-outer-spin-button,
        .pin-digit[type="number"]::-webkit-inner-spin-button { -webkit-appearance:none;margin:0; }

        .auth-buttons { display:flex;gap:8px;margin-top:8px;width:100%; }
        .auth-btn {
            flex:1;padding:10px 16px;background:rgba(255,255,255,.1);border:1px solid var(--glass-border);
            border-radius:5px;color:var(--text-primary);font-family:'Inter',sans-serif;font-weight:500;
            cursor:pointer;transition:all .2s ease;font-size:13px;
        }
        .auth-btn:hover { background:rgba(255,255,255,.15); }
        .auth-btn.primary { background:rgba(255,255,255,.15); }
        .auth-btn.primary:hover { background:rgba(255,255,255,.22); }
        .auth-btn:disabled { opacity:.5;cursor:not-allowed; }
        .auth-switch { margin-top:12px;text-align:center;font-size:12px;color:var(--text-secondary); }
        .auth-switch button { background:none;border:none;color:var(--text-primary);cursor:pointer;text-decoration:underline;font-family:'Inter',sans-serif;font-size:12px; }

        /* Register form */
        .register-form-content { display:flex;flex-direction:column;align-items:stretch;width:100%;gap:16px; }
        .register-form-content .auth-header { font-size:18px;font-weight:600;letter-spacing:-.3px;text-align:center;width:100%; }
        .user-id-display {
            padding:16px;background:rgba(255,255,255,.08);border:1px solid var(--glass-border);
            border-radius:5px;display:flex;align-items:center;justify-content:center;
            flex-wrap:wrap;gap:8px;width:100%;
        }
        .user-id-label { font-size:14px;color:var(--text-secondary);letter-spacing:-.2px;font-weight:600; }
        .user-id-number { font-size:14px;color:var(--text-secondary);letter-spacing:-.2px;font-weight:600; }
        .register-form-content .auth-form { width:100%;display:flex;flex-direction:column;gap:0; }
        .register-form-content .form-label-key {
            text-align:center;font-size:14px;font-weight:600;
            display:flex;align-items:center;justify-content:center;gap:8px;
            width:100%;margin:0 0 16px 0;
        }
        .key-icon { width:20px;height:20px; }

        .checkbox-group { display:flex;align-items:center;gap:8px;width:100%; }
        .checkbox-group input[type="checkbox"] {
            appearance:none;width:18px;height:18px;border:2px solid var(--text-secondary);border-radius:3px;
            cursor:pointer;position:relative;transition:all .2s ease;background:transparent;flex-shrink:0;
        }
        .checkbox-group input[type="checkbox"]:checked { background:var(--text-secondary);border-color:var(--text-secondary); }
        .checkbox-group input[type="checkbox"]:checked::after {
            content:'';position:absolute;left:5px;top:2px;width:4px;height:8px;
            border:solid var(--bg-primary);border-width:0 2px 2px 0;transform:rotate(45deg);
        }
        .checkbox-group label { font-size:12px;color:var(--text-secondary);cursor:pointer; }
        .checkbox-group a { color:var(--text-secondary);text-decoration:underline; }

        .loader {
            width:30px;height:30px;border:2px solid rgba(255,255,255,.1);border-top-color:var(--text-primary);
            border-radius:50%;animation:spin .6s linear infinite;margin:20px auto;
        }
        @keyframes spin { to{transform:rotate(360deg);} }
        .success-text { text-align:center;font-size:14px;color:var(--text-primary);margin-top:12px;font-weight:500; }
        .fullscreen-loader { display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px; }
        .fullscreen-success { display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;text-align:center;padding:20px; }
        .fullscreen-success .success-text { font-size:15px;line-height:1.6; }
        .logout-modal { text-align:center; }

        @media(max-width:480px){
            .container{ padding:0 16px; }
            .block-body{ padding:16px; }
            header{ padding:8px 0 0 0; }
            .header-inner{ padding:10px 16px; }
            .logo{ width:29px;height:29px; }
            .logo img{ width:86px;height:86px; }
            .pin-digit{ height:55px;font-size:20px; }
        }
    </style>
</head>
<body>

<header>
  <div class="container"> <!-- ДОБАВИТЬ -->
    <div class="header-inner">
      <div class="logo">
        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/c3a01dd59275d25a96184e99df50a8dc3dd27667/MSESVG.svg" alt="">
      </div>
      <button class="header-login-btn" id="headerLoginBtn">Вход в сеть</button>
    </div>
  </div> <!-- ДОБАВИТЬ -->
</header>

<div class="container">
  <div class="main-wrapper">
    <div class="content-grid" id="contentGrid">

      <!-- LEFT BLOCK -->
      <div class="content-block" id="browserBlock">
        <div class="minimized-bar" id="browserMinBar" onclick="toggleMinimize('browserBlock')">
          <div class="bar-icon">
            <div class="btn-minimize" style="pointer-events:none;">
    <img class="icon-minimize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78604dcba41d217a860371149b6158d31c153e7f/minimize.svg?raw=true" alt="">
    <img class="icon-maximize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78ad84a8d8488e581eeca239a46eda3b65253af3/expand.svg" alt="">
</div>
          </div>
        </div>
        <div class="block-body" id="browserBody">
          <div class="inner-tabs">
            <button class="inner-tab active" data-inner="materials">
              <img class="inner-tab-icon icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/770747b8e4153b1de7ae798eb169e0b221be1bba/tab_materials.svg" alt="">
              <span>Материалы</span>
            </button>
            <button class="inner-tab" data-inner="workouts">
              <img class="inner-tab-icon icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/d48e325735969dad640d1448cc8dcc659fbb6862/tab_workouts.svg" alt="">
              <span>Тренировки</span>
            </button>
            <button class="inner-tab" data-inner="progress">
              <img class="inner-tab-icon icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/ffc7247d623b23ad966683313d80a037517dff60/tab_progress.svg" alt="">
              <span>Прогресс</span>
            </button>
            <button class="btn-minimize" onclick="event.stopPropagation(); toggleMinimize('browserBlock')" style="margin-left:auto;">
    <img class="icon-minimize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78604dcba41d217a860371149b6158d31c153e7f/minimize.svg?raw=true" alt="">
    <img class="icon-maximize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78ad84a8d8488e581eeca239a46eda3b65253af3/expand.svg" alt="">
</button>
          </div>
          <div class="content-body" id="main-content"></div>
        </div>
      </div>

      <!-- RIGHT BLOCK -->
      <div class="content-block" id="chatBlock">
       <div class="minimized-bar" id="chatMinBar" onclick="toggleMinimize('chatBlock')">
  <div class="bar-icon">
    <div class="btn-minimize" style="pointer-events:none;">
      <img class="icon-minimize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78604dcba41d217a860371149b6158d31c153e7f/minimize.svg?raw=true" alt="">
      <img class="icon-maximize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/3bcfa3f01b7a0cbaa8bbe8c35458c43f0ac67399/expand.svg" alt="">
    </div>
  </div>
</div>
        <div class="block-body" id="chatBody">
          <div class="chat-top-bar">
           <button class="chat-new-btn" onclick="addChatTab()">
    <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/9732c784325850db295c23102be226588b219c01/new-chat.svg" alt="" style="width:16px;height:16px;">
</button>
            <div class="chat-tabs-wrapper" id="chatTabsWrapper">
              <div class="chat-tabs" id="chatTabs">
                <button class="chat-tab active" data-chat="sofia" data-base="true">
                  <span>София</span>
                </button>
              </div>
            </div>
            <div class="chat-right-controls">
              <button class="chat-search-btn" onclick="toggleChatSearch()">
                <svg viewBox="0 0 16 16"><circle cx="6" cy="6" r="4"/><line x1="9" y1="9" x2="14" y2="14"/></svg>
              </button>
            <button class="btn-minimize" onclick="event.stopPropagation(); toggleMinimize('chatBlock')" style="margin-left:auto;">
    <img class="icon-minimize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78604dcba41d217a860371149b6158d31c153e7f/minimize.svg?raw=true" alt="">
    <img class="icon-maximize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78ad84a8d8488e581eeca239a46eda3b65253af3/expand.svg" alt="">
</button>
            </div>
            <div class="chat-search-wrap" id="chatSearchWrap">
              <input type="text" class="chat-search-input" id="chatSearchInput" placeholder="Поиск чатов…">
            </div>
          </div>
          <div class="chat-container">
            <div class="chat-messages" id="chat-messages"></div>
      <div style="display:flex;flex-direction:column;flex-shrink:0;">
  <div style="position:relative;display:flex;flex-direction:column;">
    <div class="chat-file-preview" id="chat-file-preview"></div>
    <div class="chat-input-wrapper">
      <input type="text" class="chat-input" id="chat-input" placeholder="Задай вопрос Софии...">
      <button class="chat-attach" id="chat-attach">
        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/6dcd23d0286a4a0edc50bd9410d7ac9a26b6b41c/attach.svg" alt="">
        <input type="file" id="chat-file-input" multiple accept="*/*">
      </button>
      <button class="chat-send" id="chat-send">
        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/f4325dd706d24eb3c1058e176da6daac524a38e8/send.svg" alt="">
      </button>
    </div>
  </div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-modal" id="authModal">
    <!-- LOGIN -->
    <div id="loginForm">
      <div id="loginContent">
        <h2 class="auth-header" style="font-size:18px;font-weight:600;margin-bottom:8px;letter-spacing:-.3px;text-align:center;">Вход в сеть</h2>
        <form class="auth-form" onsubmit="return false;">
          <div class="form-group" id="stepId">
            <input type="number" class="form-input" id="loginId" placeholder="Введите номер звена" autocomplete="off">
          </div>
          <div id="loginTransitionLoader" style="display:none;"><div class="loader"></div></div>
          <div class="form-group" id="stepPin" style="display:none;">
            <div class="pin-input-container">
              <input type="number" class="pin-digit" id="loginPin1" maxlength="1" autocomplete="off">
              <input type="number" class="pin-digit" id="loginPin2" maxlength="1" autocomplete="off">
              <input type="number" class="pin-digit" id="loginPin3" maxlength="1" autocomplete="off">
              <input type="number" class="pin-digit" id="loginPin4" maxlength="1" autocomplete="off">
            </div>
          </div>
          <div class="auth-buttons" id="loginButtons">
            <button type="button" class="auth-btn" onclick="closeAuth()">Отмена</button>
          </div>
        </form>
        <div class="auth-switch">Нет аккаунта? <button onclick="showRegister()">Присоединиться к MSE</button></div>
      </div>
      <div id="loginToRegisterLoader" class="fullscreen-loader" style="display:none;"><div class="loader"></div></div>
      <div id="loginLoader" class="fullscreen-loader" style="display:none;"><div class="loader"></div></div>
      <div id="loginSuccess" class="fullscreen-success" style="display:none;"><div class="success-text">Вход разрешён</div></div>
    </div>
    <!-- REGISTER -->
    <div id="registerForm" style="display:none;">
      <div id="registerContent">
        <div class="register-form-content">
          <h2 class="auth-header">Новое подключение к сети MSE</h2>
          <div class="user-id-display">
            <span class="user-id-label">Вы станете звеном под номером:</span>
            <span class="user-id-number" id="newUserId">----</span>
          </div>
          <form class="auth-form" onsubmit="return false;">
            <div class="form-label-key">
              <img class="key-icon icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/86e9d94bad44abbb9f11716894a6a30d68de3fac/key.svg" alt="">
              <span>Создайте уникальный ключ доступа</span>
            </div>
            <div class="pin-input-container">
              <input type="number" class="pin-digit" id="pin1" maxlength="1" autocomplete="off">
              <input type="number" class="pin-digit" id="pin2" maxlength="1" autocomplete="off">
              <input type="number" class="pin-digit" id="pin3" maxlength="1" autocomplete="off">
              <input type="number" class="pin-digit" id="pin4" maxlength="1" autocomplete="off">
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="termsCheckbox">
              <label for="termsCheckbox">Я принимаю <a href="#" target="_blank">условия подключения к сети MSE</a></label>
            </div>
            <div class="auth-buttons" id="registerButtons">
              <button type="button" class="auth-btn" onclick="closeAuth()">Отмена</button>
              <button type="submit" class="auth-btn primary" onclick="register()" id="registerBtn" disabled>Создать аккаунт</button>
            </div>
          </form>
        </div>
      </div>
      <div id="registerLoader" class="fullscreen-loader" style="display:none;"><div class="loader"></div></div>
      <div id="registerSuccess" class="fullscreen-success" style="display:none;"><div class="success-text"></div></div>
    </div>
    <!-- LOGOUT -->
    <div id="logoutModal" style="display:none;">
      <div class="logout-modal">
        <h2 class="auth-header" style="font-size:18px;font-weight:600;margin-bottom:12px;letter-spacing:-.3px;text-align:center;">Выход из сети</h2>
        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:20px;line-height:1.5;text-align:center;">Вы уверены, что хотите выйти из аккаунта?</p>
        <div class="auth-buttons">
          <button type="button" class="auth-btn" onclick="closeAuth()">Отмена</button>
          <button type="button" class="auth-btn primary" onclick="confirmLogout()">Выйти</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- PDF Modal -->
<div class="pdf-modal-overlay" id="pdfModalOverlay">
    <div class="pdf-modal-content" onclick="event.stopPropagation();">
        <div class="pdf-modal-viewer" id="pdfModalViewer"></div>
        <div class="pdf-modal-download">
            <button class="pdf-download-btn" onclick="downloadPDF()">Скачать</button>
        </div>
    </div>
</div>

<div class="image-modal" id="imageModal">
    <img id="modalImage" src="" alt="">
</div>

<script>
// ============================================================
// MINIMIZE / EXPAND with smooth animation
// ============================================================
const COLLAPSED_WIDTH = '54px';
const FADE_DURATION = 350;
const RESIZE_DURATION = 800;

const blockState = { browserBlock: false, chatBlock: false };

function toggleMinimize(id) {
    closeAllMenus();
    if (blockState[id]) {
        expandBlock(id);
    } else {
        collapseBlock(id);
    }
}

function updateGridState() {
    const grid = document.getElementById('contentGrid');
    const bothCollapsed = blockState.browserBlock && blockState.chatBlock;
    
    if (bothCollapsed) {
        grid.classList.add('both-collapsed');
    } else {
        grid.classList.remove('both-collapsed');
    }
}

function collapseBlock(id) {
    blockState[id] = true;
    const block = document.getElementById(id);
    const body = block.querySelector('.block-body');
    const bar = block.querySelector('.minimized-bar');

   // НЕ добавляем класс сразу - добавим в середине анимации
    
    // ОБНОВЛЯЕМ СОСТОЯНИЕ ДО АНИМАЦИИ при сворачивании
    updateGridState();
    
    // ШАГ 1: Blur и fade-out контента одновременно со сворачиванием
    body.style.filter = 'blur(8px)';
    body.style.opacity = '0';
    
    // Запускаем одновременное сворачивание блока и расширение соседнего
    block.classList.add('collapsed');
       setTimeout(() => {
        block.classList.add('minimized');
    }, RESIZE_DURATION / 2);
    
    // ШАГ 2: После завершения видимой части анимации показываем bar
    setTimeout(() => {
        body.style.display = 'none';
        bar.style.width = COLLAPSED_WIDTH;
    }, RESIZE_DURATION / 2);
}

function expandBlock(id) {
    blockState[id] = false;
    const block = document.getElementById(id);
    const body = block.querySelector('.block-body');
    const bar = block.querySelector('.minimized-bar');

   // НЕ убираем класс сразу - уберём в середине анимации
    
    // ШАГ 1: Скрываем bar
    bar.style.width = '0px';
    
    // НЕ обновляем grid state ДО анимации - только ПОСЛЕ
    
    // ШАГ 2: Показываем контент с blur и opacity=0 (готовим для разблюривания)
    body.style.display = 'flex';
    body.style.filter = 'blur(8px)';
    body.style.opacity = '0';
    
    // ШАГ 3: Запускаем расширение (соседний блок автоматически сжимается)
    block.classList.remove('collapsed');
    // Меняем иконку в середине анимации (когда она скрыта)
setTimeout(() => {
    block.classList.remove('minimized');
}, RESIZE_DURATION / 2);
    
    // ШАГ 4: Одновременно с расширением разблюриваем и проявляем контент
    setTimeout(() => {
        body.style.filter = 'blur(0px)';
        body.style.opacity = '1';
    }, 50);
    
    // ШАГ 5: Обновляем grid state ПОСЛЕ завершения анимации
    setTimeout(() => {
        updateGridState();
    }, RESIZE_DURATION);
}
 

 

// ============================================================
// AUTH - с улучшенными анимациями размера
// ============================================================
let users = [{ id:1001, pin:'1234', createdAt: new Date().toISOString() }];
let currentUser = null;

document.getElementById('headerLoginBtn').addEventListener('click', () => {
    currentUser ? showLogout() : showLogin();
});

const LOGIN_WIDTH = '320px';
const REG_WIDTH = '380px';
const SUCCESS_WIDTH = '340px'; // Оптимальная ширина для сообщения об успехе

function setModalWidth(w) {
    const m = document.getElementById('authModal');
    m.style.width = w;
}

function showLogin() {
    const modal = document.getElementById('authModal');
    modal.style.width = LOGIN_WIDTH; // Устанавливаем сразу без анимации
    
    document.getElementById('loginForm').style.display='block';
    document.getElementById('registerForm').style.display='none';
    document.getElementById('logoutModal').style.display='none';
    document.getElementById('loginContent').style.display='block';
    document.getElementById('stepId').style.display='flex';
    document.getElementById('stepPin').style.display='none';
    document.getElementById('loginTransitionLoader').style.display='none';
    document.getElementById('loginToRegisterLoader').style.display='none';
    document.getElementById('loginLoader').style.display='none';
    document.getElementById('loginSuccess').style.display='none';
    document.getElementById('loginButtons').style.display='flex';
    document.getElementById('loginId').value='';
    ['loginPin1','loginPin2','loginPin3','loginPin4'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('loginId').classList.remove('error');
    loginIdChecked=false;
    document.getElementById('authOverlay').classList.add('active');
    setTimeout(()=>document.getElementById('loginId').focus(),300);
}

function showRegister() {
    document.getElementById('loginContent').style.display='none';
    document.getElementById('loginToRegisterLoader').style.display='flex';
    
    // Начинаем изменять размер во время показа лоадера
    setTimeout(() => {
        setModalWidth(REG_WIDTH);
    }, 100);
    
    setTimeout(()=>{
        document.getElementById('loginForm').style.display='none';
        document.getElementById('registerForm').style.display='block';
        document.getElementById('logoutModal').style.display='none';
        const newId = users.length>0 ? Math.max(...users.map(u=>u.id))+1 : 1001;
        document.getElementById('newUserId').textContent = newId.toString().padStart(4,'0');
        document.getElementById('registerContent').style.display='block';
        ['pin1','pin2','pin3','pin4'].forEach(id=>document.getElementById(id).value='');
        document.getElementById('termsCheckbox').checked=false;
        document.getElementById('registerBtn').disabled=true;
        document.getElementById('registerLoader').style.display='none';
        document.getElementById('registerSuccess').style.display='none';
        document.getElementById('registerButtons').style.display='flex';
        document.getElementById('loginToRegisterLoader').style.display='none';
    }, 800);
}

function showLogout() {
    setModalWidth('320px');
    document.getElementById('loginForm').style.display='none';
    document.getElementById('registerForm').style.display='none';
    document.getElementById('logoutModal').style.display='block';
    document.getElementById('authOverlay').classList.add('active');
}

function closeAuth() { 
    document.getElementById('authOverlay').classList.remove('active'); 
}

function confirmLogout() {
    currentUser=null;
    document.getElementById('headerLoginBtn').textContent='Вход в сеть';
    closeAuth();
}

// ── Login ID check ──
let loginIdChecked=false;
function checkLoginId() {
    const input=document.getElementById('loginId');
    if(input.value.length>4) input.value=input.value.slice(0,4);
    const val=input.value.trim();
    if(val===''){input.classList.remove('error');return;}
    input.classList.remove('error');
    if(val.length===4&&!loginIdChecked){
        const id=parseInt(val);
        const exists=users.find(u=>u.id===id);
        if(exists){
            loginIdChecked=true;
            document.getElementById('stepId').style.display='none';
            document.getElementById('loginTransitionLoader').style.display='block';
            setTimeout(()=>{
                document.getElementById('loginTransitionLoader').style.display='none';
                document.getElementById('stepPin').style.display='flex';
                setTimeout(()=>document.getElementById('loginPin1').focus(),100);
            },800);
        } else { input.classList.add('error'); }
    }
}
(function(){
    const el=document.getElementById('loginId');
    el.addEventListener('input',checkLoginId);
    el.addEventListener('keyup',checkLoginId);
    el.addEventListener('input',function(){if(this.value.trim().length<4)loginIdChecked=false;});
})();

// ── Login PIN ──
const loginPinInputs=['loginPin1','loginPin2','loginPin3','loginPin4'];
loginPinInputs.forEach((id,index)=>{
    const input=document.getElementById(id);
    input.addEventListener('input',function(){
        loginPinInputs.forEach(p=>document.getElementById(p).classList.remove('error'));
        if(this.value.length>1)this.value=this.value.slice(0,1);
        if(this.value.length===1&&index<loginPinInputs.length-1)
            document.getElementById(loginPinInputs[index+1]).focus();
        const allFilled=loginPinInputs.every(p=>document.getElementById(p).value.length===1);
        if(allFilled){
            const pin=loginPinInputs.map(p=>document.getElementById(p).value).join('');
            const uid=parseInt(document.getElementById('loginId').value);
            const user=users.find(u=>u.id===uid&&u.pin===pin);
            if(user){
                document.getElementById('loginContent').style.display='none';
                document.getElementById('loginLoader').style.display='flex';
                setTimeout(()=>{
                    document.getElementById('loginLoader').style.display='none';
                    document.getElementById('loginSuccess').style.display='flex';
                    setTimeout(()=>{
                        currentUser=user;closeAuth();
                        document.getElementById('headerLoginBtn').textContent='Звено '+currentUser.id.toString().padStart(4,'0');
                    },1000);
                },2000);
            } else {
                document.getElementById('loginPin1').focus();
                requestAnimationFrame(()=>{loginPinInputs.forEach(p=>document.getElementById(p).classList.add('error'));});
                setTimeout(()=>{
                    loginPinInputs.forEach(p=>{
                        const inp=document.getElementById(p);inp.classList.remove('error');inp.value='';
                    });
                    document.getElementById('loginPin1').focus();
                },500);
            }
        }
    });
    input.addEventListener('keydown',function(e){
        if(e.key==='Backspace'&&this.value===''&&index>0)
            document.getElementById(loginPinInputs[index-1]).focus();
    });
});

// ── Register PIN ──
const pinInputs=['pin1','pin2','pin3','pin4'];
pinInputs.forEach((id,index)=>{
    const input=document.getElementById(id);
    input.addEventListener('input',function(){
        if(this.value.length>1)this.value=this.value.slice(0,1);
        if(this.value.length===1&&index<pinInputs.length-1)
            document.getElementById(pinInputs[index+1]).focus();
        checkRegisterButton();
    });
    input.addEventListener('keydown',function(e){
        if(e.key==='Backspace'&&this.value===''&&index>0)
            document.getElementById(pinInputs[index-1]).focus();
    });
});
document.getElementById('termsCheckbox').addEventListener('change',checkRegisterButton);

function checkRegisterButton(){
    const allFilled=pinInputs.every(id=>document.getElementById(id).value.length===1);
    document.getElementById('registerBtn').disabled=!(allFilled&&document.getElementById('termsCheckbox').checked);
}

function register(){
    const pin=pinInputs.map(id=>document.getElementById(id).value).join('');
    const userId=parseInt(document.getElementById('newUserId').textContent);
    if(pin.length!==4||!document.getElementById('termsCheckbox').checked)return;
    
    document.getElementById('registerContent').style.display='none';
    document.getElementById('registerLoader').style.display='flex';
    
    // Начинаем изменять размер во время показа лоадера
    setTimeout(() => {
        setModalWidth(SUCCESS_WIDTH);
    }, 100);
    
    setTimeout(()=>{
        const newUser={id:userId,pin,createdAt:new Date().toISOString()};
        users.push(newUser);currentUser=newUser;
        document.getElementById('registerLoader').style.display='none';
        document.getElementById('registerSuccess').style.display='flex';
        document.getElementById('registerSuccess').querySelector('.success-text').innerHTML=
            `Подключение выполнено, присоединилось новое звено #${userId.toString().padStart(4,'0')}`;
        setTimeout(()=>{
            closeAuth();
            document.getElementById('headerLoginBtn').textContent='Звено '+currentUser.id.toString().padStart(4,'0');
        },2500);
    },2000);
}

// ============================================================
// BROWSER TABS (Materials / Workouts / Progress)
// ============================================================
const TAB_DEFAULTS={
    materials:'https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/d252d71940705d10f712f6c0926dc19d2b4b9c59/default_material.svg',
    workouts:'https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/d252d71940705d10f712f6c0926dc19d2b4b9c59/default_workout.svg',
    progress:'https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/main/DNATR.json'
};
const tabData={
    materials:[
        {title:'Основы правильного питания',desc:'Гайд по макронутриентам и калориям',icon:TAB_DEFAULTS.materials},
        {title:'Техника выполнения упражнений',desc:'Видео-уроки от профессионалов',icon:TAB_DEFAULTS.materials},
        {title:'Программы тренировок',desc:'Готовые планы на разные цели',icon:TAB_DEFAULTS.materials},
        {title:'Восстановление и стретчинг',desc:'Упражнения для гибкости и релаксации',icon:TAB_DEFAULTS.materials}
    ],
    workouts:[
        {title:'Силовая тренировка — День 1',desc:'Грудь и трицепс · 45 минут',icon:TAB_DEFAULTS.workouts},
        {title:'Кардио тренировка',desc:'HIIT интервалы · 30 минут',icon:TAB_DEFAULTS.workouts},
        {title:'Силовая тренировка — День 2',desc:'Спина и бицепс · 50 минут',icon:TAB_DEFAULTS.workouts},
        {title:'День ног',desc:'Квадрицепсы, бицепсы бедра · 60 минут',icon:TAB_DEFAULTS.workouts}
    ]
};
function renderItemList(items){
    return '<div class="materials-list">'+items.map(item=>
        `<div class="material-item">
            <div class="material-icon"><img class="icon-gray" src="${item.icon}" alt=""></div>
            <div class="material-info"><h3>${item.title}</h3><p>${item.desc}</p></div>
         </div>`
    ).join('')+'</div>';
}
function renderProgress(){
    const html = `<div class="empty-state">
        <div class="empty-state-icon" id="lottie-progress" style="width:234px;height:234px;margin:0 auto;"></div>
        <h3>Прогресс и достижения</h3>
        <p>Здесь София будет добавлять ваши достижения и записи по мере успеха в тренировках. Начните тренироваться, чтобы увидеть свой путь к прогрессу!</p>
    </div>`;
    setTimeout(async () => {
        const container = document.getElementById('lottie-progress');
        if(container && !container.hasAnimation) {
            try {
                const response = await fetch(TAB_DEFAULTS.progress);
                let data = await response.json();
                
                // Замена темного цвета на цвет фона браузера (0.11, 0.11, 0.11 = #1c1c1c)
                const replaceColors = (obj) => {
                    if (Array.isArray(obj)) {
                        return obj.map((item) => {
                            if (Array.isArray(item) && item.length === 4 && typeof item[0] === 'number') {
                                // Если это полностью черный или очень темный цвет, заменяем на цвет фона вкладки
                                if ((item[0] === 0 && item[1] === 0 && item[2] === 0) ||
                                    (item[0] < 0.1 && item[1] < 0.1 && item[2] < 0.1)) {
                                    return [0.11, 0.11, 0.11, item[3]];
                                }
                            }
                            return replaceColors(item);
                        });
                    } else if (obj !== null && typeof obj === 'object') {
                        const result = {};
                        for (let key in obj) {
                            result[key] = replaceColors(obj[key]);
                        }
                        return result;
                    }
                    return obj;
                };
                
                data = replaceColors(data);
                
                lottie.loadAnimation({
                    container: container,
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    animationData: data
                });
                container.hasAnimation = true;
            } catch(e) {
                console.error('Error loading animation:', e);
            }
        }
    }, 100);
    return html;
}
function getTabHTML(key){ return key==='progress'?renderProgress():renderItemList(tabData[key]); }

// Initialize UI after DOM is ready
// Attach click handlers to material items based on tab type
function attachMaterialClickHandlers(tabType) {
    const items = document.querySelectorAll('.material-item');
    items.forEach(item => {
        // avoid adding duplicate listeners
        if (item.dataset.pdfBound) return;
        item.dataset.pdfBound = '1';
        item.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const pdfType = tabType === 'materials' ? 'materials' : 'workouts';
            const pdfUrl = PDF_URLS[pdfType];
            const win = window.open(pdfUrl, '_blank', 'noopener,noreferrer');
            if (!win) {
                // popup blocked — navigate current tab as fallback
                window.location.href = pdfUrl;
            }
        });
    });
}

function initUI() {
    const innerTabs=document.querySelectorAll('.inner-tab');
    const mainContent=document.getElementById('main-content');
    mainContent.innerHTML=getTabHTML('materials');
    setTimeout(()=>attachMaterialClickHandlers('materials'), 0);

    innerTabs.forEach(tab=>{
        tab.addEventListener('click',()=>{
            if (tab.classList.contains('active')) return;
            innerTabs.forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            mainContent.style.opacity='0';
            setTimeout(()=>{
                mainContent.innerHTML=getTabHTML(tab.dataset.inner);
                mainContent.style.opacity='1';
                attachMaterialClickHandlers(tab.dataset.inner);
            },150);
        });
    });
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initUI);
} else {
    initUI();
}

// ============================================================
// CHAT TABS
// ============================================================
// CHAT TABS
// ============================================================
let chatTabCounter = 1;
let activeChatTab  = 'sofia';
const chatStore    = { sofia: [] };
let openMenu       = null;
let pinnedChats    = new Set();

function createChatTabElement(id, name, isBase) {
    const tab = document.createElement('button');
    tab.className = 'chat-tab';
    tab.dataset.chat = id;
    if (isBase) tab.dataset.base = 'true';

    const nameSpan = document.createElement('span');
    nameSpan.textContent = name;
    tab.appendChild(nameSpan);

    // Создаем меню только для НЕ базовых вкладок
    if (!isBase) {
    // Обработчик клика для показа меню
    tab.addEventListener('click', (e) => {
        const wasActive = tab.classList.contains('active');
        
        if (!wasActive) {
            // Если вкладка НЕ активна - просто переключаемся
            switchChatTab(id);
            closeAllMenus();
        } else {
            // Если вкладка УЖЕ активна - показываем меню
            e.stopPropagation();
            toggleTabMenu(tab, id, nameSpan);
        }
    });
} else {
    // Для базовой вкладки просто переключаем чат
    tab.addEventListener('click', () => {
        switchChatTab(id);
        closeAllMenus();
    });
}

    return tab;
}

// Новая функция для создания и позиционирования меню
function toggleTabMenu(tab, id, nameSpan) {
    closeAllMenus();
    
    const menu = document.createElement('div');
    menu.className = 'chat-tab-menu show';
    menu.dataset.chatId = id;
    
    // ИЗМЕНИТЬ структуру меню - добавить текст к кнопкам
    menu.innerHTML =
    `<button class="chat-tab-menu-item" data-action="pin">
        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/45e14291c38b1dac85196a754e13e9d0da4a01cf/pin.svg" alt="">
    </button>` +
    `<button class="chat-tab-menu-item" data-action="rename">
        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/45e14291c38b1dac85196a754e13e9d0da4a01cf/rename.svg" alt="">
    </button>` +
    `<button class="chat-tab-menu-item" data-action="delete">
        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/45e14291c38b1dac85196a754e13e9d0da4a01cf/delete.svg" alt="">
    </button>`;
    
    document.body.appendChild(menu);
    
    // ИЗМЕНИТЬ позиционирование - справа от вкладки
    const rect = tab.getBoundingClientRect();
menu.style.position = 'fixed';
menu.style.left = rect.left + 'px';
menu.style.top = rect.bottom + 6 + 'px';
menu.style.transform = 'none';
    
    menu.querySelectorAll('.chat-tab-menu-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const action = btn.dataset.action;
            if (action === 'pin')    togglePinChat(id, tab);
            if (action === 'rename') showRenameInput(tab, id, nameSpan);
            if (action === 'delete') deleteChatTab(id);
            if (action !== 'rename') closeAllMenus(); // ИЗМЕНИТЬ - не закрывать при переименовании
        });
    });
    
    openMenu = menu;
}

    function showRenameInput(tab, id, nameSpan) {
    closeAllMenus(); // Закрываем меню
    
    const wrap = document.createElement('div');
    wrap.className = 'rename-input-wrap show';
    wrap.dataset.chatId = id;
    
    wrap.innerHTML = `
        <input type="text" class="rename-input" value="${nameSpan.textContent}" id="renameInput-${id}">
        <div class="rename-buttons">
            <button class="rename-btn" data-action="cancel">Отмена</button>
            <button class="rename-btn" data-action="save">Сохранить</button>
        </div>
    `;
    
    document.body.appendChild(wrap);
    
   const rect = tab.getBoundingClientRect();
wrap.style.left = rect.left + 'px';
wrap.style.top = rect.bottom + 6 + 'px';
    
    const input = wrap.querySelector('.rename-input');
    input.focus();
    input.select();
    
    wrap.querySelector('[data-action="cancel"]').addEventListener('click', () => {
        wrap.remove();
    });
    
    wrap.querySelector('[data-action="save"]').addEventListener('click', () => {
        const newName = input.value.trim();
        if (newName && newName !== nameSpan.textContent) {
            nameSpan.textContent = newName;
        }
        wrap.remove();
    });
    
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const newName = input.value.trim();
            if (newName && newName !== nameSpan.textContent) {
                nameSpan.textContent = newName;
            }
            wrap.remove();
        }
    });
}
    
function closeAllMenus() {
    document.querySelectorAll('.chat-tab-menu').forEach(m => m.remove());
    document.querySelectorAll('.rename-input-wrap').forEach(w => w.remove()); // ДОБАВИТЬ
    openMenu = null;
}

document.addEventListener('click', (e) => {
    if (!e.target.closest('.chat-tab-menu') && !e.target.closest('.chat-tab')) closeAllMenus();
});

function togglePinChat(id, tabElement) {
    const chatTabs = document.getElementById('chatTabs');
    const sofiaTab = document.querySelector('.chat-tab[data-base="true"]');
    
    if (pinnedChats.has(id)) {
        // ОТКРЕПЛЕНИЕ
        pinnedChats.delete(id);
        tabElement.classList.remove('pinned');
        console.log(`Чат ${id} откреплен`);
        
        // Находим последний закреплённый чат
        const allTabs = Array.from(chatTabs.querySelectorAll('.chat-tab'));
        const pinnedTabs = allTabs.filter(t => t.classList.contains('pinned'));
        
        if (pinnedTabs.length > 0) {
            // Если есть закреплённые - ставим после последнего закреплённого
            const lastPinned = pinnedTabs[pinnedTabs.length - 1];
            lastPinned.after(tabElement);
        } else {
            // Если закреплённых нет - ставим после Sofia
            sofiaTab.after(tabElement);
        }
        
    } else {
        // ЗАКРЕПЛЕНИЕ
        pinnedChats.add(id);
        tabElement.classList.add('pinned');
        console.log(`Чат ${id} закреплен`);
        
        // Перемещаем вкладку после Sofia
        if (sofiaTab && tabElement) {
            sofiaTab.after(tabElement);
        }
    }
}

function addChatTab(){
    const id = 'chat' + chatTabCounter++;
    chatStore[id] = [];
    const tab = createChatTabElement(id, 'Чат ' + (chatTabCounter - 1), false);
    document.getElementById('chatTabs').appendChild(tab);
    switchChatTab(id);
    updateChatScrollFade();
}

function deleteChatTab(id) {
    const tab = document.querySelector(`.chat-tab[data-chat="${id}"]`);
    if (tab && !tab.dataset.base) {
        tab.remove();
        delete chatStore[id];
        pinnedChats.delete(id);
        if (activeChatTab === id) switchChatTab('sofia');
        updateChatScrollFade();
    }
}

 
function switchChatTab(id){
    activeChatTab = id;
    document.querySelectorAll('.chat-tab').forEach(t => t.classList.toggle('active', t.dataset.chat===id));
    renderChatMessages();
}

function updateChatScrollFade(){
    const wrapper = document.getElementById('chatTabsWrapper');
    const tabs    = document.getElementById('chatTabs');
    const scrollable = tabs.scrollWidth > tabs.clientWidth;
    const atStart    = tabs.scrollLeft <= 1;
    const atEnd      = tabs.scrollLeft + tabs.clientWidth >= tabs.scrollWidth - 1;
    
    wrapper.classList.remove('blur-left', 'blur-right', 'blur-both');
    
    if (scrollable && !atStart && atEnd) {
        wrapper.classList.add('blur-left');
    } else if (scrollable && atStart && !atEnd) {
        wrapper.classList.add('blur-right');
    } else if (scrollable && !atStart && !atEnd) {
        wrapper.classList.add('blur-both');
    }
}

document.getElementById('chatTabs').addEventListener('scroll', () => {
    updateChatScrollFade();
    closeAllMenus(); // ДОБАВИТЬ
});

function toggleChatSearch(){
    const wrap = document.getElementById('chatSearchWrap');
    wrap.classList.toggle('open');
    if (wrap.classList.contains('open')) document.getElementById('chatSearchInput').focus();
}

document.getElementById('chatSearchInput').addEventListener('input', function(){
    const q = this.value.toLowerCase();
    document.querySelectorAll('.chat-tab').forEach(tab => {
        const span = tab.querySelector('span');
        const name = span ? span.textContent.toLowerCase() : '';
        tab.style.display = name.includes(q) ? '' : 'none';
    });
});

document.addEventListener('click', (e) => {
    // Закрытие меню
    if (!e.target.closest('.chat-tab-menu') && 
        !e.target.closest('.chat-tab') && 
        !e.target.closest('.rename-input-wrap')) { // ДОБАВИТЬ
        closeAllMenus();
    }
    
    // Закрытие поиска (оставь как есть)
    const wrap = document.getElementById('chatSearchWrap');
    const btn  = document.querySelector('.chat-search-btn');
    if (!wrap.contains(e.target) && !btn.contains(e.target)) {
        wrap.classList.remove('open');
    }
});

function renderChatMessages(){
    const container = document.getElementById('chat-messages');
    const messages  = chatStore[activeChatTab] || [];
    
    // Приветствие только для Sofia
    if (messages.length === 0 && activeChatTab === 'sofia') {
        container.innerHTML = `<div class="chat-empty-state">
            <div class="sofia-icon" id="lottie-chat-sofia" style="width:90px;height:90px;margin:0 auto;"></div>
            <p>Привет, меня зовут София, я создана инженерами проекта MSE. Я смотрю как ты тренируешься, как питаешься и помогаю прогрессировать. Я никогда не сплю.</p>
        </div>`;
        
        // Загружаем Lottie анимацию для Sofia
        setTimeout(async () => {
            const lottieContainer = document.getElementById('lottie-chat-sofia');
            if(lottieContainer && !lottieContainer.hasAnimation) {
                try {
                    const response = await fetch('https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/main/Eye%20Loading%20Animation.json');
                    let data = await response.json();
                    
                    // Замена белых и светлых цветов на серый (#797979)
                    const replaceColors = (obj) => {
                        if (Array.isArray(obj)) {
                            return obj.map((item) => {
                                if (Array.isArray(item) && item.length === 4 && typeof item[0] === 'number') {
                                    // Замена белого и светлых цветов на #797979 (0.474, 0.474, 0.474)
                                    if ((item[0] > 0.8 && item[1] > 0.8 && item[2] > 0.8) ||
                                        (item[0] === 1 && item[1] === 1 && item[2] === 1)) {
                                        return [0.474, 0.474, 0.474, item[3]];
                                    }
                                }
                                return replaceColors(item);
                            });
                        } else if (obj !== null && typeof obj === 'object') {
                            const result = {};
                            for (let key in obj) {
                                result[key] = replaceColors(obj[key]);
                            }
                            return result;
                        }
                        return obj;
                    };
                    
                    data = replaceColors(data);
                    
                    const animation = lottie.loadAnimation({
                        container: lottieContainer,
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        animationData: data
                    });
                    animation.setSpeed(0.5);
                    lottieContainer.hasAnimation = true;
                } catch(e) {
                    console.error('Error loading chat animation:', e);
                }
            }
        }, 100);
    } else if (messages.length === 0) {
        // Для других чатов - приветствие
        container.innerHTML = `<div class="chat-empty-state">
            <div class="sofia-icon"><img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/d252d71940705d10f712f6c0926dc19d2b4b9c59/default_material.svg" alt=""></div>
            <p>Это новый чат. Напишите сообщение или прикрепите файл, чтобы начать диалог.</p>
        </div>`;
        } else {
        container.innerHTML = messages.map(m => {
            if (m.type === 'image') {
                // Картинка
                return `<div class="chat-message ${m.role}">
                    <img class="chat-message-image" src="${m.src}" alt="${m.name}" onclick="openImageModal('${m.src}')">
                </div>`;
            } else if (m.type === 'file') {
                // Файл — если сообщение содержит только файл (нет текста), убираем верхнюю разделительную полосу
                const noSepClass = (typeof m.text === 'undefined' || m.text === null || m.text === '') ? ' no-sep' : '';
                return `<div class="chat-message ${m.role}">
                    <div class="chat-message-attachment${noSepClass}">
                        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/d252d71940705d10f712f6c0926dc19d2b4b9c59/default_material.svg" alt="">
                        <span>${m.name}</span>
                    </div>
                </div>`;
            } else {
                // Обычное текстовое сообщение
                return `<div class="chat-message ${m.role}">${m.text}</div>`;
            }
        }).join('');
        container.scrollTop = container.scrollHeight;
    }
}
renderChatMessages();

const chatInput = document.getElementById('chat-input');
const chatSend  = document.getElementById('chat-send');

function sendMessage(){
    const text = chatInput.value.trim();
    const hasFiles = attachedFiles.length > 0;
    
    if (!text && !hasFiles) return;
    
    if (!chatStore[activeChatTab]) chatStore[activeChatTab] = [];
    
    // Отправляем текст как отдельное сообщение (если есть)
    if (text) {
        chatStore[activeChatTab].push({role:'user', text: text});
    }
    
    // Отправляем каждый файл как отдельное сообщение
    // If multiple attachments include at least one image, treat all attachments as files (no previews)
    const treatAllAsFiles = attachedFiles.length > 1 && attachedFiles.some(f => f.type && f.type.startsWith('image/'));

    attachedFiles.forEach(file => {
        const isImage = file.type && file.type.startsWith('image/');
        
        if (isImage && !treatAllAsFiles) {
            // For single image attachments we create a data URL preview
            const reader = new FileReader();
            reader.onload = function(e) {
                chatStore[activeChatTab].push({
                    role:'user', 
                    type:'image',
                    src: e.target.result,
                    name: file.name || 'Изображение'
                });
                renderChatMessages();
            };
            reader.readAsDataURL(file);
        } else {
            // Treat as generic file (no preview)
            const ext = file.name ? file.name.split('.').pop() : 'file';
            chatStore[activeChatTab].push({
                role:'user',
                type:'file',
                name: file.name || `attach.${ext}`
            });
        }
    });
    
    chatInput.value = '';
    attachedFiles = [];
    renderFilePreview();
    renderChatMessages();
    
    setTimeout(() => {
        chatStore[activeChatTab].push({role:'ai', text:'Спасибо за вопрос! Это демо-версия чата. Функционал Софии будет доработан позже.'});
        renderChatMessages();
    }, 800);
}

chatSend.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', e => { if (e.key==='Enter') sendMessage(); });
    document.addEventListener('DOMContentLoaded', () => {
    const sofiaTab = document.querySelector('.chat-tab[data-base="true"]');
    if (sofiaTab && !sofiaTab.hasAttribute('data-listener')) {
        sofiaTab.addEventListener('click', () => {
            switchChatTab('sofia');
            closeAllMenus();
        });
        sofiaTab.setAttribute('data-listener', 'true');
    }
});
// ============================================================
// FILE ATTACHMENTS
// ============================================================
let attachedFiles = [];

// Кнопка прикрепления
document.getElementById('chat-attach').addEventListener('click', () => {
    document.getElementById('chat-file-input').click();
});

// Выбор файлов через input
document.getElementById('chat-file-input').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    files.forEach(file => {
        attachedFiles.push(file);
    });
    renderFilePreview();
    e.target.value = ''; // Очищаем input для повторного выбора
});

// Вставка из буфера обмена
document.getElementById('chat-input').addEventListener('paste', function(e) {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            const blob = items[i].getAsFile();
            attachedFiles.push(blob);
            renderFilePreview();
            e.preventDefault();
        }
    }
});

function renderFilePreview() {
    const container = document.getElementById('chat-file-preview');
    if (attachedFiles.length === 0) {
        container.innerHTML = '';
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'flex';
    container.innerHTML = attachedFiles.map((file, index) => `
        <div class="chat-file-item">
            <img class="file-icon icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/d252d71940705d10f712f6c0926dc19d2b4b9c59/default_material.svg" alt="">
            <span>${file.name || 'Изображение'}</span>
            <img class="file-remove icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/45e14291c38b1dac85196a754e13e9d0da4a01cf/delete.svg" alt="" onclick="removeFile(${index})">
        </div>
    `).join('');
}

// Удаление файла
function removeFile(index) {
    attachedFiles.splice(index, 1);
    renderFilePreview();
}
// ============================================================
// IMAGE MODAL
// ============================================================
function openImageModal(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').classList.add('show');
}

document.getElementById('imageModal').addEventListener('click', function(e) {
    if (e.target === this || e.target.id === 'modalImage') {
        this.classList.remove('show');
    }
});
// PDF modal functions
var PDF_URLS = {
    materials: 'https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/main/MSE%20Cardio%20Anatomy.pdf',
    workouts: 'https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/main/MSE%20Workout.pdf'
};
var currentPDFUrl = '';
var currentPDFBlob = null;
var currentPDFBlobUrl = null;

window.openPDFModal = async function(type) {
    const pdfUrl = PDF_URLS[type];
    currentPDFUrl = pdfUrl;
    const viewer = document.getElementById('pdfModalViewer');
    const overlay = document.getElementById('pdfModalOverlay');
    viewer.innerHTML = '<div style="padding:20px;text-align:center;color:#333">Загрузка документа…</div>';
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';

    try {
        const resp = await fetch(pdfUrl, { mode: 'cors', headers: { 'Accept': 'application/pdf' } });
        if (!resp.ok) throw new Error('Network error: ' + resp.status + ' ' + resp.statusText);
        const blob = await resp.blob();

        // cleanup previous blob url
        if (currentPDFBlobUrl) { URL.revokeObjectURL(currentPDFBlobUrl); currentPDFBlobUrl = null; currentPDFBlob = null; }

        currentPDFBlob = blob;
        currentPDFBlobUrl = URL.createObjectURL(blob);

        // Prefer <object> embedding for broader compatibility; fallback to iframe inside
        viewer.innerHTML = `<object id="pdfObject" data="${currentPDFBlobUrl}#toolbar=0&navpanes=0" type="application/pdf" width="100%" height="100%">` +
            `<iframe id="pdfIframe" src="${currentPDFBlobUrl}#toolbar=0&navpanes=0" style="width:100%;height:100%;border:none"></iframe>` +
            `</object>`;

        // Detect whether embedding actually rendered; if not, surface a clear fallback
        const obj = viewer.querySelector('#pdfObject');
        const ifr = viewer.querySelector('#pdfIframe');
        let loaded = false;

        const onSuccess = () => {
            loaded = true;
        };
        const onFail = () => {
            if (loaded) return;
            // show friendly fallback UI inside viewer (keeps download button below)
            viewer.innerHTML = `<div style="padding:22px;text-align:center;color:#333;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;height:100%">` +
                `<div>Просмотр в модалке недоступен в этом браузере. Откройте файл в новой вкладке или скачайте.</div>` +
                `<div style="width:220px"><button id="openNewTabBtn" style="width:100%;padding:10px;border-radius:6px;border:1px solid rgba(0,0,0,.08);background:#666;color:#fff;cursor:pointer">Открыть в новой вкладке</button></div>` +
                `</div>`;
            const btn = document.getElementById('openNewTabBtn');
            if (btn) btn.addEventListener('click', () => { window.open(currentPDFBlobUrl, '_blank', 'noopener'); });
        };

        try {
            if (obj) obj.addEventListener('load', onSuccess);
            if (ifr) ifr.addEventListener('load', onSuccess);
        } catch (e) { /* ignore */ }

        // If neither loads within 1s, assume embed failed (common with local file origins)
        setTimeout(() => { if (!loaded) onFail(); }, 1000);
    } catch (err) {
        console.error('PDF load error', err);
        viewer.innerHTML = `<div style="padding:20px;color:#333">Не удалось загрузить PDF: ${err.message}. ` +
            `<a href="${pdfUrl}" target="_blank" rel="noreferrer">Открыть в новой вкладке</a></div>`;
    }
};

window.closePDFModal = function() {
    const overlay = document.getElementById('pdfModalOverlay');
    overlay.classList.remove('show');
    document.getElementById('pdfModalViewer').innerHTML = '';
    document.body.style.overflow = '';
    if (currentPDFBlobUrl) { URL.revokeObjectURL(currentPDFBlobUrl); currentPDFBlobUrl = null; currentPDFBlob = null; }
    currentPDFUrl = '';
};

window.downloadPDF = function() {
    // Prefer downloading the fetched blob if available
    if (currentPDFBlob) {
        const a = document.createElement('a');
        const blobUrl = URL.createObjectURL(currentPDFBlob);
        a.href = blobUrl;
        try {
            const parts = currentPDFUrl.split('/');
            const name = decodeURIComponent(parts[parts.length-1].split('?')[0]);
            a.download = name || 'document.pdf';
        } catch (e) { a.download = 'document.pdf'; }
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(blobUrl);
        return;
    }

    // Fallback to direct link
    if (!currentPDFUrl) return;
    const a = document.createElement('a');
    a.href = currentPDFUrl;
    try {
        const parts = currentPDFUrl.split('/');
        const name = decodeURIComponent(parts[parts.length-1].split('?')[0]);
        a.download = name || 'document.pdf';
    } catch (e) { a.download = 'document.pdf'; }
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
};

document.getElementById('pdfModalOverlay').addEventListener('click', function(e){ if (e.target===this) closePDFModal(); });

// Модифицировать функцию sendMessage
// Модифицировать функцию sendMessage
</script>
</body>
</html>
