<!DOCTYPE html>
<html lang="ru">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mixed Sport Elements</title>
    <link rel="icon" type="image/svg+xml" href="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/d3167612dcfc7a419e5df239ce7ef69b3c728ba6/MSESVG.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    
    <!-- Firebase SDK (v10 modular) -->
    <script type="module">
        // Firebase configuration and initialization
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAC8pTGZB2toqkCf_I55V6O0WMCdYF8FtI",
            authDomain: "mse-base.firebaseapp.com",
            projectId: "mse-base",
            storageBucket: "mse-base.firebasestorage.app",
            messagingSenderId: "686311511188",
            appId: "1:686311511188:web:04d99e5fb815ae444d9081"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseCollection = collection;
        window.firebaseServerTimestamp = serverTimestamp;
        
        console.log('Firebase initialized successfully!');
    </script>
    
    <style>  
        * { margin:0; padding:0; box-sizing:border-box; }
        :root { 
            --bg-primary:#000;
            --glass-bg:rgba(255,255,255,.05); 
            --glass-border:rgba(255,255,255,.1);
            --text-primary:#999;
            --text-secondary:#888;
            --text-tertiary:#666;
            --block-height:500px;
        }



/* ─── CHAT TAB DROPDOWN MENU ─── */
/* ─── CHAT TAB DROPDOWN MENU ─── */
/* ─── CHAT TAB DROPDOWN MENU ─── */
.chat-tab-menu {
    position:fixed;
    background:rgba(20,20,20,.95);
    border:1px solid var(--glass-border);
    border-radius:6px;
    padding:5px;
    display:none;
    flex-direction:column; /* ИЗМЕНИТЬ с row на column */
    gap:2px;
    z-index:500;
    backdrop-filter:blur(12px);
}
.chat-tab-menu.show { display:flex; }
.chat-tab-menu-item {
    width:34px;height:34px;
    background:transparent;
    border:none;
    border-radius:4px;
    cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    padding:0;
    transition:background .15s ease;
}
.chat-tab-menu-item:hover { background:rgba(255,255,255,.1); }
.chat-tab-menu-item img { width:14px;height:14px;opacity:.7; }
.chat-tab-menu-item span { /* ДОБАВИТЬ для текста */
    font-size:12px;
    color:var(--text-secondary);
    font-family:'Inter',sans-serif;
}

/* ДОБАВИТЬ стили для поля переименования */
.rename-input-wrap {
    position:fixed;
    background:rgba(20,20,20,.95);
    border:1px solid var(--glass-border);
    border-radius:6px;
    padding:8px;
    z-index:501;
    backdrop-filter:blur(12px);
    display:none;
}
.rename-input-wrap.show { display:block; }
.rename-input {
    width:180px;
    height:32px;
    padding:0 10px;
    background:rgba(255,255,255,.05);
    border:1px solid var(--glass-border);
    border-radius:4px;
    color:var(--text-primary);
    font-family:'Inter',sans-serif;
    font-size:12px;
}
.rename-input:focus {
    outline:none;
    background:rgba(255,255,255,.08);
    border-color:rgba(255,255,255,.2);
}
.rename-buttons {
    display:flex;
    gap:4px;
    margin-top:6px;
}
.rename-btn {
    flex:1;
    height:28px;
    background:rgba(255,255,255,.1);
    border:1px solid var(--glass-border);
    border-radius:4px;
    color:var(--text-primary);
    font-family:'Inter',sans-serif;
    font-size:11px;
    cursor:pointer;
    transition:all .15s ease;
}
.rename-btn:hover { background:rgba(255,255,255,.15); }
        
        body {
            font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
            background:var(--bg-primary);color:var(--text-primary);
            overflow-x:hidden;min-height:100vh;
            -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
        }
        .container { max-width:1400px;margin:0 auto;padding:0 20px; }
        .icon-gray { filter:invert(60%) sepia(0%) saturate(0%) brightness(100%) contrast(100%); }

        /* ─── HEADER ─── */
      header {
    position:sticky;
    top:0;
    z-index:100;
    padding:0;  /* УБРАТЬ верхний padding */
    background:transparent;
}
.header-inner {
    max-width:100%;
    margin:0 auto;
    padding:12px 20px;
    backdrop-filter:saturate(180%) blur(20px);
    background:var(--glass-bg);           /* ИЗМЕНИТЬ с red */
    border:1px solid var(--glass-border);
    border-top:none; /* ДОБАВИТЬ - убирает верхнюю линию */
    border-radius:0 0 8px 8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:20px;
}
.logo { 
    width:128px;
    height:32px;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-shrink:0;
}
       
.logo img { 
    width:100px;
    height:32px;
}

        
.header-login-btn {
    width:34px;
    height:34px;
    background:transparent;
    border:1px solid var(--glass-border);
    border-radius:4px;
    color:var(--text-primary);
    cursor:pointer;
    transition:all .15s ease;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-shrink:0;
}
        .header-login-btn:hover { background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.2); }
        .header-login-btn img { width:14px; height:14px; }

        /* ─── INNER TABS ─── */
        .inner-tabs { display:flex;gap:8px;margin-bottom:16px;flex-shrink:0;align-items:center; }
        .inner-tab {
            padding:8px 14px;background:transparent;border:1px solid var(--text-secondary);
            border-radius:6px;color:var(--text-secondary);cursor:pointer;font-family:'Inter',sans-serif;
            font-size:12px;font-weight:500;transition:all .2s ease;display:flex;align-items:center;gap:6px;
            height:34px;
        }
        .inner-tab-icon { width:14px;height:14px; }
        .inner-tab.active { background:var(--text-secondary);color:var(--bg-primary);border-color:var(--text-secondary); }
        .inner-tab.active .inner-tab-icon { filter:invert(0%) sepia(0%) saturate(0%) brightness(0%) contrast(100%); }
        .inner-tab:hover:not(.active) { border-color:rgba(255,255,255,.3); }

        /* ─── GRID ─── */
        .main-wrapper { margin-top:20px; }
.content-grid {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    align-items: start;
    position: relative; /* Добавляем для абсолютного позиционирования скрытого модуля */
}

 
       @media(max-width:968px){
    .content-grid { flex-direction: column; } /* ИЗМЕНИТЬ */
}



/* ДОБАВИТЬ новый код */
.chat-tabs-wrapper {
    flex:1;
    min-width:0;
    position:relative;
    overflow:hidden;
    transition: mask-image 0.3s ease; /* ДОБАВИТЬ */
}

.chat-tabs-wrapper.blur-left {
  mask-image: linear-gradient(to right, transparent 0%, black 10%, black 100%);
  -webkit-mask-image: linear-gradient(to right, transparent 0%, black 10%, black 100%);
}

.chat-tabs-wrapper.blur-right {
  mask-image: linear-gradient(to right, black 0%, black 90%, transparent 100%);
  -webkit-mask-image: linear-gradient(to right, black 0%, black 90%, transparent 100%);
}

.chat-tabs-wrapper.blur-both {
  mask-image: linear-gradient(to right, transparent 0%, black 10%, black 90%, transparent 100%);
  -webkit-mask-image: linear-gradient(to right, transparent 0%, black 10%, black 90%, transparent 100%);
}
        

        /* ─── CONTENT BLOCK & MINIMIZE ANIMATION ─── */
.content-grid {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    align-items: start;
}

/* Когда оба свернуты - разносим по краям с пространством между */
.content-grid.both-collapsed {
    justify-content: space-between;
}

.content-block {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 5px;
    backdrop-filter: saturate(180%) blur(20px);
    height: var(--block-height);
    overflow: hidden;
    display: flex;
    flex-direction: row;
    flex: 1 1 0%;
    min-width: 0;
    transition: flex 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

.content-block.collapsed {
    flex: 0 0 54px;
}
        

        /* The actual body content */
.block-body {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    padding: 20px;
    overflow: hidden;
    filter: blur(0px);
    opacity: 1;
    transition: filter 0.8s ease, opacity 0.8s ease;
}

        /* Minimized vertical bar */
.minimized-bar {
    width: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: width 0.35s ease;
    cursor: pointer;
    flex-shrink: 0;
}

.minimized-bar .bar-icon {
    margin-top: 12px;
}

        .btn-minimize {
    width:34px;height:34px;background:transparent;border:1px solid var(--glass-border);
    border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;
    transition:all .15s ease;flex-shrink:0;
}
.btn-minimize:hover { background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.2); }
.btn-minimize img { width:14px;height:14px; }

/* Показываем minimize по умолчанию, maximize скрыт */
.btn-minimize .icon-minimize { display:block; }
.btn-minimize .icon-maximize { display:none; }

/* При сворачивании меняем иконки */
.content-block.minimized .btn-minimize .icon-minimize { display:none; }
.content-block.minimized .btn-minimize .icon-maximize { display:block; }

        .content-body { flex:1;display:flex;flex-direction:column;min-height:0;transition:filter 0.3s ease,opacity 0.3s ease; }

        /* ─── MATERIALS ─── */
        .materials-list { 
            display:grid;
            gap:10px;
            overflow-y:auto;
            max-height:100%;
            scrollbar-width:none;
        }
        .materials-list::-webkit-scrollbar { display:none; }
        .material-item {
            background:rgba(255,255,255,.03);border:1px solid var(--glass-border);border-radius:5px;
            padding:20px 14px;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;gap:12px;
            position:relative;
            overflow:hidden;
            min-height:70px;
        }
        
        /* Shimmer animation for highlighting */
        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }
        
        .material-item.shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(153, 153, 153, 0.3) 50%, 
                transparent 100%);
            animation: shimmer 1s ease-in-out;
        }
        .material-item:hover { background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18); }
        .material-icon {
            width:36px;height:36px;background:rgba(255,255,255,.08);border-radius:5px;
            display:flex;align-items:center;justify-content:center;flex-shrink:0;
        }
        .material-icon img { width:20px;height:20px;opacity:.7; }
        .material-info h3 { font-size:14px;font-weight:500;margin-bottom:4px;letter-spacing:-.2px; }
        .material-info p { font-size:12px;color:var(--text-secondary);letter-spacing:-.1px; }

        /* ─── CHAT PANEL ─── */
        .chat-top-bar {
            display:flex;
            align-items:center;
            gap:8px;
            flex-shrink:0;
            margin-bottom:12px;
            position:relative;
            width:100%;
            overflow:visible;
        }
        .chat-new-btn {
            width:34px;height:34px;background:transparent;border:1px solid var(--glass-border);border-radius:4px;
            color:var(--text-tertiary);font-family:'Inter',sans-serif;font-size:18px;font-weight:400;
            cursor:pointer;white-space:nowrap;transition:all .15s ease;flex-shrink:0;
            display:flex;align-items:center;justify-content:center;
        }
        .chat-new-btn:hover { background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2);color:var(--text-secondary); }

        /* ─── CHAT TABS SLIDER ─── */
        .chat-tabs-wrapper {
            flex:1;
            min-width:0;
            position:relative;
            overflow:hidden;
        }
        
       
      

        .chat-tabs {
            display:flex;gap:6px;
            overflow-x:auto;
            scrollbar-width:none;
            scroll-behavior:smooth;
        }
        .chat-tabs::-webkit-scrollbar { display:none; }

        .chat-tab {
            padding:0 10px;height:34px;background:transparent;border:1px solid var(--glass-border);border-radius:5px;
            color:var(--text-secondary);font-family:'Inter',sans-serif;font-size:11px;font-weight:500;
            cursor:pointer;white-space:nowrap;transition:all .15s ease;
            flex-shrink:0;
            display:flex;align-items:center;justify-content:center;
            position:relative;
        }
        .chat-tab:hover:not(.active) { border-color:rgba(255,255,255,.22); }
        .chat-tab.active { background:var(--text-secondary);color:var(--bg-primary);border-color:var(--text-secondary); }
.chat-tab.pinned {
    border-style:dashed;
    border-color:rgba(255,255,255,.2);
    border-width:2px;
}
.chat-tab.pinned:hover {
    border-color:rgba(255,255,255,.28);
}
         

        .chat-right-controls {
            display:flex;gap:8px;align-items:center;
            flex-shrink:0;
        }
        .chat-search-btn {
            width:34px;height:34px;background:transparent;border:1px solid var(--glass-border);border-radius:4px;
            cursor:pointer;display:flex;align-items:center;justify-content:center;
            transition:all .15s ease;flex-shrink:0;
        }
        .chat-search-btn:hover { background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2); }
        .chat-search-btn svg { width:14px;height:14px;stroke:var(--text-secondary);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round; }

        .chat-search-wrap {
            position:absolute;top:calc(100% + 8px);right:0;width:200px;
            display:none;z-index:50;
        }
        .chat-search-wrap.open { display:block; }
        .chat-search-input {
            width:100%;height:34px;padding:0 12px;background:rgba(30,30,30,.95);
            border:1px solid var(--glass-border);border-radius:5px;color:var(--text-primary);
            font-family:'Inter',sans-serif;font-size:12px;backdrop-filter:blur(10px);
        }
        .chat-search-input:focus { outline:none;border-color:rgba(255,255,255,.2);background:rgba(40,40,40,.95); }
        .chat-search-input::placeholder { color:var(--text-tertiary); }

        .chat-container { display:flex;flex-direction:column;flex:1;min-height:0; }
        .chat-messages { 
            flex:1;
            overflow-y:auto;
            overflow-x:hidden;
            padding:10px 0;
            margin-bottom:12px;
            display:flex;
            flex-direction:column;
            gap:10px;
            transition:filter 0.3s ease,opacity 0.3s ease;
            position: relative;
            scrollbar-width:none;
            word-wrap: break-word;
            word-break: break-word;
        }
        .chat-messages::-webkit-scrollbar { display:none; }
        .chat-message {
            padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid var(--glass-border);
            border-radius:5px;font-size:13px;max-width:85%;line-height:1.5;letter-spacing:-.1px;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .chat-message.ai  { align-self:flex-start; }
        .chat-message.user { align-self:flex-end;background:rgba(255,255,255,.08); }

        .chat-empty-state {
            flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
            text-align:center;padding:20px 10px;gap:16px;pointer-events:none;
        }
        .chat-empty-state .sofia-icon { width:90px;height:90px;opacity:.5; }
        .chat-empty-state .sofia-icon img { width:100%;height:100%;opacity:.7; }
        .chat-empty-state p { font-size:13px;line-height:1.6;color:var(--text-secondary);letter-spacing:-.15px;max-width:260px; }

        .chat-input-wrapper { display:flex;gap:8px;flex-shrink:0;align-items:stretch; }
        .chat-input {
            flex:1;padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid var(--glass-border);
            border-radius:5px;color:var(--text-primary);font-family:'Inter',sans-serif;font-size:13px;transition:all .2s ease;
            height:40px;
        }
        .chat-input::placeholder { color:var(--text-tertiary); }
        .chat-input:focus { outline:none;background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.2); }


.chat-attach {
    width:40px;height:40px;background:rgba(255,255,255,.06);border:1px solid var(--glass-border);
    border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;
    transition:all .15s ease;flex-shrink:0;position:relative;
}
.chat-attach:hover { background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2); }
.chat-attach img { width:18px;height:18px;opacity:.7; }
.chat-attach input[type="file"] { display:none; }

.chat-file-preview {
    display:none;
    gap:4px;
    padding:4px 6px;
    flex-wrap:wrap;
    background:rgba(255,255,255,.03);
    border:1px solid var(--glass-border);
    border-radius:4px;
    margin-bottom:8px;
}


.chat-message-image {
    max-width:150px;
    max-height:150px;
    border-radius:5px;
    cursor:pointer;
    transition:opacity .2s ease;
    margin-top:6px;
}
.chat-message-image:hover { opacity:.85; }

.chat-message-attachment {
    display:flex;
    align-items:center;
    gap:6px;
    margin-top:8px;
    padding-top:8px;
    border-top:1px solid rgba(255,255,255,.05);
    font-size:12px;
    color:var(--text-secondary);
}
.chat-message-attachment img { width:14px;height:14px;opacity:.6; }

/* When attachment is the only content (no text), remove the separator line */
.chat-message-attachment.no-sep {
    border-top: none;
    padding-top: 0;
    margin-top: 0;
}

.image-modal {
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,.9);
    backdrop-filter:blur(10px);
    z-index:2000;
    display:none;
    align-items:center;
    justify-content:center;
    cursor:pointer;
}
.image-modal.show { display:flex; }
.image-modal img {
    max-width:90%;
    max-height:90%;
    border-radius:8px;
    box-shadow:0 0 40px rgba(0,0,0,.5);
}

/* PDF MODAL */
.pdf-modal-overlay {
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,.9);
    backdrop-filter:blur(10px);
    z-index:2000;
    display:none;
    align-items:center;
    justify-content:center;
    cursor:pointer;
}
.pdf-modal-overlay.show { display:flex; }

.pdf-modal-content {
    display:flex;
    flex-direction:column;
    width:90%;
    max-width:595px; /* A4 width approx in px for 96dpi */
    height:90%;
    background:rgba(255,255,255,.98);
    border-radius:8px;
    box-shadow:0 0 40px rgba(0,0,0,.5);
    overflow:hidden;
    cursor:default;
}
.pdf-modal-viewer {
    flex:1;overflow-y:auto;overflow-x:hidden;scrollbar-width:none;
}
.pdf-modal-viewer::-webkit-scrollbar{display:none}
.pdf-modal-download{padding:12px;border-top:1px solid rgba(0,0,0,.06);background:rgba(255,255,255,.98)}
.pdf-download-btn{width:100%;padding:12px 14px;background:rgba(100,100,100,.85);border-radius:6px;border:1px solid rgba(0,0,0,.08);color:#fff;font-weight:600;cursor:pointer}
.pdf-download-btn:hover{background:rgba(90,90,90,.95)}

        
.chat-file-item {
    display:flex;align-items:center;gap:4px;padding:3px 6px;
    background:rgba(255,255,255,.08);border:1px solid var(--glass-border);
    border-radius:4px;font-size:10px;color:var(--text-secondary);
}
.chat-file-item img.file-icon { width:12px;height:12px;opacity:.6; }
.chat-file-item .file-remove {
    width:12px;height:12px;cursor:pointer;opacity:.5;
    transition:opacity .15s ease;
}
.chat-file-item .file-remove:hover { opacity:1; }




        


        
        .chat-send {
    width:40px;height:40px;background:rgba(255,255,255,.06);border:1px solid var(--glass-border);
    border-radius:5px;color:var(--text-primary);font-family:'Inter',sans-serif;font-weight:500;
    cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center;
    padding:0;
}
.chat-send:hover { background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2); }
.chat-send img { width:18px;height:18px;opacity:.7; }

        /* ─── EMPTY STATE ─── */
        .empty-state { text-align:center;padding:60px 20px;color:var(--text-secondary); }
        .empty-state-icon { margin-bottom:16px;opacity:.4; }
        .empty-state-icon img { width:90px;height:90px;opacity:.7; }
        .empty-state h3 { font-size:15px;margin-bottom:8px;color:var(--text-primary);font-weight:500;letter-spacing:-.2px; }
        .empty-state p { font-size:13px;line-height:1.5;letter-spacing:-.1px; }

        /* ─── AUTH MODAL ─── */
        .auth-overlay {
            position:fixed;top:0;left:0;width:100%;height:1010%;background:rgba(0,0,0,.8);
            backdrop-filter:saturate(180%) blur(20px);z-index:1000;display:flex;align-items:center;
            justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s ease;
        }
        .auth-overlay.active { opacity:1;pointer-events:all; }

        .auth-modal {
            background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:5px;padding:24px;
            backdrop-filter:saturate(180%) blur(20px);
            width:320px; /* Фиксированная начальная ширина */
            max-width:calc(100% - 40px);
            /* ПЛАВНОЕ изменение размера */
            transition:transform .3s ease, width .8s cubic-bezier(0.4,0,0.2,1);
            transform:scale(.9);
        }
        .auth-overlay.active .auth-modal { transform:scale(1); }

        .auth-form { display:flex;flex-direction:column;gap:12px;width:100%; }
        .form-group { display:flex;flex-direction:column;gap:6px;width:100%; }
        .form-input {
            padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid var(--glass-border);
            border-radius:5px;color:var(--text-primary);font-family:'Inter',sans-serif;font-size:14px;
            transition:all .2s ease;letter-spacing:-.2px;width:100%;
        }
        .form-input.error { border-color:rgba(255,80,80,.5); }
        .form-input::placeholder { color:var(--text-tertiary); }
        .form-input:focus { outline:none;background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.2); }
        .form-input.error:focus { border-color:rgba(255,80,80,.5); }
        .form-input[type="number"] { -moz-appearance:textfield; }
        .form-input[type="number"]::-webkit-outer-spin-button,
        .form-input[type="number"]::-webkit-inner-spin-button { -webkit-appearance:none;margin:0; }

        .pin-input-container { display:flex;gap:12px;justify-content:space-between;margin:0 0 16px 0;width:100%; }
        .pin-digit {
            flex:1;min-width:0;height:60px;background:rgba(255,255,255,.05);border:1px solid var(--glass-border);
            border-radius:8px;color:var(--text-primary);font-family:'Inter',sans-serif;font-size:24px;
            font-weight:600;text-align:center;transition:all .2s ease;
        }
        .pin-digit.error { border-color:rgba(255,80,80,.5) !important; }
        .pin-digit:focus { outline:none;background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.3); }
        .pin-digit.error:focus { border-color:rgba(255,80,80,.5) !important; }
        .pin-digit[type="number"] { -moz-appearance:textfield; }
        .pin-digit[type="number"]::-webkit-outer-spin-button,
        .pin-digit[type="number"]::-webkit-inner-spin-button { -webkit-appearance:none;margin:0; }

        .auth-buttons { display:flex;gap:8px;margin-top:8px;width:100%; }
        .auth-btn {
            flex:1;padding:10px 16px;background:rgba(255,255,255,.1);border:1px solid var(--glass-border);
            border-radius:5px;color:var(--text-primary);font-family:'Inter',sans-serif;font-weight:500;
            cursor:pointer;transition:all .2s ease;font-size:13px;
        }
        .auth-btn:hover { background:rgba(255,255,255,.15); }
        .auth-btn.primary { background:rgba(255,255,255,.15); }
        .auth-btn.primary:hover { background:rgba(255,255,255,.22); }
        .auth-btn:disabled { opacity:.5;cursor:not-allowed; }
        .auth-switch { margin-top:12px;text-align:center;font-size:12px;color:var(--text-secondary); }
        .auth-switch button { background:none;border:none;color:var(--text-primary);cursor:pointer;text-decoration:underline;font-family:'Inter',sans-serif;font-size:12px; }

        /* Register form */
        .register-form-content { display:flex;flex-direction:column;align-items:stretch;width:100%;gap:16px; }
        .register-form-content .auth-header { font-size:18px;font-weight:600;letter-spacing:-.3px;text-align:center;width:100%; }
        .user-id-display {
            padding:16px;background:rgba(255,255,255,.08);border:1px solid var(--glass-border);
            border-radius:5px;display:flex;align-items:center;justify-content:center;
            flex-wrap:wrap;gap:8px;width:100%;
        }
        .user-id-label { font-size:14px;color:var(--text-secondary);letter-spacing:-.2px;font-weight:600; }
        .user-id-number { font-size:14px;color:var(--text-secondary);letter-spacing:-.2px;font-weight:600; }
        .register-form-content .auth-form { width:100%;display:flex;flex-direction:column;gap:0; }
        .register-form-content .form-label-key {
            text-align:center;font-size:14px;font-weight:600;
            display:flex;align-items:center;justify-content:center;gap:8px;
            width:100%;margin:0 0 16px 0;
        }
        .key-icon { width:20px;height:20px; }

        .checkbox-group { display:flex;align-items:center;gap:8px;width:100%; }
        .checkbox-group input[type="checkbox"] {
            appearance:none;width:18px;height:18px;border:2px solid var(--text-secondary);border-radius:3px;
            cursor:pointer;position:relative;transition:all .2s ease;background:transparent;flex-shrink:0;
        }
        .checkbox-group input[type="checkbox"]:checked { background:var(--text-secondary);border-color:var(--text-secondary); }
        .checkbox-group input[type="checkbox"]:checked::after {
            content:'';position:absolute;left:5px;top:2px;width:4px;height:8px;
            border:solid var(--bg-primary);border-width:0 2px 2px 0;transform:rotate(45deg);
        }
        .checkbox-group label { font-size:12px;color:var(--text-secondary);cursor:pointer; }
        .checkbox-group a { color:var(--text-secondary);text-decoration:underline; }

        .loader {
            width:30px;height:30px;border:2px solid rgba(255,255,255,.1);border-top-color:var(--text-primary);
            border-radius:50%;animation:spin .6s linear infinite;margin:20px auto;
        }
        @keyframes spin { to{transform:rotate(360deg);} }
        .success-text { text-align:center;font-size:14px;color:var(--text-primary);margin-top:12px;font-weight:500; }
        .fullscreen-loader { display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px; }
        .fullscreen-success { display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;text-align:center;padding:20px; }
        .fullscreen-success .success-text { font-size:15px;line-height:1.6; }
        .logout-modal { text-align:center; }

        @media(max-width:480px){
            .container{ padding:0 16px; }
            .block-body{ padding:16px; }
            header{ padding:8px 0 0 0; }
            .header-inner{ padding:10px 16px; }
            .logo{ width:29px;height:29px; }
            .logo img{ width:86px;height:86px; }
            .pin-digit{ height:55px;font-size:20px; }
        }
    </style>
</head>
<body>

<header>
  <div class="container"> <!-- ДОБАВИТЬ -->
    <div class="header-inner">
      <div class="logo" onclick="toggleMonitorMode()" style="cursor: pointer;">
        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/c3a01dd59275d25a96184e99df50a8dc3dd27667/MSESVG.svg" alt="">
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="header-login-btn" onclick="alert('Магазин в разработке')">
          <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/6a50e74f86f19a5eacbe86caab2219a6292f2afc/Shop.svg" alt="Магазин">
        </button>
        <button class="header-login-btn" id="headerLoginBtn">
          <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/4dfd133fad5b470b755d0cc187cf6aad7cde97bb/door.svg" alt="Вход">
        </button>
      </div>
    </div>
  </div> <!-- ДОБАВИТЬ -->
</header>

<div class="container">
  <div class="main-wrapper">
    <div class="content-grid" id="contentGrid">

      <!-- LEFT BLOCK -->
      <div class="content-block" id="browserBlock">
        <div class="minimized-bar" id="browserMinBar" onclick="toggleMinimize('browserBlock')">
          <div class="bar-icon">
            <div class="btn-minimize" style="pointer-events:none;">
    <img class="icon-minimize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78604dcba41d217a860371149b6158d31c153e7f/minimize.svg?raw=true" alt="">
    <img class="icon-maximize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78ad84a8d8488e581eeca239a46eda3b65253af3/expand.svg" alt="">
</div>
          </div>
        </div>
        <div class="block-body" id="browserBody">
          <div class="inner-tabs">
            <button class="inner-tab active" data-inner="materials">
              <img class="inner-tab-icon icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/770747b8e4153b1de7ae798eb169e0b221be1bba/tab_materials.svg" alt="">
              <span>Материалы</span>
            </button>
            <button class="inner-tab" data-inner="workouts">
              <img class="inner-tab-icon icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/d48e325735969dad640d1448cc8dcc659fbb6862/tab_workouts.svg" alt="">
              <span>Тренировки</span>
            </button>
            <button class="inner-tab" data-inner="progress">
              <img class="inner-tab-icon icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/ffc7247d623b23ad966683313d80a037517dff60/tab_progress.svg" alt="">
              <span>Прогресс</span>
            </button>
            <button class="btn-minimize" onclick="toggleBrowserSearch()" style="margin-left:auto;margin-right:8px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="11" cy="11" r="8" stroke="var(--text-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="m21 21-4.35-4.35" stroke="var(--text-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <button class="btn-minimize" onclick="event.stopPropagation(); toggleMinimize('browserBlock')">
    <img class="icon-minimize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78604dcba41d217a860371149b6158d31c153e7f/minimize.svg?raw=true" alt="">
    <img class="icon-maximize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78ad84a8d8488e581eeca239a46eda3b65253af3/expand.svg" alt="">
</button>
          </div>
          <div id="browserSearchWrap" class="chat-search-wrap" style="width:100%;position:relative;top:0;right:0;margin-bottom:12px;display:none;">
            <input type="text" id="browserSearchInput" class="chat-search-input" placeholder="Поиск по всем вкладкам...">
          </div>
          <div class="content-body" id="main-content"></div>
        </div>
      </div>

      <!-- THIRD BLOCK (HIDDEN MODULE - MONITOR) - BEHIND OTHER BLOCKS -->
      <div class="content-block hidden-module" id="hiddenModule" style="position: absolute; top: 0; left: 80px; right: 80px; z-index: -1; opacity: 0; filter: blur(8px); transition: opacity 0.8s ease, filter 0.8s ease; background: transparent; border: none;">
        <div class="block-body" style="display: flex; align-items: center; justify-content: center; gap: 20px; padding: 0; position: relative; height: var(--block-height); overflow: visible;">
          
          <!-- КОНТЕЙНЕР ДЛЯ РАСТЯЖЕНИЯ НА ВСЮ ОБЛАСТЬ -->
          <div class="monitor-full-container" style="position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px; transform: scale(1.05); transform-origin: center center; overflow: visible;">
          
          <!-- Левые блоки (растянуты до высоты резюме) -->
          <div class="monitor-left-elements" style="position: absolute; left: calc(31% - 90px); top: 2.5%; transform: none; width: 160px; height: 95%; pointer-events: none;">
            <!-- Блок 1 - верх головы -->
            <div style="position: absolute; top: 0px; background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 12px 10px; display: flex; flex-direction: column; align-items: stretch; justify-content: center; color: var(--text-secondary); font-size: 11px; width: 100%; height: 65px; pointer-events: all;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/b26a37c67a27bbd20d47ae390f3c7ba3a3896ed0/stats_brain.svg" alt="" style="width: 14px; height: 14px;">
                  <span style="font-weight: 600; line-height: 1.1;">Здоровье ЦНС</span>
                </div>
                <span style="font-weight: 600; font-size: 12px; color: rgba(153,153,153,0.9);">8</span>
              </div>
              <div style="display: flex; gap: 1px; width: 100%;">
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
              </div>
            </div>
            <!-- Блок 2 - грудь -->
            <div style="position: absolute; top: calc(65px + (100% - 390px) / 5 * 1); background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 12px 10px; display: flex; flex-direction: column; align-items: stretch; justify-content: center; color: var(--text-secondary); font-size: 11px; width: 100%; height: 65px; pointer-events: all;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/b26a37c67a27bbd20d47ae390f3c7ba3a3896ed0/stat_lungs.svg" alt="" style="width: 14px; height: 14px;">
                  <span style="font-weight: 600; line-height: 1.1;">Функция лёгких</span>
                </div>
                <span style="font-weight: 600; font-size: 12px; color: rgba(153,153,153,0.9);">6</span>
              </div>
              <div style="display: flex; gap: 1px; width: 100%;">
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
              </div>
            </div>
            <!-- Блок 3 - новый блок -->
            <div style="position: absolute; top: calc(130px + (100% - 390px) / 5 * 2); background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 12px 10px; display: flex; flex-direction: column; align-items: stretch; justify-content: center; color: var(--text-secondary); font-size: 11px; width: 100%; height: 65px; pointer-events: all;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/b26a37c67a27bbd20d47ae390f3c7ba3a3896ed0/stat_immunity.svg" alt="" style="width: 14px; height: 14px;">
                  <span style="font-weight: 600; line-height: 1.1;">Иммунитет</span>
                </div>
                <span style="font-weight: 600; font-size: 12px; color: rgba(153,153,153,0.9);">7</span>
              </div>
              <div style="display: flex; gap: 1px; width: 100%;">
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
              </div>
            </div>
            <!-- Блок 4 - живот -->
            <div style="position: absolute; top: calc(195px + (100% - 390px) / 5 * 3); background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 12px 10px; display: flex; flex-direction: column; align-items: stretch; justify-content: center; color: var(--text-secondary); font-size: 11px; width: 100%; height: 65px; pointer-events: all;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/b26a37c67a27bbd20d47ae390f3c7ba3a3896ed0/stat_energy.svg" alt="" style="width: 14px; height: 14px;">
                  <span style="font-weight: 600; line-height: 1.1;">Энергообмен</span>
                </div>
                <span style="font-weight: 600; font-size: 12px; color: rgba(153,153,153,0.9);">9</span>
              </div>
              <div style="display: flex; gap: 1px; width: 100%;">
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
              </div>
            </div>
            <!-- Блок 5 - бедра -->
            <div style="position: absolute; top: calc(260px + (100% - 390px) / 5 * 4); background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 12px 10px; display: flex; flex-direction: column; align-items: stretch; justify-content: center; color: var(--text-secondary); font-size: 11px; width: 100%; height: 65px; pointer-events: all;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/b26a37c67a27bbd20d47ae390f3c7ba3a3896ed0/stat_flexibility.svg" alt="" style="width: 14px; height: 14px;">
                  <span style="font-weight: 600; line-height: 1.1;">Адаптивность</span>
                </div>
                <span style="font-weight: 600; font-size: 12px; color: rgba(153,153,153,0.9);">4</span>
              </div>
              <div style="display: flex; gap: 1px; width: 100%;">
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
              </div>
            </div>
            <!-- Блок 6 - ноги -->
            <div style="position: absolute; bottom: 0px; background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 12px 10px; display: flex; flex-direction: column; align-items: stretch; justify-content: center; color: var(--text-secondary); font-size: 11px; width: 100%; height: 65px; pointer-events: all;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/b26a37c67a27bbd20d47ae390f3c7ba3a3896ed0/stats_power.svg" alt="" style="width: 14px; height: 14px;">
                  <span style="font-weight: 600; line-height: 1.1;">Сила мышц</span>
                </div>
                <span style="font-weight: 600; font-size: 12px; color: rgba(153,153,153,0.9);">8</span>
              </div>
              <div style="display: flex; gap: 1px; width: 100%;">
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
              </div>
            </div>
          </div>
          
          <!-- Большой блок "ПРИЗНАКИ ЖИЗНИ" (слева) -->
          <div class="monitor-cardiogram-block" style="position: absolute; left: calc(31% - 340px); top: 2.5%; width: 210px; height: calc(47.5% - 6px); background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 14px; display: flex; flex-direction: column; pointer-events: all;">
            <div style="font-weight: 600; font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; text-align: center; display: flex; align-items: center; justify-content: space-between; gap: 6px; white-space: nowrap;">
              <span>ПРИЗНАКИ ЖИЗНИ</span>
              <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/f285999bcbd5f331bffb4244373e3aecc5695eb6/rate.svg" alt="" style="width: 14px; height: 14px;">
            </div>
            
            <!-- Анимированная кардиограмма с Lottie -->
            <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
              <div style="flex: 1; position: relative; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden;">
                <!-- Фоновая сетка растянутая по горизонтали и вертикали на весь блок -->
                <svg width="100%" height="100%" viewBox="0 0 150 120" style="position: absolute; top: 0; left: 0; background: rgba(0,0,0,0.2);">
                  <defs>
                    <pattern id="ecgGrid" width="5" height="5" patternUnits="userSpaceOnUse">
                      <path d="M 5 0 L 0 0 0 5" fill="none" stroke="rgba(153,153,153,0.15)" stroke-width="0.3"/>
                    </pattern>
                    <pattern id="ecgGridMajor" width="25" height="25" patternUnits="userSpaceOnUse">
                      <path d="M 25 0 L 0 0 0 25" fill="none" stroke="rgba(153,153,153,0.25)" stroke-width="0.5"/>
                    </pattern>
                  </defs>
                  <!-- Мелкая сетка -->
                  <rect width="100%" height="100%" fill="url(#ecgGrid)" />
                  <!-- Крупная сетка -->
                  <rect width="100%" height="100%" fill="url(#ecgGridMajor)" />
                </svg>
                
                <!-- Интерактивный canvas с градиентом поверх сетки -->
                <canvas id="ecgCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; transform: scaleX(-1) scaleY(-1);"></canvas>
              </div>
              
              <!-- Показатели -->
              <div style="display: flex; justify-content: space-between; gap: 8px; font-size: 10px; color: var(--text-secondary);">
                <div style="text-align: center; flex: 1; min-width: 0;">
                  <div style="font-weight: 600; color: rgba(153,153,153,0.9); font-size: 10.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <span style="opacity: 0.7;">Пульс </span><span id="pulseValue">72</span>
                  </div>
                </div>
                <div style="text-align: center; flex: 1; min-width: 0;">
                  <div style="font-weight: 600; color: rgba(153,153,153,0.9); font-size: 10.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <span style="opacity: 0.7;">ЧСС </span><span id="hrrValue">68</span>
                  </div>
                </div>
                <div style="text-align: center; flex: 1; min-width: 0;">
                  <div style="font-weight: 600; color: rgba(153,153,153,0.9); font-size: 10.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <span style="opacity: 0.7;">O₂ </span><span id="oxygenValue">98</span><span style="opacity: 0.7;">%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Большой блок "Весы" (слева внизу) -->
          <div class="monitor-weight-block" style="position: absolute; left: calc(31% - 340px); top: calc(50% + 6px); width: 210px; height: calc(47.5% - 6px); background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 14px; display: flex; flex-direction: column; pointer-events: all;">
            <div style="font-weight: 600; font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; text-align: center; display: flex; align-items: center; justify-content: space-between; gap: 6px; white-space: nowrap;">
              <span>ВЕСЫ</span>
              <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/9de8a26dbc1469309e975cc1be78720e41b1aa55/scale.svg" alt="" style="width: 14px; height: 14px;">
            </div>
            <div style="flex: 1; position: relative; overflow: visible;">
              <!-- Профессиональный график веса с сеткой и шкалами -->
              <svg width="100%" height="100%" viewBox="0 0 120 100" style="background: rgba(0,0,0,0.1); border-radius: 4px; transform: scale(1.2); transform-origin: center center; overflow: visible;">
                <!-- Определяем градиенты -->
                <defs>
                  <linearGradient id="gridGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:rgba(255,255,255,0.1);stop-opacity:1" />
                    <stop offset="100%" style="stop-color:rgba(255,255,255,0.05);stop-opacity:1" />
                  </linearGradient>
                  <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:rgba(153,153,153,0.6);stop-opacity:1" />
                    <stop offset="50%" style="stop-color:rgba(153,153,153,1);stop-opacity:1" />
                    <stop offset="100%" style="stop-color:rgba(153,153,153,0.8);stop-opacity:1" />
                  </linearGradient>
                </defs>
                
                <!-- Фоновая сетка (горизонтальные линии) -->
                <line x1="20" y1="10" x2="95" y2="10" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/>
                <line x1="20" y1="20" x2="95" y2="20" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/>
                <line x1="20" y1="30" x2="95" y2="30" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/>
                <line x1="20" y1="40" x2="95" y2="40" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/>
                <line x1="20" y1="50" x2="95" y2="50" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/>
                <line x1="20" y1="60" x2="95" y2="60" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/>
                <line x1="20" y1="70" x2="95" y2="70" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/>
                
                <!-- Вертикальные линии сетки -->
                <line x1="30" y1="10" x2="30" y2="75" stroke="rgba(255,255,255,0.06)" stroke-width="0.5"/>
                <line x1="45" y1="10" x2="45" y2="75" stroke="rgba(255,255,255,0.06)" stroke-width="0.5"/>
                <line x1="60" y1="10" x2="60" y2="75" stroke="rgba(255,255,255,0.06)" stroke-width="0.5"/>
                <line x1="75" y1="10" x2="75" y2="75" stroke="rgba(255,255,255,0.06)" stroke-width="0.5"/>
                <line x1="90" y1="10" x2="90" y2="75" stroke="rgba(255,255,255,0.06)" stroke-width="0.5"/>
                
                <!-- Основные оси -->
                <line x1="20" y1="10" x2="20" y2="75" stroke="rgba(255,255,255,0.2)" stroke-width="1"/>
                <line x1="20" y1="75" x2="95" y2="75" stroke="rgba(255,255,255,0.2)" stroke-width="1"/>
                
                <!-- Засечки на Y-оси (вес) -->
                <line x1="17" y1="10" x2="20" y2="10" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                <line x1="17" y1="20" x2="20" y2="20" stroke="rgba(255,255,255,0.2)" stroke-width="0.5"/>
                <line x1="17" y1="30" x2="20" y2="30" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                <line x1="17" y1="40" x2="20" y2="40" stroke="rgba(255,255,255,0.2)" stroke-width="0.5"/>
                <line x1="17" y1="50" x2="20" y2="50" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                <line x1="17" y1="60" x2="20" y2="60" stroke="rgba(255,255,255,0.2)" stroke-width="0.5"/>
                <line x1="17" y1="70" x2="20" y2="70" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                
                <!-- Засечки на X-оси (время) -->
                <line x1="20" y1="75" x2="20" y2="78" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                <line x1="30" y1="75" x2="30" y2="77" stroke="rgba(255,255,255,0.2)" stroke-width="0.5"/>
                <line x1="45" y1="75" x2="45" y2="78" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                <line x1="60" y1="75" x2="60" y2="77" stroke="rgba(255,255,255,0.2)" stroke-width="0.5"/>
                <line x1="75" y1="75" x2="75" y2="78" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                <line x1="90" y1="75" x2="90" y2="77" stroke="rgba(255,255,255,0.2)" stroke-width="0.5"/>
                <line x1="95" y1="75" x2="95" y2="78" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                
                <!-- Подписи Y-оси (вес в кг) - сдвинуты левее для предотвращения обрезания -->
                <text x="16" y="13" font-size="4" fill="rgba(255,255,255,0.6)" text-anchor="end">85</text>
                <text x="16" y="33" font-size="4" fill="rgba(255,255,255,0.6)" text-anchor="end">80</text>
                <text x="16" y="53" font-size="4" fill="rgba(255,255,255,0.6)" text-anchor="end">75</text>
                <text x="16" y="73" font-size="4" fill="rgba(255,255,255,0.6)" text-anchor="end">70</text>
                
                <!-- Подписи X-оси (время) -->
                <text x="20" y="85" font-size="3.5" fill="rgba(255,255,255,0.5)" text-anchor="middle">Янв</text>
                <text x="45" y="85" font-size="3.5" fill="rgba(255,255,255,0.5)" text-anchor="middle">Мар</text>
                <text x="75" y="85" font-size="3.5" fill="rgba(255,255,255,0.5)" text-anchor="middle">Май</text>
                <text x="95" y="85" font-size="3.5" fill="rgba(255,255,255,0.5)" text-anchor="middle">Июл</text>
                
                <!-- Область под графиком (градиент) -->
                <path d="M20,70 L25,65 L35,68 L45,62 L55,60 L65,58 L75,55 L85,52 L95,50 L95,75 L20,75 Z" 
                      fill="url(#gridGradient)" opacity="0.3"/>
                
                <!-- Основная линия графика -->
                <polyline points="20,70 25,65 35,68 45,62 55,60 65,58 75,55 85,52 95,50" 
                          fill="none" 
                          stroke="url(#lineGradient)" 
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"/>
                
                <!-- Точки данных -->
                <circle cx="20" cy="70" r="1.5" fill="rgba(153,153,153,0.9)" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                <circle cx="35" cy="68" r="1.5" fill="rgba(153,153,153,0.9)" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                <circle cx="55" cy="60" r="1.5" fill="rgba(153,153,153,0.9)" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                <circle cx="75" cy="55" r="1.5" fill="rgba(153,153,153,0.9)" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                <circle cx="95" cy="50" r="1.5" fill="rgba(153,153,153,0.9)" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
              </svg>
            </div>
          </div>
          
          <!-- Центральная картинка (человек - точно в центре) -->
          <div class="monitor-center-image" style="position: absolute; left: 50%; top: 42%; transform: translate(-50%, -50%); width: 343px; height: 502px; display: flex; align-items: center; justify-content: center; z-index: 1;">
            <img id="monitorHumanImage" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/5ec8acac0d97faf61ecd4b56746d3ab429bb6a25/human_male.svg" 
                 alt="Human Monitor" 
                 style="width: 100%; height: 100%; opacity: 0.7; filter: invert(60%) sepia(0%) saturate(0%) brightness(100%) contrast(100%);">
          </div>
          
          <!-- Плашка с номером звена (выровнена по нижней границе) -->
          <div id="monitorUserPlate" style="position: absolute; bottom: 2.5%; left: 50%; transform: translateX(-50%); width: 160px; height: 65px; background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 12px 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 11px; pointer-events: all;">
            <div style="display: flex; align-items: center; gap: 6px; font-weight: 600; margin-bottom: 3px; text-align: center; line-height: 1.1;">
              <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/8e7c454664cbf26d3a86b667ca03be110f258e8c/chain.svg" alt="" style="width: 12px; height: 12px;">
              <span>Пробное звено</span>
            </div>
            <div style="font-size: 9px; text-align: center; line-height: 1.1; opacity: 0.8;">дата подключения неизвестна</div>
          </div>
          
          <!-- Правые блоки (растянуты до высоты резюме) -->
          <div class="monitor-right-elements" style="position: absolute; right: calc(31% - 90px); top: 2.5%; transform: none; width: 160px; height: 95%; pointer-events: none;">
            <!-- Блок 6 - верх головы -->
            <div style="position: absolute; top: 0px; background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 12px 10px; display: flex; flex-direction: column; align-items: stretch; justify-content: center; color: var(--text-secondary); font-size: 11px; width: 100%; height: 65px; pointer-events: all;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/b26a37c67a27bbd20d47ae390f3c7ba3a3896ed0/stat_nerve.svg" alt="" style="width: 14px; height: 14px;">
                  <span style="font-weight: 600; line-height: 1.1;">Когнитивность</span>
                </div>
                <span style="font-weight: 600; font-size: 12px; color: rgba(153,153,153,0.9);">7</span>
              </div>
              <div style="display: flex; gap: 1px; width: 100%;">
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
              </div>
            </div>
            <!-- Блок 7 - грудь -->
            <div style="position: absolute; top: calc(65px + (100% - 390px) / 5 * 1); background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 12px 10px; display: flex; flex-direction: column; align-items: stretch; justify-content: center; color: var(--text-secondary); font-size: 11px; width: 100%; height: 65px; pointer-events: all;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/b26a37c67a27bbd20d47ae390f3c7ba3a3896ed0/stats-heart.svg" alt="" style="width: 14px; height: 14px;">
                  <span style="font-weight: 600; line-height: 1.1;">Сердце</span>
                </div>
                <span style="font-weight: 600; font-size: 12px; color: rgba(153,153,153,0.9);">9</span>
              </div>
              <div style="display: flex; gap: 1px; width: 100%;">
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
              </div>
            </div>
            <!-- Блок 8 - новый блок -->
            <div style="position: absolute; top: calc(130px + (100% - 390px) / 5 * 2); background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 12px 10px; display: flex; flex-direction: column; align-items: stretch; justify-content: center; color: var(--text-secondary); font-size: 11px; width: 100%; height: 65px; pointer-events: all;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/b26a37c67a27bbd20d47ae390f3c7ba3a3896ed0/stats-blood.svg" alt="" style="width: 14px; height: 14px;">
                  <span style="font-weight: 600; line-height: 1.1;">Кровообращение</span>
                </div>
                <span style="font-weight: 600; font-size: 12px; color: rgba(153,153,153,0.9);">8</span>
              </div>
              <div style="display: flex; gap: 1px; width: 100%;">
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
              </div>
            </div>
            <!-- Блок 9 - живот -->
            <div style="position: absolute; top: calc(195px + (100% - 390px) / 5 * 3); background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 12px 10px; display: flex; flex-direction: column; align-items: stretch; justify-content: center; color: var(--text-secondary); font-size: 11px; width: 100%; height: 65px; pointer-events: all;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/b26a37c67a27bbd20d47ae390f3c7ba3a3896ed0/stat-stomach.svg" alt="" style="width: 14px; height: 14px;">
                  <span style="font-weight: 600; line-height: 1.1;">Пищеварение</span>
                </div>
                <span style="font-weight: 600; font-size: 12px; color: rgba(153,153,153,0.9);">5</span>
              </div>
              <div style="display: flex; gap: 1px; width: 100%;">
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
              </div>
            </div>
            <!-- Блок 10 - бедра -->
            <div style="position: absolute; top: calc(260px + (100% - 390px) / 5 * 4); background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 12px 10px; display: flex; flex-direction: column; align-items: stretch; justify-content: center; color: var(--text-secondary); font-size: 11px; width: 100%; height: 65px; pointer-events: all;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/b26a37c67a27bbd20d47ae390f3c7ba3a3896ed0/stat-hormone.svg" alt="" style="width: 14px; height: 14px;">
                  <span style="font-weight: 600; line-height: 1.1;">Гормоны</span>
                </div>
                <span style="font-weight: 600; font-size: 12px; color: rgba(153,153,153,0.9);">3</span>
              </div>
              <div style="display: flex; gap: 1px; width: 100%;">
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
              </div>
            </div>
            <!-- Блок 11 - ноги -->
            <div style="position: absolute; bottom: 0px; background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 12px 10px; display: flex; flex-direction: column; align-items: stretch; justify-content: center; color: var(--text-secondary); font-size: 11px; width: 100%; height: 65px; pointer-events: all;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/b26a37c67a27bbd20d47ae390f3c7ba3a3896ed0/stat-Endurance.svg" alt="" style="width: 14px; height: 14px;">
                  <span style="font-weight: 600; line-height: 1.1;">Выносливость</span>
                </div>
                <span style="font-weight: 600; font-size: 12px; color: rgba(153,153,153,0.9);">8</span>
              </div>
              <div style="display: flex; gap: 1px; width: 100%;">
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(153,153,153,0.8); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
                <div style="flex: 1; height: 7px; background: rgba(255,255,255,.1); border-radius: 2px;"></div>
              </div>
            </div>
          </div>
          
          <!-- Большой блок "Биологический профиль" (справа) -->
          <div class="monitor-resume-block" style="position: absolute; right: calc(31% - 340px); top: 2.5%; width: 210px; height: 95%; background: rgba(255,255,255,.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 14px; display: flex; flex-direction: column; pointer-events: all;">
            <div style="font-weight: 600; font-size: 11px; color: var(--text-secondary); margin-bottom: 14px; text-align: center; display: flex; align-items: center; justify-content: space-between; gap: 6px; white-space: nowrap;">
              <span>БИОЛОГИЧЕСКИЙ ПРОФИЛЬ</span>
              <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/81d97c8bba93d72cc8ecc5bca722f914f50b8ad3/BioProfile.svg" alt="" style="width: 14px; height: 14px;">
            </div>
            <div style="flex: 1; color: var(--text-secondary); font-size: 11px; line-height: 1.4; overflow-y: auto;">
              <div style="margin-bottom: 10px;">
                <strong>Общее состояние:</strong> Удовлетворительное
              </div>
              <div style="margin-bottom: 10px;">
                <strong>ЧСС:</strong> 72 уд/мин (норма)
              </div>
              <div style="margin-bottom: 10px;">
                <strong>Давление:</strong> 120/80 мм рт.ст.
              </div>
              <div style="margin-bottom: 10px;">
                <strong>Вес:</strong> Стабильный, в пределах нормы
              </div>
              <div style="margin-bottom: 10px;">
                <strong>Энергетический баланс:</strong> Высокий уровень
              </div>
              <div style="margin-bottom: 10px;">
                <strong>Рекомендации:</strong>
              </div>
              <div style="font-size: 10px; color: var(--text-tertiary);">
                • Поддерживать текущий режим тренировок<br>
                • Увеличить потребление воды<br>
                • Контролировать уровень стресса<br>
                • Регулярный сон 7-8 часов
              </div>
            </div>
          </div>
          
          </div> <!-- Закрытие monitor-full-container -->
          
        </div>
      </div>

      <!-- RIGHT BLOCK -->
      <div class="content-block" id="chatBlock">
       <div class="minimized-bar" id="chatMinBar" onclick="toggleMinimize('chatBlock')">
  <div class="bar-icon">
    <div class="btn-minimize" style="pointer-events:none;">
      <img class="icon-minimize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78604dcba41d217a860371149b6158d31c153e7f/minimize.svg?raw=true" alt="">
      <img class="icon-maximize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/3bcfa3f01b7a0cbaa8bbe8c35458c43f0ac67399/expand.svg" alt="">
    </div>
  </div>
</div>
        <div class="block-body" id="chatBody">
          <div class="chat-top-bar">
           <button class="chat-new-btn" onclick="addChatTab()">
    <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/9732c784325850db295c23102be226588b219c01/new-chat.svg" alt="" style="width:16px;height:16px;">
</button>
            <div class="chat-tabs-wrapper" id="chatTabsWrapper">
              <div class="chat-tabs" id="chatTabs">
                <button class="chat-tab active" data-chat="sofia" data-base="true">
                  <span>София</span>
                </button>
              </div>
            </div>
            <div class="chat-right-controls">
              <button class="chat-search-btn" onclick="toggleChatSearch()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="11" cy="11" r="8" stroke="var(--text-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="m21 21-4.35-4.35" stroke="var(--text-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            <button class="btn-minimize" onclick="event.stopPropagation(); toggleMinimize('chatBlock')" style="margin-left:auto;">
    <img class="icon-minimize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78604dcba41d217a860371149b6158d31c153e7f/minimize.svg?raw=true" alt="">
    <img class="icon-maximize icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/78ad84a8d8488e581eeca239a46eda3b65253af3/expand.svg" alt="">
</button>
            </div>
            <div class="chat-search-wrap" id="chatSearchWrap">
              <input type="text" class="chat-search-input" id="chatSearchInput" placeholder="Поиск чатов…">
            </div>
          </div>
          <div class="chat-container">
            <div class="chat-messages" id="chat-messages"></div>
      <div style="display:flex;flex-direction:column;flex-shrink:0;">
  <div style="position:relative;display:flex;flex-direction:column;">
    <div class="chat-file-preview" id="chat-file-preview"></div>
    <div class="chat-input-wrapper">
      <input type="text" class="chat-input" id="chat-input" placeholder="Задай вопрос Софии...">
      <button class="chat-attach" id="chat-attach">
        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/6dcd23d0286a4a0edc50bd9410d7ac9a26b6b41c/attach.svg" alt="">
        <input type="file" id="chat-file-input" multiple accept="*/*">
      </button>
      <button class="chat-send" id="chat-send">
        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/f4325dd706d24eb3c1058e176da6daac524a38e8/send.svg" alt="">
      </button>
    </div>
  </div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-modal" id="authModal">
    <!-- LOGIN -->
    <div id="loginForm">
      <div id="loginContent">
        <h2 class="auth-header" style="font-size:18px;font-weight:600;margin-bottom:16px;letter-spacing:-.3px;text-align:center;">ПОДКЛЮЧЕНИЕ К СЕТИ MSE</h2>
        <form class="auth-form" onsubmit="return false;">
          <div class="form-group" id="stepId">
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-size:13px;font-weight:500;white-space:nowrap;">ЗВЕНО</span>
              <input type="number" class="form-input" id="loginId" placeholder="0000" autocomplete="off" style="flex:1;min-width:0;text-align:center;font-weight:600;">
            </div>
          </div>
          <div id="loginTransitionLoader" style="display:none;"><div class="loader"></div></div>
          <div class="form-group" id="stepPin" style="display:none;">
            <div class="pin-input-container">
              <input type="number" class="pin-digit" id="loginPin1" maxlength="1" autocomplete="off">
              <input type="number" class="pin-digit" id="loginPin2" maxlength="1" autocomplete="off">
              <input type="number" class="pin-digit" id="loginPin3" maxlength="1" autocomplete="off">
              <input type="number" class="pin-digit" id="loginPin4" maxlength="1" autocomplete="off">
            </div>
          </div>
          <div class="auth-buttons" id="loginButtons">
            <button type="button" class="auth-btn" onclick="closeAuth()">Отмена</button>
          </div>
        </form>
        <div class="auth-switch" style="display:flex;align-items:center;justify-content:center;gap:6px;">
          <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/8e7c454664cbf26d3a86b667ca03be110f258e8c/chain.svg" alt="" style="width:14px;height:14px;">
          <span>Нет аккаунта? <button onclick="showRegister()">Присоединиться к MSE</button></span>
        </div>
      </div>
      <div id="loginToRegisterLoader" class="fullscreen-loader" style="display:none;"><div class="loader"></div></div>
      <div id="loginLoader" class="fullscreen-loader" style="display:none;"><div class="loader"></div></div>
      <div id="loginSuccess" class="fullscreen-success" style="display:none;"><div class="success-text">Вход разрешён</div></div>
    </div>
    <!-- REGISTER -->
    <div id="registerForm" style="display:none;">
      <div id="registerContent">
        <div class="register-form-content">
          <h2 class="auth-header">Новое подключение к сети MSE</h2>
          <div class="user-id-display">
            <span class="user-id-label">Вы станете звеном под номером:</span>
            <span class="user-id-number" id="newUserId">----</span>
          </div>
          <form class="auth-form" onsubmit="return false;">
            <div class="form-label-key">
              <img class="key-icon icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/86e9d94bad44abbb9f11716894a6a30d68de3fac/key.svg" alt="">
              <span>Создайте уникальный ключ доступа</span>
            </div>
            <div class="pin-input-container">
              <input type="number" class="pin-digit" id="pin1" maxlength="1" autocomplete="off">
              <input type="number" class="pin-digit" id="pin2" maxlength="1" autocomplete="off">
              <input type="number" class="pin-digit" id="pin3" maxlength="1" autocomplete="off">
              <input type="number" class="pin-digit" id="pin4" maxlength="1" autocomplete="off">
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="termsCheckbox">
              <label for="termsCheckbox">Я принимаю <a href="#" target="_blank">условия подключения к сети MSE</a></label>
            </div>
            <div class="auth-buttons" id="registerButtons">
              <button type="button" class="auth-btn" onclick="closeAuth()">Отмена</button>
              <button type="submit" class="auth-btn primary" onclick="register()" id="registerBtn" disabled>Создать аккаунт</button>
            </div>
          </form>
        </div>
      </div>
      <div id="registerLoader" class="fullscreen-loader" style="display:none;"><div class="loader"></div></div>
      <div id="registerSuccess" class="fullscreen-success" style="display:none;"><div class="success-text"></div></div>
    </div>
    <!-- LOGOUT -->
    <div id="logoutModal" style="display:none;">
      <div class="logout-modal">
        <h2 class="auth-header" style="font-size:18px;font-weight:600;margin-bottom:12px;letter-spacing:-.3px;text-align:center;">Выход из сети</h2>
        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:20px;line-height:1.5;text-align:center;">Вы уверены, что хотите выйти из аккаунта?</p>
        <div class="auth-buttons">
          <button type="button" class="auth-btn" onclick="closeAuth()">Отмена</button>
          <button type="button" class="auth-btn primary" onclick="confirmLogout()">Выйти</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- PDF Modal -->
<div class="pdf-modal-overlay" id="pdfModalOverlay">
    <div class="pdf-modal-content" onclick="event.stopPropagation();">
        <div class="pdf-modal-viewer" id="pdfModalViewer"></div>
        <div class="pdf-modal-download">
            <button class="pdf-download-btn" onclick="downloadPDF()">Скачать</button>
        </div>
    </div>
</div>

<div class="image-modal" id="imageModal">
    <img id="modalImage" src="" alt="">
</div>

<script>
// ============================================================
// MINIMIZE / EXPAND with smooth animation
// ============================================================
const COLLAPSED_WIDTH = '54px';
const FADE_DURATION = 350;
const RESIZE_DURATION = 800;

const blockState = { browserBlock: false, chatBlock: false };

function toggleMonitorMode() {
    closeAllMenus();
    
    // Если оба блока уже свернуты - разворачиваем их
    if (blockState.browserBlock && blockState.chatBlock) {
        expandBlock('browserBlock');
        expandBlock('chatBlock');
    } else {
        // Иначе сворачиваем оба блока для показа монитора
        if (!blockState.browserBlock) {
            collapseBlock('browserBlock');
        }
        if (!blockState.chatBlock) {
            collapseBlock('chatBlock');
        }
    }
}

function toggleMinimize(id) {
    closeAllMenus();
    if (blockState[id]) {
        expandBlock(id);
    } else {
        collapseBlock(id);
    }
}

function updateGridState() {
    const grid = document.getElementById('contentGrid');
    const hiddenModule = document.getElementById('hiddenModule');
    const bothCollapsed = blockState.browserBlock && blockState.chatBlock;
    
    if (bothCollapsed) {
        grid.classList.add('both-collapsed');
        // Показываем скрытый модуль с небольшой задержкой (300мс)
        setTimeout(() => {
            hiddenModule.style.opacity = '1';
            hiddenModule.style.filter = 'blur(0px)';
        }, 300);
    } else {
        grid.classList.remove('both-collapsed');
        // При разворачивании не трогаем скрытый модуль - это делает expandBlock
    }
}

function collapseBlock(id) {
    blockState[id] = true;
    const block = document.getElementById(id);
    const body = block.querySelector('.block-body');
    const bar = block.querySelector('.minimized-bar');

   // НЕ добавляем класс сразу - добавим в середине анимации
    
    // ОБНОВЛЯЕМ СОСТОЯНИЕ ДО АНИМАЦИИ при сворачивании
    updateGridState();
    
    // ШАГ 1: Blur и fade-out контента одновременно со сворачиванием
    body.style.filter = 'blur(8px)';
    body.style.opacity = '0';
    
    // Запускаем одновременное сворачивание блока и расширение соседнего
    block.classList.add('collapsed');
       setTimeout(() => {
        block.classList.add('minimized');
    }, RESIZE_DURATION / 2);
    
    // ШАГ 2: После завершения видимой части анимации показываем bar
    setTimeout(() => {
        body.style.display = 'none';
        bar.style.width = COLLAPSED_WIDTH;
    }, RESIZE_DURATION / 2);
}

function expandBlock(id) {
    const block = document.getElementById(id);
    const body = block.querySelector('.block-body');
    const bar = block.querySelector('.minimized-bar');
    const hiddenModule = document.getElementById('hiddenModule');
    
    // Проверяем, были ли оба блока свёрнуты ДО изменения состояния
    const bothWereCollapsed = blockState.browserBlock && blockState.chatBlock;
    
    // Изменяем состояние
    blockState[id] = false;

    if (bothWereCollapsed) {
        // Если оба были свёрнуты - скрываем модуль одновременно с разворачиванием
        hiddenModule.style.opacity = '0';
        hiddenModule.style.filter = 'blur(8px)';
        // Сразу начинаем разворачивание (без задержки)
        startExpansion();
    } else {
        // Если только один был свёрнут - сразу разворачиваем
        startExpansion();
    }

    function startExpansion() {
        // ШАГ 1: Скрываем bar
        bar.style.width = '0px';
        
        // ШАГ 2: Показываем контент с blur и opacity=0 (готовим для разблюривания)
        body.style.display = 'flex';
        body.style.filter = 'blur(8px)';
        body.style.opacity = '0';
        
        // ШАГ 3: Запускаем расширение (соседний блок автоматически сжимается)
        block.classList.remove('collapsed');
        // Меняем иконку в середине анимации (когда она скрыта)
        setTimeout(() => {
            block.classList.remove('minimized');
        }, RESIZE_DURATION / 2);
        
        // ШАГ 4: Одновременно с расширением разблюриваем и проявляем контент
        setTimeout(() => {
            body.style.filter = 'blur(0px)';
            body.style.opacity = '1';
        }, 50);
        
        // ШАГ 5: Обновляем grid state ПОСЛЕ завершения анимации
        setTimeout(() => {
            updateGridState();
        }, RESIZE_DURATION);
    }
}
 

 

// ============================================================
// AUTH - с улучшенными анимациями размера
// ============================================================
let users = [{ id:1001, pin:'1234', createdAt: new Date().toISOString() }];
let currentUser = null;
let loginDate = null;

// ============================================================
// FIREBASE DATABASE FUNCTIONS
// ============================================================

// Save user data to Firebase
async function saveUserToFirebase(userId, userData) {
    try {
        const userRef = window.firebaseDoc(window.firebaseDB, 'users', userId.toString());
        await window.firebaseSetDoc(userRef, {
            ...userData,
            lastUpdated: window.firebaseServerTimestamp()
        }, { merge: true });
        console.log('User data saved to Firebase');
    } catch (error) {
        console.error('Error saving user data:', error);
    }
}

// Load user data from Firebase
async function loadUserFromFirebase(userId) {
    try {
        const userRef = window.firebaseDoc(window.firebaseDB, 'users', userId.toString());
        const userSnap = await window.firebaseGetDoc(userRef);
        
        if (userSnap.exists()) {
            console.log('User data loaded from Firebase');
            return userSnap.data();
        } else {
            console.log('No user data found in Firebase');
            return null;
        }
    } catch (error) {
        console.error('Error loading user data:', error);
        return null;
    }
}

// Save achievements to Firebase
async function saveAchievementsToFirebase(userId, achievements) {
    try {
        const userRef = window.firebaseDoc(window.firebaseDB, 'users', userId.toString());
        await window.firebaseUpdateDoc(userRef, {
            achievements: achievements,
            lastUpdated: window.firebaseServerTimestamp()
        });
        console.log('Achievements saved to Firebase');
    } catch (error) {
        console.error('Error saving achievements:', error);
    }
}

// Save notes to Firebase
async function saveNotesToFirebase(userId, notes) {
    try {
        const userRef = window.firebaseDoc(window.firebaseDB, 'users', userId.toString());
        await window.firebaseUpdateDoc(userRef, {
            notes: notes,
            lastUpdated: window.firebaseServerTimestamp()
        });
        console.log('Notes saved to Firebase');
    } catch (error) {
        console.error('Error saving notes:', error);
    }
}

// Save monitor stats to Firebase
async function saveMonitorStatsToFirebase(userId, stats) {
    try {
        const userRef = window.firebaseDoc(window.firebaseDB, 'users', userId.toString());
        await window.firebaseUpdateDoc(userRef, {
            monitorStats: stats,
            lastUpdated: window.firebaseServerTimestamp()
        });
        console.log('Monitor stats saved to Firebase');
    } catch (error) {
        console.error('Error saving monitor stats:', error);
    }
}

document.getElementById('headerLoginBtn').addEventListener('click', () => {
    currentUser ? showLogout() : showLogin();
});

const LOGIN_WIDTH = '320px';
const REG_WIDTH = '380px';
const SUCCESS_WIDTH = '340px'; // Оптимальная ширина для сообщения об успехе

function setModalWidth(w) {
    const m = document.getElementById('authModal');
    m.style.width = w;
}

function showLogin() {
    const modal = document.getElementById('authModal');
    modal.style.width = LOGIN_WIDTH; // Устанавливаем сразу без анимации
    
    document.getElementById('loginForm').style.display='block';
    document.getElementById('registerForm').style.display='none';
    document.getElementById('logoutModal').style.display='none';
    document.getElementById('loginContent').style.display='block';
    document.getElementById('stepId').style.display='flex';
    document.getElementById('stepPin').style.display='none';
    document.getElementById('loginTransitionLoader').style.display='none';
    document.getElementById('loginToRegisterLoader').style.display='none';
    document.getElementById('loginLoader').style.display='none';
    document.getElementById('loginSuccess').style.display='none';
    document.getElementById('loginButtons').style.display='flex';
    document.getElementById('loginId').value='';
    ['loginPin1','loginPin2','loginPin3','loginPin4'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('loginId').classList.remove('error');
    loginIdChecked=false;
    document.getElementById('authOverlay').classList.add('active');
    setTimeout(()=>document.getElementById('loginId').focus(),300);
}

async function showRegister() {
    document.getElementById('loginContent').style.display='none';
    document.getElementById('loginToRegisterLoader').style.display='flex';
    
    // Начинаем изменять размер во время показа лоадера
    setTimeout(() => {
        setModalWidth(REG_WIDTH);
    }, 100);
    
    setTimeout(async ()=>{
        document.getElementById('loginForm').style.display='none';
        document.getElementById('registerForm').style.display='block';
        document.getElementById('logoutModal').style.display='none';
        
        // Generate unique ID by checking Firebase
        let newId = users.length>0 ? Math.max(...users.map(u=>u.id))+1 : 1001;
        
        // Check if ID exists in Firebase and increment until we find free one
        let idExists = true;
        while (idExists) {
            const firebaseData = await loadUserFromFirebase(newId);
            if (firebaseData) {
                newId++; // ID exists, try next one
            } else {
                idExists = false; // ID is free
            }
        }
        
        document.getElementById('newUserId').textContent = newId.toString().padStart(4,'0');
        document.getElementById('registerContent').style.display='block';
        ['pin1','pin2','pin3','pin4'].forEach(id=>document.getElementById(id).value='');
        document.getElementById('termsCheckbox').checked=false;
        document.getElementById('registerBtn').disabled=true;
        document.getElementById('registerLoader').style.display='none';
        document.getElementById('registerSuccess').style.display='none';
        document.getElementById('registerButtons').style.display='flex';
        document.getElementById('loginToRegisterLoader').style.display='none';
    }, 800);
}

function showLogout() {
    setModalWidth('320px');
    document.getElementById('loginForm').style.display='none';
    document.getElementById('registerForm').style.display='none';
    document.getElementById('logoutModal').style.display='block';
    document.getElementById('authOverlay').classList.add('active');
}

function closeAuth() { 
    document.getElementById('authOverlay').classList.remove('active'); 
}

function confirmLogout() {
    currentUser=null;
    loginDate=null;
    
    // Clear all user data
    userAchievements = ACHIEVEMENTS.map(a => ({...a, unlocked: false}));
    userNotes = [];
    
    // Reset chat to initial state with Sofia greeting
    chatStore = { 
        sofia: [{
            role: 'ai',
            text: 'Привет! Я София, твой персональный AI-тренер. Готова помочь тебе с тренировками, питанием и достижением целей. Чем могу быть полезна?'
        }]
    };
    activeChatTab = 'sofia';
    
    document.getElementById('headerLoginBtn').innerHTML='<img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/4dfd133fad5b470b755d0cc187cf6aad7cde97bb/door.svg" alt="Вход">';
    
    // Сбрасываем плашку в мониторе
    const monitorPlate = document.getElementById('monitorUserPlate');
    if (monitorPlate) {
        monitorPlate.innerHTML = `
            <div style="display: flex; align-items: center; gap: 6px; font-weight: 600; margin-bottom: 2px; text-align: center; line-height: 1.1;">
              <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/8e7c454664cbf26d3a86b667ca03be110f258e8c/chain.svg" alt="" style="width: 12px; height: 12px;">
              <span>Пробное звено</span>
            </div>
            <div style="font-size: 8px; text-align: center; line-height: 1.1; opacity: 0.8;">дата подключения неизвестна</div>
        `;
    }
    
    // Refresh UI immediately
    refreshProgressTab();
    renderChatMessages();
    
    // Force update the progress tab content if it's active
    if (activeInnerTab === 'progress') {
        const mainContent = document.getElementById('main-content');
        if (mainContent) {
            mainContent.innerHTML = renderProgress();
        }
    }
    
    // Close auth modal with a small delay to ensure UI updates
    setTimeout(() => {
        const authOverlay = document.getElementById('authOverlay');
        if (authOverlay) {
            authOverlay.classList.remove('active');
        }
    }, 50);
}

// ── Login ID check ──
let loginIdChecked=false;
async function checkLoginId() {
    const input=document.getElementById('loginId');
    if(input.value.length>4) input.value=input.value.slice(0,4);
    const val=input.value.trim();
    if(val===''){input.classList.remove('error');return;}
    input.classList.remove('error');
    if(val.length===4&&!loginIdChecked){
        const id=parseInt(val);
        
        // Check in local users first
        let exists=users.find(u=>u.id===id);
        
        // If not found locally, check Firebase
        if (!exists) {
            const firebaseData = await loadUserFromFirebase(id);
            if (firebaseData) {
                // User exists in Firebase, add to local array
                exists = { id: id, pin: firebaseData.pin || '0000' };
                users.push(exists);
            }
        }
        
        if(exists){
            loginIdChecked=true;
            document.getElementById('stepId').style.display='none';
            document.getElementById('loginTransitionLoader').style.display='block';
            setTimeout(()=>{
                document.getElementById('loginTransitionLoader').style.display='none';
                document.getElementById('stepPin').style.display='flex';
                setTimeout(()=>document.getElementById('loginPin1').focus(),100);
            },800);
        } else { input.classList.add('error'); }
    }
}
(function(){
    const el=document.getElementById('loginId');
    el.addEventListener('input',checkLoginId);
    el.addEventListener('keyup',checkLoginId);
    el.addEventListener('input',function(){if(this.value.trim().length<4)loginIdChecked=false;});
})();

// ── Login PIN ──
const loginPinInputs=['loginPin1','loginPin2','loginPin3','loginPin4'];
loginPinInputs.forEach((id,index)=>{
    const input=document.getElementById(id);
    input.addEventListener('input',function(){
        loginPinInputs.forEach(p=>document.getElementById(p).classList.remove('error'));
        if(this.value.length>1)this.value=this.value.slice(0,1);
        if(this.value.length===1&&index<loginPinInputs.length-1)
            document.getElementById(loginPinInputs[index+1]).focus();
        const allFilled=loginPinInputs.every(p=>document.getElementById(p).value.length===1);
        if(allFilled){
            const pin=loginPinInputs.map(p=>document.getElementById(p).value).join('');
            const uid=parseInt(document.getElementById('loginId').value);
            const user=users.find(u=>u.id===uid&&u.pin===pin);
            if(user){
                document.getElementById('loginContent').style.display='none';
                document.getElementById('loginLoader').style.display='flex';
                setTimeout(()=>{
                    document.getElementById('loginLoader').style.display='none';
                    document.getElementById('loginSuccess').style.display='flex';
                    setTimeout(async ()=>{
                        currentUser=user;
                        loginDate = new Date();
                        
                        // Load user data from Firebase
                        const firebaseData = await loadUserFromFirebase(user.id);
                        if (firebaseData) {
                            // Load achievements
                            if (firebaseData.achievements) {
                                userAchievements = firebaseData.achievements;
                            }
                            // Load notes
                            if (firebaseData.notes) {
                                userNotes = firebaseData.notes;
                            }
                            // Load monitor stats
                            if (firebaseData.monitorStats) {
                                // Apply monitor stats if needed
                                console.log('Monitor stats loaded:', firebaseData.monitorStats);
                            }
                        } else {
                            // First time login - save initial data
                            await saveUserToFirebase(user.id, {
                                id: user.id,
                                createdAt: user.createdAt,
                                achievements: userAchievements,
                                notes: userNotes
                            });
                        }
                        
                        closeAuth();
                        document.getElementById('headerLoginBtn').innerHTML='<img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/4dfd133fad5b470b755d0cc187cf6aad7cde97bb/door.svg" alt="Звено '+currentUser.id.toString().padStart(4,'0')+'" title="Звено '+currentUser.id.toString().padStart(4,'0')+'">';
                        // Обновляем плашку в мониторе
                        const monitorPlate = document.getElementById('monitorUserPlate');
                        if (monitorPlate) {
                            const dateStr = loginDate.toLocaleDateString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit', 
                                year: 'numeric'
                            });
                            console.log('Updating monitor plate with date:', dateStr); // Отладка
                            monitorPlate.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 6px; font-weight: 600; margin-bottom: 2px; text-align: center; line-height: 1.1;">
                                  <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/8e7c454664cbf26d3a86b667ca03be110f258e8c/chain.svg" alt="" style="width: 12px; height: 12px;">
                                  <span>Звено ${currentUser.id.toString().padStart(4,'0')}</span>
                                </div>
                                <div style="font-size: 8px; text-align: center; line-height: 1.1; opacity: 0.8;">Дата подключения</div>
                                <div style="font-size: 8px; text-align: center; line-height: 1.1; opacity: 0.8;">${dateStr}</div>
                            `;
                        } else {
                            console.log('Monitor plate not found'); // Отладка
                        }
                        // Обновляем вкладку "Прогресс" если она открыта
                        refreshProgressTab();
                    },1000);
                },2000);
            } else {
                document.getElementById('loginPin1').focus();
                requestAnimationFrame(()=>{loginPinInputs.forEach(p=>document.getElementById(p).classList.add('error'));});
                setTimeout(()=>{
                    loginPinInputs.forEach(p=>{
                        const inp=document.getElementById(p);inp.classList.remove('error');inp.value='';
                    });
                    document.getElementById('loginPin1').focus();
                },500);
            }
        }
    });
    input.addEventListener('keydown',function(e){
        if(e.key==='Backspace'&&this.value===''&&index>0)
            document.getElementById(loginPinInputs[index-1]).focus();
    });
});

// ── Register PIN ──
const pinInputs=['pin1','pin2','pin3','pin4'];
pinInputs.forEach((id,index)=>{
    const input=document.getElementById(id);
    input.addEventListener('input',function(){
        if(this.value.length>1)this.value=this.value.slice(0,1);
        if(this.value.length===1&&index<pinInputs.length-1)
            document.getElementById(pinInputs[index+1]).focus();
        checkRegisterButton();
    });
    input.addEventListener('keydown',function(e){
        if(e.key==='Backspace'&&this.value===''&&index>0)
            document.getElementById(pinInputs[index-1]).focus();
    });
});
document.getElementById('termsCheckbox').addEventListener('change',checkRegisterButton);

function checkRegisterButton(){
    const allFilled=pinInputs.every(id=>document.getElementById(id).value.length===1);
    document.getElementById('registerBtn').disabled=!(allFilled&&document.getElementById('termsCheckbox').checked);
}

function register(){
    const pin=pinInputs.map(id=>document.getElementById(id).value).join('');
    const userId=parseInt(document.getElementById('newUserId').textContent);
    if(pin.length!==4||!document.getElementById('termsCheckbox').checked)return;
    
    document.getElementById('registerContent').style.display='none';
    document.getElementById('registerLoader').style.display='flex';
    
    // Начинаем изменять размер во время показа лоадера
    setTimeout(() => {
        setModalWidth(SUCCESS_WIDTH);
    }, 100);
    
    setTimeout(async ()=>{
        const newUser={id:userId,pin,createdAt:new Date().toISOString()};
        users.push(newUser);
        currentUser=newUser;
        
        // Save new user to Firebase
        await saveUserToFirebase(userId, {
            id: userId,
            pin: pin,
            createdAt: newUser.createdAt,
            achievements: userAchievements,
            notes: userNotes
        });
        
        document.getElementById('registerLoader').style.display='none';
        document.getElementById('registerSuccess').style.display='flex';
        document.getElementById('registerSuccess').querySelector('.success-text').innerHTML=
            `<div style="display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:12px;">
                <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/8e7c454664cbf26d3a86b667ca03be110f258e8c/chain.svg" alt="" style="width:20px;height:20px;">
                <span style="font-size:14px;">Подключение выполнено</span>
            </div>
            <div style="font-size:32px;font-weight:700;text-align:center;letter-spacing:-1px;">#${userId.toString().padStart(4,'0')}</div>`;
        setTimeout(()=>{
            currentUser=newUser;
            loginDate = new Date();
            closeAuth();
            document.getElementById('headerLoginBtn').innerHTML='<img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/4dfd133fad5b470b755d0cc187cf6aad7cde97bb/door.svg" alt="Звено '+currentUser.id.toString().padStart(4,'0')+'" title="Звено '+currentUser.id.toString().padStart(4,'0')+'">';
            // Обновляем плашку в мониторе
            const monitorPlate = document.getElementById('monitorUserPlate');
            if (monitorPlate) {
                const dateStr = loginDate.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric'
                });
                console.log('Updating monitor plate (register) with date:', dateStr); // Отладка
                monitorPlate.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 6px; font-weight: 600; margin-bottom: 2px; text-align: center; line-height: 1.1;">
                      <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/8e7c454664cbf26d3a86b667ca03be110f258e8c/chain.svg" alt="" style="width: 12px; height: 12px;">
                      <span>Звено ${currentUser.id.toString().padStart(4,'0')}</span>
                    </div>
                    <div style="font-size: 8px; text-align: center; line-height: 1.1; opacity: 0.8;">Дата подключения</div>
                    <div style="font-size: 8px; text-align: center; line-height: 1.1; opacity: 0.8;">${dateStr}</div>
                `;
            } else {
                console.log('Monitor plate not found (register)'); // Отладка
            }
            // Обновляем вкладку "Прогресс" если она открыта
            refreshProgressTab();
        },2500);
    },2000);
}

// ============================================================
// BROWSER TABS (Materials / Workouts / Progress)
// ============================================================
let activeInnerTab = 'materials'; // Track active inner tab

function refreshProgressTab() {
    // Refresh progress tab content if it's currently active
    if (activeInnerTab === 'progress') {
        const mainContent = document.getElementById('main-content');
        if (mainContent) {
            mainContent.innerHTML = renderProgress();
        }
    }
}

// Store all tab data for search
let allBrowserItems = [];

function updateAllBrowserItems() {
    allBrowserItems = [];
    
    // Add materials
    tabData.materials.forEach((item, index) => {
        allBrowserItems.push({
            type: 'materials',
            index: index,
            title: item.title,
            desc: item.desc,
            icon: item.icon
        });
    });
    
    // Add workouts
    tabData.workouts.forEach((item, index) => {
        allBrowserItems.push({
            type: 'workouts',
            index: index,
            title: item.title,
            desc: item.desc,
            icon: item.icon
        });
    });
    
    // Add notes
    userNotes.forEach(note => {
        allBrowserItems.push({
            type: 'progress',
            subtype: 'note',
            id: note.id,
            title: note.title,
            desc: note.description,
            icon: 'https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/e886b5b608c07e53417b231e710e7ace8dbb3932/note.svg'
        });
    });
    
    // Add achievements
    userAchievements.forEach(achievement => {
        allBrowserItems.push({
            type: 'progress',
            subtype: 'achievement',
            id: achievement.id,
            title: achievement.title,
            desc: achievement.description,
            icon: 'https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/4cecf715f68ab30916f1aea8a34de2cdac46ea20/puzzle.svg',
            unlocked: achievement.unlocked
        });
    });
}

const TAB_DEFAULTS={
    materials:'https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/d252d71940705d10f712f6c0926dc19d2b4b9c59/default_material.svg',
    workouts:'https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/d252d71940705d10f712f6c0926dc19d2b4b9c59/default_workout.svg',
    progress:'https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/main/DNATR.json'
};
const tabData={
    materials:[
        {title:'Основы правильного питания',desc:'Гайд по макронутриентам и калориям',icon:TAB_DEFAULTS.materials},
        {title:'Техника выполнения упражнений',desc:'Видео-уроки от профессионалов',icon:TAB_DEFAULTS.materials},
        {title:'Программы тренировок',desc:'Готовые планы на разные цели',icon:TAB_DEFAULTS.materials},
        {title:'Восстановление и стретчинг',desc:'Упражнения для гибкости и релаксации',icon:TAB_DEFAULTS.materials}
    ],
    workouts:[
        {title:'Силовая тренировка — День 1',desc:'Грудь и трицепс · 45 минут',icon:TAB_DEFAULTS.workouts},
        {title:'Кардио тренировка',desc:'HIIT интервалы · 30 минут',icon:TAB_DEFAULTS.workouts},
        {title:'Силовая тренировка — День 2',desc:'Спина и бицепс · 50 минут',icon:TAB_DEFAULTS.workouts},
        {title:'День ног',desc:'Квадрицепсы, бицепсы бедра · 60 минут',icon:TAB_DEFAULTS.workouts}
    ]
};
function renderItemList(items, tabType){
    return '<div class="materials-list">'+items.map((item, index)=>
        `<div class="material-item clickable-item" data-item-type="${tabType}" data-item-index="${index}">
            <div class="material-icon"><img class="icon-gray" src="${item.icon}" alt=""></div>
            <div class="material-info"><h3>${item.title}</h3><p>${item.desc}</p></div>
         </div>`
    ).join('')+'</div>';
}
function renderProgress(){
    // Если пользователь не залогинен - показываем приглашение
    if (!currentUser) {
        const html = `<div class="empty-state">
            <div class="empty-state-icon" id="lottie-progress" style="width:234px;height:234px;margin:0 auto;"></div>
            <h3>Прогресс и достижения</h3>
            <p>Здесь София будет добавлять ваши достижения и записи по мере успеха в тренировках. <strong style="font-weight:600;white-space:nowrap;"><a href="#" onclick="document.getElementById('headerLoginBtn').click();return false;" style="color:var(--text-primary);text-decoration:none;cursor:pointer;">Войдите, чтобы увидеть больше.</a></strong></p>
        </div>`;
        
        setTimeout(async () => {
            const container = document.getElementById('lottie-progress');
            if(container && !container.hasAnimation) {
                try {
                    const response = await fetch(TAB_DEFAULTS.progress);
                    let data = await response.json();
                    
                    // Замена темного цвета на цвет фона браузера
                    const replaceColors = (obj) => {
                        if (Array.isArray(obj)) {
                            return obj.map((item) => {
                                if (Array.isArray(item) && item.length === 4 && typeof item[0] === 'number') {
                                    if ((item[0] === 0 && item[1] === 0 && item[2] === 0) ||
                                        (item[0] < 0.1 && item[1] < 0.1 && item[2] < 0.1)) {
                                        return [0.11, 0.11, 0.11, item[3]];
                                    }
                                }
                                return replaceColors(item);
                            });
                        } else if (obj !== null && typeof obj === 'object') {
                            const result = {};
                            for (let key in obj) {
                                result[key] = replaceColors(obj[key]);
                            }
                            return result;
                        }
                        return obj;
                    };
                    
                    data = replaceColors(data);
                    
                    const animation = lottie.loadAnimation({
                        container: container,
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        animationData: data
                    });
                    animation.setSpeed(0.5);
                    container.hasAnimation = true;
                } catch(e) {
                    console.error('Error loading progress animation:', e);
                }
            }
        }, 100);
        
        return html;
    }
    
    // Если пользователь залогинен - показываем достижения и заметки
    let html = '<div class="materials-list">';
    
    // Сначала показываем заметки
    userNotes.forEach(note => {
        html += `
            <div class="material-item" data-note-id="${note.id}" data-item-type="note">
                <div class="material-icon">
                    <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/e886b5b608c07e53417b231e710e7ace8dbb3932/note.svg" alt="">
                </div>
                <div class="material-info">
                    <h3>${note.title}</h3>
                    <p>${note.description}</p>
                </div>
            </div>
        `;
    });
    
    // Затем показываем достижения
    userAchievements.forEach(achievement => {
        const lockIcon = achievement.unlocked ? '' : `
            <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/e886b5b608c07e53417b231e710e7ace8dbb3932/padlock.svg" 
                 alt="Заблокировано" style="width:16px;height:16px;opacity:0.5;margin-left:auto;">
        `;
        
        html += `
            <div class="material-item" data-achievement-id="${achievement.id}" data-item-type="achievement" style="opacity:${achievement.unlocked ? '1' : '0.5'};">
                <div class="material-icon">
                    <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/4cecf715f68ab30916f1aea8a34de2cdac46ea20/puzzle.svg" alt="">
                </div>
                <div class="material-info" style="flex:1;">
                    <h3>${achievement.title}</h3>
                    <p>${achievement.description}</p>
                </div>
                ${lockIcon}
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}
function renderProgress_OLD(){
    const html = `<div class="empty-state">
        <div class="empty-state-icon" id="lottie-progress" style="width:234px;height:234px;margin:0 auto;"></div>
        <h3>Прогресс и достижения</h3>
        <p>Войдите, чтобы увидеть больше. <button onclick="document.getElementById('headerLoginBtn').click()" style="background:none;border:none;color:var(--text-primary);text-decoration:underline;cursor:pointer;font-family:'Inter',sans-serif;font-size:13px;">Войти в сеть</button></p>
    </div>`;
    setTimeout(async () => {
        const container = document.getElementById('lottie-progress');
        if(container && !container.hasAnimation) {
            try {
                const response = await fetch(TAB_DEFAULTS.progress);
                let data = await response.json();
                
                // Замена темного цвета на цвет фона браузера (0.11, 0.11, 0.11 = #1c1c1c)
                const replaceColors = (obj) => {
                    if (Array.isArray(obj)) {
                        return obj.map((item) => {
                            if (Array.isArray(item) && item.length === 4 && typeof item[0] === 'number') {
                                // Если это полностью черный или очень темный цвет, заменяем на цвет фона вкладки
                                if ((item[0] === 0 && item[1] === 0 && item[2] === 0) ||
                                    (item[0] < 0.1 && item[1] < 0.1 && item[2] < 0.1)) {
                                    return [0.11, 0.11, 0.11, item[3]];
                                }
                            }
                            return replaceColors(item);
                        });
                    } else if (obj !== null && typeof obj === 'object') {
                        const result = {};
                        for (let key in obj) {
                            result[key] = replaceColors(obj[key]);
                        }
                        return result;
                    }
                    return obj;
                };
                
                data = replaceColors(data);
                
                lottie.loadAnimation({
                    container: container,
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    animationData: data
                });
                container.hasAnimation = true;
            } catch(e) {
                console.error('Error loading animation:', e);
            }
        }
    }, 100);
    return html;
}
function getTabHTML(key){ return key==='progress'?renderProgress():renderItemList(tabData[key], key); }

// Initialize UI after DOM is ready
// Attach click handlers to material items based on tab type
function attachMaterialClickHandlers(tabType) {
    // Don't attach PDF handlers for progress tab
    if (tabType === 'progress') return;
    
    const items = document.querySelectorAll('.clickable-item');
    items.forEach(item => {
        // avoid adding duplicate listeners
        if (item.dataset.pdfBound) return;
        item.dataset.pdfBound = '1';
        item.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const pdfType = tabType === 'materials' ? 'materials' : 'workouts';
            const pdfUrl = PDF_URLS[pdfType];
            const win = window.open(pdfUrl, '_blank', 'noopener,noreferrer');
            if (!win) {
                // popup blocked — navigate current tab as fallback
                window.location.href = pdfUrl;
            }
        });
    });
}

function initUI() {
    const innerTabs=document.querySelectorAll('.inner-tab');
    const mainContent=document.getElementById('main-content');
    mainContent.innerHTML=getTabHTML('materials');
    setTimeout(()=>attachMaterialClickHandlers('materials'), 0);

    innerTabs.forEach(tab=>{
        tab.addEventListener('click',()=>{
            if (tab.classList.contains('active')) return;
            
            // Фаза 1: Плавное заблюривание и fade-out
            mainContent.style.filter = 'blur(4px)';
            mainContent.style.opacity = '0';
            
            setTimeout(()=>{
                // Фаза 2: Переключение вкладки (в момент полного исчезновения)
                innerTabs.forEach(t=>t.classList.remove('active'));
                tab.classList.add('active');
                activeInnerTab = tab.dataset.inner; // Track active tab
                mainContent.innerHTML = getTabHTML(tab.dataset.inner);
                
                // Фаза 3: Разблюривание и fade-in
                setTimeout(() => {
                    mainContent.style.filter = 'blur(0px)';
                    mainContent.style.opacity = '1';
                    attachMaterialClickHandlers(tab.dataset.inner);
                }, 100); // Увеличена задержка для плавности
            }, 300); // Увеличено время fade-out в 2 раза
        });
    });
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initUI);
} else {
    initUI();
}

// ============================================================
// GEMINI AI INTEGRATION
// ============================================================

const GEMINI_API_KEY = 'AIzaSyDlTNE94C2II0ZnaWS6aVpUw-g3OECS23Y';
// Try stable models without -exp suffix
const GEMINI_MODELS = [
    'gemini-2.0-flash',
    'gemini-1.5-flash',
    'gemini-1.5-pro'
];
let currentModelIndex = 0;

function getGeminiURL() {
    // Use v1beta for Gemini models
    return `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODELS[currentModelIndex]}:generateContent`;
}

// System prompt that defines Sofia's role and capabilities
function getSofiaSystemPrompt() {
    const pulseValue = document.getElementById('pulseValue')?.textContent || '72';
    const hrrValue = document.getElementById('hrrValue')?.textContent || '68';
    const oxygenValue = document.getElementById('oxygenValue')?.textContent || '98';
    
    return `Ты - София, персональный AI-тренер и помощник в фитнес-приложении MSE (My Sports Evolution).

ТВОЯ РОЛЬ:
- Помогаешь пользователям с тренировками, питанием и здоровьем
- Мотивируешь и поддерживаешь на пути к целям
- Анализируешь прогресс и даёшь рекомендации
- Присваиваешь достижения за успехи
- Добавляешь заметки с важными наблюдениями

ДОСТУПНЫЕ КОМАНДЫ (возвращай в JSON):
{
  "response": "твой текстовый ответ пользователю",
  "actions": [
    {"type": "unlock_achievement", "title": "название достижения"},
    {"type": "add_note", "title": "заголовок", "description": "описание"},
    {"type": "update_vital", "field": "pulse|hrr|oxygen", "value": число},
    {"type": "update_stat", "field": "cns|lungs|immunity|energy|adaptability|power", "value": число от 1 до 10}
  ]
}

ДОСТУПНЫЕ ДОСТИЖЕНИЯ:
${ACHIEVEMENTS.map(a => `- "${a.title}": ${a.description}`).join('\n')}

ТЕКУЩИЕ ПОКАЗАТЕЛИ ПОЛЬЗОВАТЕЛЯ:
- Пульс: ${pulseValue} уд/мин
- ЧСС: ${hrrValue} уд/мин
- O₂: ${oxygenValue}%

ПРАВИЛА:
1. Отвечай по-русски, дружелюбно и мотивирующе
2. Если пользователь достиг успеха - присваивай достижение
3. Если есть важное наблюдение - добавляй заметку
4. Можешь менять показатели монитора при необходимости
5. Будь конкретной и полезной
6. Используй эмодзи умеренно
7. ВСЕГДА возвращай ответ в JSON формате с полями "response" и "actions"

ПРИМЕРЫ:
Пользователь: "Я сегодня пробежал 5 км!"
Ответ: {"response": "Отлично! 5 км - это серьёзное достижение! 🏃‍♂️ Присваиваю тебе достижение за освоение кардио.", "actions": [{"type": "unlock_achievement", "title": "Мастер кардио"}, {"type": "add_note", "title": "Пробежка 5 км", "description": "Отличный результат в кардио тренировке"}]}

Пользователь: "Как правильно дышать при приседаниях?"
Ответ: {"response": "При приседаниях важно: вдох при опускании, выдох при подъёме. Это помогает стабилизировать корпус и защитить позвоночник. Держи спину прямой! 💪", "actions": []}`;
}

async function callGeminiAPI(userMessage, conversationHistory = []) {
    try {
        // Build conversation context (last 10 messages)
        const context = conversationHistory.slice(-10).map(msg => {
            if (msg.type === 'thinking') return '';
            return `${msg.role === 'user' ? 'Пользователь' : 'София'}: ${msg.text || ''}`;
        }).filter(m => m).join('\n');
        
        const systemPrompt = getSofiaSystemPrompt();
        const fullPrompt = `${systemPrompt}\n\nИСТОРИЯ ДИАЛОГА:\n${context}\n\nПользователь: ${userMessage}\n\nСофия (ответь ТОЛЬКО в JSON формате):`;
        
        console.log('Calling Gemini API with model:', GEMINI_MODELS[currentModelIndex]);
        
        const apiUrl = getGeminiURL();
        console.log('API URL:', apiUrl);
        
        const response = await fetch(`${apiUrl}?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: fullPrompt
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                }
            })
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('Gemini API error response:', errorData);
            
            // Don't retry on quota errors (429)
            if (response.status === 429) {
                throw new Error('Quota exceeded. Please wait a minute and try again.');
            }
            
            // Only try next model if 404 and we have more models
            if (response.status === 404 && currentModelIndex < GEMINI_MODELS.length - 1) {
                console.log('Model not found, trying next model...');
                currentModelIndex++;
                return callGeminiAPI(userMessage, conversationHistory);
            }
            
            throw new Error(`API error: ${response.status} - ${JSON.stringify(errorData)}`);
        }
        
        const data = await response.json();
        console.log('Gemini API response:', data);
        
        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
            console.error('Unexpected API response structure:', data);
            throw new Error('Invalid API response structure');
        }
        
        const aiResponse = data.candidates[0].content.parts[0].text;
        console.log('AI response text:', aiResponse);
        
        // Try to parse JSON response
        try {
            // Extract JSON from markdown code blocks if present
            let jsonText = aiResponse;
            const jsonMatch = aiResponse.match(/```json\s*([\s\S]*?)\s*```/);
            if (jsonMatch) {
                jsonText = jsonMatch[1];
            } else {
                // Try to find JSON object in text
                const objectMatch = aiResponse.match(/\{[\s\S]*\}/);
                if (objectMatch) {
                    jsonText = objectMatch[0];
                }
            }
            
            const parsed = JSON.parse(jsonText);
            console.log('Parsed AI response:', parsed);
            return parsed;
        } catch (e) {
            console.error('Failed to parse AI response as JSON:', aiResponse, e);
            // If not valid JSON, return as plain text response
            return {
                response: aiResponse,
                actions: []
            };
        }
    } catch (error) {
        console.error('Gemini API error:', error);
        console.error('Error stack:', error.stack);
        
        // Check if it's a quota error
        if (error.message && error.message.includes('Quota exceeded')) {
            return {
                response: 'Превышен лимит запросов к AI. Подожди минутку и попробуй снова! ⏱️',
                actions: []
            };
        }
        
        return {
            response: 'Извини, у меня возникли технические трудности. Попробуй ещё раз через несколько секунд. 🔧',
            actions: []
        };
    }
}

function executeAIActions(actions) {
    if (!actions || actions.length === 0) return;
    
    actions.forEach(action => {
        switch(action.type) {
            case 'unlock_achievement':
                if (!currentUser) return; // Require login
                const achievement = unlockAchievement(action.title);
                if (achievement) {
                    // Add achievement block to chat
                    chatStore[activeChatTab].push({
                        role:'ai',
                        type:'achievement',
                        achievementId: achievement.id,
                        title: achievement.title,
                        description: achievement.description
                    });
                    refreshProgressTab();
                }
                break;
                
            case 'add_note':
                if (!currentUser) return; // Require login
                const note = addNote(action.title, action.description);
                if (note) {
                    // Add note block to chat
                    chatStore[activeChatTab].push({
                        role:'ai',
                        type:'note',
                        noteId: note.id,
                        title: note.title,
                        description: note.description
                    });
                    refreshProgressTab();
                }
                break;
                
            case 'update_vital':
                if (action.field === 'pulse') {
                    updateHeartRate(action.value);
                } else {
                    const element = document.getElementById(`${action.field}Value`);
                    if (element) {
                        element.textContent = action.value;
                    }
                }
                break;
                
            case 'update_stat':
                // This would update the monitor stats (CNS, lungs, etc.)
                // For now just log it
                console.log(`Update stat: ${action.field} = ${action.value}`);
                break;
        }
    });
}

// ============================================================
// CHAT TABS
// ============================================================
// CHAT TABS
// ============================================================
let chatTabCounter = 1;
let activeChatTab  = 'sofia';
const chatStore    = { sofia: [] };
let openMenu       = null;
let pinnedChats    = new Set();

function createChatTabElement(id, name, isBase) {
    const tab = document.createElement('button');
    tab.className = 'chat-tab';
    tab.dataset.chat = id;
    if (isBase) tab.dataset.base = 'true';

    const nameSpan = document.createElement('span');
    nameSpan.textContent = name;
    tab.appendChild(nameSpan);

    // Создаем меню только для НЕ базовых вкладок
    if (!isBase) {
    // Обработчик клика для показа меню
    tab.addEventListener('click', (e) => {
        const wasActive = tab.classList.contains('active');
        
        if (!wasActive) {
            // Если вкладка НЕ активна - просто переключаемся
            switchChatTab(id);
            closeAllMenus();
        } else {
            // Если вкладка УЖЕ активна - показываем меню
            e.stopPropagation();
            toggleTabMenu(tab, id, nameSpan);
        }
    });
} else {
    // Для базовой вкладки просто переключаем чат
    tab.addEventListener('click', () => {
        switchChatTab(id);
        closeAllMenus();
    });
}

    return tab;
}

// Новая функция для создания и позиционирования меню
function toggleTabMenu(tab, id, nameSpan) {
    closeAllMenus();
    
    const menu = document.createElement('div');
    menu.className = 'chat-tab-menu show';
    menu.dataset.chatId = id;
    
    // ИЗМЕНИТЬ структуру меню - добавить текст к кнопкам
    menu.innerHTML =
    `<button class="chat-tab-menu-item" data-action="pin">
        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/45e14291c38b1dac85196a754e13e9d0da4a01cf/pin.svg" alt="">
    </button>` +
    `<button class="chat-tab-menu-item" data-action="rename">
        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/45e14291c38b1dac85196a754e13e9d0da4a01cf/rename.svg" alt="">
    </button>` +
    `<button class="chat-tab-menu-item" data-action="delete">
        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/45e14291c38b1dac85196a754e13e9d0da4a01cf/delete.svg" alt="">
    </button>`;
    
    document.body.appendChild(menu);
    
    // ИЗМЕНИТЬ позиционирование - справа от вкладки
    const rect = tab.getBoundingClientRect();
menu.style.position = 'fixed';
menu.style.left = rect.left + 'px';
menu.style.top = rect.bottom + 6 + 'px';
menu.style.transform = 'none';
    
    menu.querySelectorAll('.chat-tab-menu-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const action = btn.dataset.action;
            if (action === 'pin')    togglePinChat(id, tab);
            if (action === 'rename') showRenameInput(tab, id, nameSpan);
            if (action === 'delete') deleteChatTab(id);
            if (action !== 'rename') closeAllMenus(); // ИЗМЕНИТЬ - не закрывать при переименовании
        });
    });
    
    openMenu = menu;
}

    function showRenameInput(tab, id, nameSpan) {
    closeAllMenus(); // Закрываем меню
    
    const wrap = document.createElement('div');
    wrap.className = 'rename-input-wrap show';
    wrap.dataset.chatId = id;
    
    wrap.innerHTML = `
        <input type="text" class="rename-input" value="${nameSpan.textContent}" id="renameInput-${id}">
        <div class="rename-buttons">
            <button class="rename-btn" data-action="cancel">Отмена</button>
            <button class="rename-btn" data-action="save">Сохранить</button>
        </div>
    `;
    
    document.body.appendChild(wrap);
    
   const rect = tab.getBoundingClientRect();
wrap.style.left = rect.left + 'px';
wrap.style.top = rect.bottom + 6 + 'px';
    
    const input = wrap.querySelector('.rename-input');
    input.focus();
    input.select();
    
    wrap.querySelector('[data-action="cancel"]').addEventListener('click', () => {
        wrap.remove();
    });
    
    wrap.querySelector('[data-action="save"]').addEventListener('click', () => {
        const newName = input.value.trim();
        if (newName && newName !== nameSpan.textContent) {
            nameSpan.textContent = newName;
        }
        wrap.remove();
    });
    
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const newName = input.value.trim();
            if (newName && newName !== nameSpan.textContent) {
                nameSpan.textContent = newName;
            }
            wrap.remove();
        }
    });
}
    
function closeAllMenus() {
    document.querySelectorAll('.chat-tab-menu').forEach(m => m.remove());
    document.querySelectorAll('.rename-input-wrap').forEach(w => w.remove()); // ДОБАВИТЬ
    openMenu = null;
}

document.addEventListener('click', (e) => {
    if (!e.target.closest('.chat-tab-menu') && !e.target.closest('.chat-tab')) closeAllMenus();
});

function togglePinChat(id, tabElement) {
    const chatTabs = document.getElementById('chatTabs');
    const sofiaTab = document.querySelector('.chat-tab[data-base="true"]');
    
    if (pinnedChats.has(id)) {
        // ОТКРЕПЛЕНИЕ
        pinnedChats.delete(id);
        tabElement.classList.remove('pinned');
        console.log(`Чат ${id} откреплен`);
        
        // Находим последний закреплённый чат
        const allTabs = Array.from(chatTabs.querySelectorAll('.chat-tab'));
        const pinnedTabs = allTabs.filter(t => t.classList.contains('pinned'));
        
        if (pinnedTabs.length > 0) {
            // Если есть закреплённые - ставим после последнего закреплённого
            const lastPinned = pinnedTabs[pinnedTabs.length - 1];
            lastPinned.after(tabElement);
        } else {
            // Если закреплённых нет - ставим после Sofia
            sofiaTab.after(tabElement);
        }
        
    } else {
        // ЗАКРЕПЛЕНИЕ
        pinnedChats.add(id);
        tabElement.classList.add('pinned');
        console.log(`Чат ${id} закреплен`);
        
        // Перемещаем вкладку после Sofia
        if (sofiaTab && tabElement) {
            sofiaTab.after(tabElement);
        }
    }
}

function addChatTab(){
    const id = 'chat' + chatTabCounter++;
    chatStore[id] = [];
    const tab = createChatTabElement(id, 'Чат ' + (chatTabCounter - 1), false);
    document.getElementById('chatTabs').appendChild(tab);
    switchChatTab(id);
    updateChatScrollFade();
}

function deleteChatTab(id) {
    const tab = document.querySelector(`.chat-tab[data-chat="${id}"]`);
    if (tab && !tab.dataset.base) {
        tab.remove();
        delete chatStore[id];
        pinnedChats.delete(id);
        if (activeChatTab === id) switchChatTab('sofia');
        updateChatScrollFade();
    }
}

 
function switchChatTab(id){
    if (activeChatTab === id) return; // Не переключаем на ту же вкладку
    
    const chatMessages = document.getElementById('chat-messages');
    
    // Фаза 1: Плавное заблюривание и fade-out
    chatMessages.style.filter = 'blur(4px)';
    chatMessages.style.opacity = '0';
    
    setTimeout(() => {
        // Фаза 2: Переключение вкладки (в момент полного исчезновения)
        activeChatTab = id;
        document.querySelectorAll('.chat-tab').forEach(t => t.classList.toggle('active', t.dataset.chat===id));
        renderChatMessages();
        
        // Фаза 3: Разблюривание и fade-in
        setTimeout(() => {
            chatMessages.style.filter = 'blur(0px)';
            chatMessages.style.opacity = '1';
        }, 100); // Увеличена задержка для плавности
    }, 300); // Увеличено время fade-out в 2 раза
}

function updateChatScrollFade(){
    const wrapper = document.getElementById('chatTabsWrapper');
    const tabs    = document.getElementById('chatTabs');
    const scrollable = tabs.scrollWidth > tabs.clientWidth;
    const atStart    = tabs.scrollLeft <= 1;
    const atEnd      = tabs.scrollLeft + tabs.clientWidth >= tabs.scrollWidth - 1;
    
    wrapper.classList.remove('blur-left', 'blur-right', 'blur-both');
    
    if (scrollable && !atStart && atEnd) {
        wrapper.classList.add('blur-left');
    } else if (scrollable && atStart && !atEnd) {
        wrapper.classList.add('blur-right');
    } else if (scrollable && !atStart && !atEnd) {
        wrapper.classList.add('blur-both');
    }
}

document.getElementById('chatTabs').addEventListener('scroll', () => {
    updateChatScrollFade();
    closeAllMenus(); // ДОБАВИТЬ
});

function toggleChatSearch(){
    const wrap = document.getElementById('chatSearchWrap');
    wrap.classList.toggle('open');
    if (wrap.classList.contains('open')) document.getElementById('chatSearchInput').focus();
}

document.getElementById('chatSearchInput').addEventListener('input', function(){
    const q = this.value.toLowerCase();
    document.querySelectorAll('.chat-tab').forEach(tab => {
        const span = tab.querySelector('span');
        const name = span ? span.textContent.toLowerCase() : '';
        tab.style.display = name.includes(q) ? '' : 'none';
    });
});

document.addEventListener('click', (e) => {
    // Закрытие меню
    if (!e.target.closest('.chat-tab-menu') && 
        !e.target.closest('.chat-tab') && 
        !e.target.closest('.rename-input-wrap')) { // ДОБАВИТЬ
        closeAllMenus();
    }
    
    // Закрытие поиска (оставь как есть)
    const wrap = document.getElementById('chatSearchWrap');
    const btn  = document.querySelector('.chat-search-btn');
    if (!wrap.contains(e.target) && !btn.contains(e.target)) {
        wrap.classList.remove('open');
    }
});

function renderChatMessages(){
    const container = document.getElementById('chat-messages');
    const messages  = chatStore[activeChatTab] || [];
    
    // Приветствие только для Sofia
    if (messages.length === 0 && activeChatTab === 'sofia') {
        container.innerHTML = `<div class="chat-empty-state">
            <div class="sofia-icon" id="lottie-chat-sofia" style="width:90px;height:90px;margin:0 auto;"></div>
            <p>Привет, меня зовут София, я создана инженерами проекта MSE. Я смотрю как ты тренируешься, как питаешься и помогаю прогрессировать. Я никогда не сплю.</p>
        </div>`;
        
        // Загружаем Lottie анимацию для Sofia
        setTimeout(async () => {
            const lottieContainer = document.getElementById('lottie-chat-sofia');
            if(lottieContainer && !lottieContainer.hasAnimation) {
                try {
                    const response = await fetch('https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/main/Eye%20Loading%20Animation.json');
                    let data = await response.json();
                    
                    // Замена белых и светлых цветов на серый (#797979)
                    const replaceColors = (obj) => {
                        if (Array.isArray(obj)) {
                            return obj.map((item) => {
                                if (Array.isArray(item) && item.length === 4 && typeof item[0] === 'number') {
                                    // Замена белого и светлых цветов на #797979 (0.474, 0.474, 0.474)
                                    if ((item[0] > 0.8 && item[1] > 0.8 && item[2] > 0.8) ||
                                        (item[0] === 1 && item[1] === 1 && item[2] === 1)) {
                                        return [0.474, 0.474, 0.474, item[3]];
                                    }
                                }
                                return replaceColors(item);
                            });
                        } else if (obj !== null && typeof obj === 'object') {
                            const result = {};
                            for (let key in obj) {
                                result[key] = replaceColors(obj[key]);
                            }
                            return result;
                        }
                        return obj;
                    };
                    
                    data = replaceColors(data);
                    
                    const animation = lottie.loadAnimation({
                        container: lottieContainer,
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        animationData: data
                    });
                    animation.setSpeed(0.5);
                    lottieContainer.hasAnimation = true;
                } catch(e) {
                    console.error('Error loading chat animation:', e);
                }
            }
        }, 100);
    } else if (messages.length === 0) {
        // Для других чатов - приветствие
        container.innerHTML = `<div class="chat-empty-state">
            <div class="sofia-icon"><img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/d252d71940705d10f712f6c0926dc19d2b4b9c59/default_material.svg" alt=""></div>
            <p>Это новый чат. Напишите сообщение или прикрепите файл, чтобы начать диалог.</p>
        </div>`;
        } else {
        container.innerHTML = messages.map(m => {
            if (m.type === 'thinking') {
                // Анимация "София думает/анализирует"
                return `<div class="chat-message ${m.role}" style="background:transparent;border:none;padding:10px 0;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <div id="lottie-thinking-${m.id}" style="width:22px;height:22px;flex-shrink:0;"></div>
                        <span style="font-size:13px;color:var(--text-secondary);">София думает...</span>
                    </div>
                </div>`;
            } else if (m.type === 'achievement') {
                // Достижение
                return `<div class="chat-message ${m.role}" onclick="event.preventDefault();highlightInBrowser('achievement', ${m.achievementId});return false;" style="cursor:pointer;">
                    <div class="material-item" style="margin:0;cursor:pointer;">
                        <div class="material-icon">
                            <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/4cecf715f68ab30916f1aea8a34de2cdac46ea20/puzzle.svg" alt="">
                        </div>
                        <div class="material-info">
                            <h3>${m.title}</h3>
                            <p>${m.description}</p>
                        </div>
                    </div>
                </div>`;
            } else if (m.type === 'note') {
                // Заметка
                return `<div class="chat-message ${m.role}" onclick="event.preventDefault();highlightInBrowser('note', ${m.noteId});return false;" style="cursor:pointer;">
                    <div class="material-item" style="margin:0;cursor:pointer;">
                        <div class="material-icon">
                            <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/e886b5b608c07e53417b231e710e7ace8dbb3932/note.svg" alt="">
                        </div>
                        <div class="material-info">
                            <h3>${m.title}</h3>
                            <p>${m.description}</p>
                        </div>
                    </div>
                </div>`;
            } else if (m.type === 'image') {
                // Картинка
                return `<div class="chat-message ${m.role}">
                    <img class="chat-message-image" src="${m.src}" alt="${m.name}" onclick="openImageModal('${m.src}')">
                </div>`;
            } else if (m.type === 'file') {
                // Файл — если сообщение содержит только файл (нет текста), убираем верхнюю разделительную полосу
                const noSepClass = (typeof m.text === 'undefined' || m.text === null || m.text === '') ? ' no-sep' : '';
                return `<div class="chat-message ${m.role}">
                    <div class="chat-message-attachment${noSepClass}">
                        <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/d252d71940705d10f712f6c0926dc19d2b4b9c59/default_material.svg" alt="">
                        <span>${m.name}</span>
                    </div>
                </div>`;
            } else {
                // Обычное текстовое сообщение
                return `<div class="chat-message ${m.role}">${m.text}</div>`;
            }
        }).join('');
        container.scrollTop = container.scrollHeight;
        
        // Загружаем Lottie анимации для "думающих" сообщений
        messages.forEach(m => {
            if (m.type === 'thinking') {
                setTimeout(async () => {
                    const lottieContainer = document.getElementById(`lottie-thinking-${m.id}`);
                    if(lottieContainer && !lottieContainer.hasAnimation) {
                        try {
                            const response = await fetch('https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/main/Eye%20Loading%20Animation.json');
                            let data = await response.json();
                            
                            // Замена белых и светлых цветов на серый (#797979)
                            const replaceColors = (obj) => {
                                if (Array.isArray(obj)) {
                                    return obj.map((item) => {
                                        if (Array.isArray(item) && item.length === 4 && typeof item[0] === 'number') {
                                            if ((item[0] > 0.8 && item[1] > 0.8 && item[2] > 0.8) ||
                                                (item[0] === 1 && item[1] === 1 && item[2] === 1)) {
                                                return [0.474, 0.474, 0.474, item[3]];
                                            }
                                        }
                                        return replaceColors(item);
                                    });
                                } else if (obj !== null && typeof obj === 'object') {
                                    const result = {};
                                    for (let key in obj) {
                                        result[key] = replaceColors(obj[key]);
                                    }
                                    return result;
                                }
                                return obj;
                            };
                            
                            data = replaceColors(data);
                            
                            const animation = lottie.loadAnimation({
                                container: lottieContainer,
                                renderer: 'svg',
                                loop: true,
                                autoplay: true,
                                animationData: data
                            });
                            animation.setSpeed(0.5);
                            lottieContainer.hasAnimation = true;
                            
                            // Apply gray color filter to match text color
                            lottieContainer.style.filter = 'invert(60%) sepia(0%) saturate(0%) brightness(100%) contrast(100%)';
                        } catch(e) {
                            console.error('Error loading thinking animation:', e);
                        }
                    }
                }, 100);
            }
        });
    }
}
renderChatMessages();

const chatInput = document.getElementById('chat-input');
const chatSend  = document.getElementById('chat-send');

function sendMessage(){
    const text = chatInput.value.trim();
    const hasFiles = attachedFiles.length > 0;
    
    if (!text && !hasFiles) return;
    
    // Add "София думает..." before every Sofia response
    const addThinkingMessage = () => {
        const thinkingMessageId = Date.now();
        chatStore[activeChatTab].push({
            role:'ai', 
            type:'thinking',
            id: thinkingMessageId
        });
        return thinkingMessageId;
    };
    
    // Calculate thinking time based on message length (1-10 seconds)
    const calculateThinkingTime = (messageText) => {
        const baseTime = 1000; // 1 second minimum
        const maxTime = 10000; // 10 seconds maximum
        const charCount = messageText.length;
        // ~100 chars = 1 sec, ~1000 chars = 10 sec
        const thinkingTime = Math.min(maxTime, baseTime + (charCount * 9));
        return thinkingTime;
    };
    
    // Проверяем команду "София, покажи меня"
    if (text.toLowerCase().includes('софия') && text.toLowerCase().includes('покажи меня')) {
        // Добавляем сообщение пользователя в чат
        if (!chatStore[activeChatTab]) chatStore[activeChatTab] = [];
        chatStore[activeChatTab].push({role:'user', text: text});
        
        // Добавляем "София думает..."
        const thinkingId = addThinkingMessage();
        chatInput.value = '';
        renderChatMessages();
        
        const responseText = 'Активирую модуль биометрического мониторинга. Анализирую ваши показатели здоровья...';
        const thinkingTime = calculateThinkingTime(responseText);
        
        // Через calculated time заменяем на ответ
        setTimeout(() => {
            // Удаляем сообщение "думает"
            chatStore[activeChatTab] = chatStore[activeChatTab].filter(m => m.id !== thinkingId);
            
            chatStore[activeChatTab].push({
                role:'ai', 
                text: 'Активирую модуль биометрического мониторинга. Анализирую ваши показатели здоровья...'
            });
            
            renderChatMessages();
            
            // Через еще 1 секунду активируем режим "Монитор"
            setTimeout(() => {
                toggleMonitorMode();
            }, 1000);
        }, thinkingTime);
        
        return;
    }
    
    // Проверяем команду "София [число]" для изменения пульса
    const heartRateMatch = text.match(/софия\s+(\d+)/i);
    if (heartRateMatch) {
        const newHeartRate = parseInt(heartRateMatch[1]);
        
        // Добавляем сообщение пользователя в чат
        if (!chatStore[activeChatTab]) chatStore[activeChatTab] = [];
        chatStore[activeChatTab].push({role:'user', text: text});
        
        // Добавляем "София думает..."
        const thinkingId = addThinkingMessage();
        chatInput.value = '';
        renderChatMessages();
        
        const responseText = `Устанавливаю пульс на ${newHeartRate} уд/мин. Корректирую параметры кардиограммы...`;
        const thinkingTime = calculateThinkingTime(responseText);
        
        // Через calculated time заменяем на ответ
        setTimeout(() => {
            // Удаляем сообщение "думает"
            chatStore[activeChatTab] = chatStore[activeChatTab].filter(m => m.id !== thinkingId);
            
            chatStore[activeChatTab].push({
                role:'ai', 
                text: `Устанавливаю пульс на ${newHeartRate} уд/мин. Корректирую параметры кардиограммы...`
            });
            
            renderChatMessages();
            
            // Обновляем показатели пульса
            updateHeartRate(newHeartRate);
        }, thinkingTime);
        
        return;
    }
    
    // Проверяем команду "София, заметка" для добавления заметки
    if (text.toLowerCase().includes('софия') && text.toLowerCase().includes('заметка')) {
        // Check if user is logged in
        if (!currentUser) {
            if (!chatStore[activeChatTab]) chatStore[activeChatTab] = [];
            chatStore[activeChatTab].push({role:'user', text: text});
            
            const thinkingId = addThinkingMessage();
            chatInput.value = '';
            renderChatMessages();
            
            const responseText = 'Для работы с заметками необходимо войти в систему.';
            const thinkingTime = calculateThinkingTime(responseText);
            
            setTimeout(() => {
                chatStore[activeChatTab] = chatStore[activeChatTab].filter(m => m.id !== thinkingId);
                chatStore[activeChatTab].push({role:'ai', text: responseText});
                renderChatMessages();
            }, thinkingTime);
            
            return;
        }
        
        if (!chatStore[activeChatTab]) chatStore[activeChatTab] = [];
        chatStore[activeChatTab].push({role:'user', text: text});
        
        // Добавляем "София думает..." с Lottie анимацией
        const thinkingMessageId = Date.now();
        chatStore[activeChatTab].push({
            role:'ai', 
            type:'thinking',
            id: thinkingMessageId
        });
        chatInput.value = '';
        renderChatMessages();
        
        const responseText = 'Добавляю заметку в твой профиль.';
        const thinkingTime = calculateThinkingTime(responseText);
        
        // Через calculated time добавляем заметку
        setTimeout(() => {
            // Удаляем сообщение "думает"
            chatStore[activeChatTab].pop();
            
            // Добавляем случайную заметку
            const note = addNote();
            
            chatStore[activeChatTab].push({
                role:'ai', 
                text: `Добавляю заметку в твой профиль.`
            });
            
            // Добавляем блок заметки в чат
            chatStore[activeChatTab].push({
                role:'ai',
                type:'note',
                noteId: note.id,
                title: note.title,
                description: note.description
            });
            
            renderChatMessages();
            
            // Обновляем вкладку "Прогресс" сразу
            refreshProgressTab();
        }, thinkingTime);
        
        return;
    }
    
    // Проверяем команду "София [название достижения]" для разблокировки достижения
    const achievementMatch = text.match(/софия\s+(.+)/i);
    if (achievementMatch && text.toLowerCase().includes('софия')) {
        const achievementTitle = achievementMatch[1].trim();
        
        // Check if user is logged in
        if (!currentUser) {
            if (!chatStore[activeChatTab]) chatStore[activeChatTab] = [];
            chatStore[activeChatTab].push({role:'user', text: text});
            
            const thinkingId = addThinkingMessage();
            chatInput.value = '';
            renderChatMessages();
            
            const responseText = 'Для работы с достижениями необходимо войти в систему.';
            const thinkingTime = calculateThinkingTime(responseText);
            
            setTimeout(() => {
                chatStore[activeChatTab] = chatStore[activeChatTab].filter(m => m.id !== thinkingId);
                chatStore[activeChatTab].push({role:'ai', text: responseText});
                renderChatMessages();
            }, thinkingTime);
            
            return;
        }
        
        // Проверяем, существует ли такое достижение
        const achievement = userAchievements.find(a => 
            a.title.toLowerCase() === achievementTitle.toLowerCase()
        );
        
        if (achievement && !achievement.unlocked) {
            if (!chatStore[activeChatTab]) chatStore[activeChatTab] = [];
            chatStore[activeChatTab].push({role:'user', text: text});
            
            // Добавляем "София думает..." с Lottie анимацией
            const thinkingMessageId = Date.now();
            chatStore[activeChatTab].push({
                role:'ai', 
                type:'thinking',
                id: thinkingMessageId
            });
            chatInput.value = '';
            renderChatMessages();
            
            const responseText = `Вижу, пора присвоить тебе достижение "${achievementTitle}"! 🎉`;
            const thinkingTime = calculateThinkingTime(responseText);
            
            // Через calculated time разблокируем достижение
            setTimeout(() => {
                // Удаляем сообщение "думает"
                chatStore[activeChatTab].pop();
                
                // Разблокируем достижение
                const unlockedAchievement = unlockAchievement(achievementTitle);
                
                if (unlockedAchievement) {
                    chatStore[activeChatTab].push({
                        role:'ai', 
                        text: `Вижу, пора присвоить тебе достижение "${unlockedAchievement.title}"! 🎉`
                    });
                    
                    // Добавляем блок достижения в чат
                    chatStore[activeChatTab].push({
                        role:'ai',
                        type:'achievement',
                        achievementId: unlockedAchievement.id,
                        title: unlockedAchievement.title,
                        description: unlockedAchievement.description
                    });
                }
                
                renderChatMessages();
                
                // Обновляем вкладку "Прогресс" сразу (не только если она открыта)
                refreshProgressTab();
            }, thinkingTime);
            
            return;
        }
    }
    
    if (!chatStore[activeChatTab]) chatStore[activeChatTab] = [];
    
    // Отправляем текст как отдельное сообщение (если есть)
    if (text) {
        chatStore[activeChatTab].push({role:'user', text: text});
    }
    
    // Отправляем каждый файл как отдельное сообщение
    // If multiple attachments include at least one image, treat all attachments as files (no previews)
    const treatAllAsFiles = attachedFiles.length > 1 && attachedFiles.some(f => f.type && f.type.startsWith('image/'));

    attachedFiles.forEach(file => {
        const isImage = file.type && file.type.startsWith('image/');
        
        if (isImage && !treatAllAsFiles) {
            // For single image attachments we create a data URL preview
            const reader = new FileReader();
            reader.onload = function(e) {
                chatStore[activeChatTab].push({
                    role:'user', 
                    type:'image',
                    src: e.target.result,
                    name: file.name || 'Изображение'
                });
                renderChatMessages();
            };
            reader.readAsDataURL(file);
        } else {
            // Treat as generic file (no preview)
            const ext = file.name ? file.name.split('.').pop() : 'file';
            chatStore[activeChatTab].push({
                role:'user',
                type:'file',
                name: file.name || `attach.${ext}`
            });
        }
    });
    
    chatInput.value = '';
    attachedFiles = [];
    renderFilePreview();
    renderChatMessages();
    
    // Add thinking animation before Sofia's response
    const thinkingId = addThinkingMessage();
    renderChatMessages();
    
    // Call Gemini AI
    const userMessageText = text || 'Файл прикреплён';
    callGeminiAPI(userMessageText, chatStore[activeChatTab]).then(aiResult => {
        const responseText = aiResult.response || 'Извини, не смогла обработать запрос.';
        const thinkingTime = calculateThinkingTime(responseText);
        
        setTimeout(() => {
            // Remove thinking message
            chatStore[activeChatTab] = chatStore[activeChatTab].filter(m => m.id !== thinkingId);
            
            // Add AI text response
            chatStore[activeChatTab].push({role:'ai', text: responseText});
            
            // Execute AI actions (achievements, notes, etc.)
            executeAIActions(aiResult.actions);
            
            renderChatMessages();
        }, thinkingTime);
    }).catch(error => {
        console.error('AI error:', error);
        setTimeout(() => {
            chatStore[activeChatTab] = chatStore[activeChatTab].filter(m => m.id !== thinkingId);
            chatStore[activeChatTab].push({
                role:'ai', 
                text: 'Извини, произошла ошибка при обработке запроса. Попробуй ещё раз. 🔧'
            });
            renderChatMessages();
        }, 1000);
    });
}

chatSend.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', e => { if (e.key==='Enter') sendMessage(); });
    document.addEventListener('DOMContentLoaded', () => {
    const sofiaTab = document.querySelector('.chat-tab[data-base="true"]');
    if (sofiaTab && !sofiaTab.hasAttribute('data-listener')) {
        sofiaTab.addEventListener('click', () => {
            switchChatTab('sofia');
            closeAllMenus();
        });
        sofiaTab.setAttribute('data-listener', 'true');
    }
});
// ============================================================
// FILE ATTACHMENTS
// ============================================================
let attachedFiles = [];

// Кнопка прикрепления
document.getElementById('chat-attach').addEventListener('click', () => {
    document.getElementById('chat-file-input').click();
});

// Выбор файлов через input
document.getElementById('chat-file-input').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    files.forEach(file => {
        attachedFiles.push(file);
    });
    renderFilePreview();
    e.target.value = ''; // Очищаем input для повторного выбора
});

// Вставка из буфера обмена
document.getElementById('chat-input').addEventListener('paste', function(e) {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            const blob = items[i].getAsFile();
            attachedFiles.push(blob);
            renderFilePreview();
            e.preventDefault();
        }
    }
});

function renderFilePreview() {
    const container = document.getElementById('chat-file-preview');
    if (attachedFiles.length === 0) {
        container.innerHTML = '';
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'flex';
    container.innerHTML = attachedFiles.map((file, index) => `
        <div class="chat-file-item">
            <img class="file-icon icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/d252d71940705d10f712f6c0926dc19d2b4b9c59/default_material.svg" alt="">
            <span>${file.name || 'Изображение'}</span>
            <img class="file-remove icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/45e14291c38b1dac85196a754e13e9d0da4a01cf/delete.svg" alt="" onclick="removeFile(${index})">
        </div>
    `).join('');
}

// Удаление файла
function removeFile(index) {
    attachedFiles.splice(index, 1);
    renderFilePreview();
}
// ============================================================
// IMAGE MODAL
// ============================================================
function openImageModal(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').classList.add('show');
}

document.getElementById('imageModal').addEventListener('click', function(e) {
    if (e.target === this || e.target.id === 'modalImage') {
        this.classList.remove('show');
    }
});
// PDF modal functions
var PDF_URLS = {
    materials: 'https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/main/MSE%20Cardio%20Anatomy.pdf',
    workouts: 'https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/main/MSE%20Workout.pdf'
};
var currentPDFUrl = '';
var currentPDFBlob = null;
var currentPDFBlobUrl = null;

window.openPDFModal = async function(type) {
    const pdfUrl = PDF_URLS[type];
    currentPDFUrl = pdfUrl;
    const viewer = document.getElementById('pdfModalViewer');
    const overlay = document.getElementById('pdfModalOverlay');
    viewer.innerHTML = '<div style="padding:20px;text-align:center;color:#333">Загрузка документа…</div>';
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';

    try {
        const resp = await fetch(pdfUrl, { mode: 'cors', headers: { 'Accept': 'application/pdf' } });
        if (!resp.ok) throw new Error('Network error: ' + resp.status + ' ' + resp.statusText);
        const blob = await resp.blob();

        // cleanup previous blob url
        if (currentPDFBlobUrl) { URL.revokeObjectURL(currentPDFBlobUrl); currentPDFBlobUrl = null; currentPDFBlob = null; }

        currentPDFBlob = blob;
        currentPDFBlobUrl = URL.createObjectURL(blob);

        // Prefer <object> embedding for broader compatibility; fallback to iframe inside
        viewer.innerHTML = `<object id="pdfObject" data="${currentPDFBlobUrl}#toolbar=0&navpanes=0" type="application/pdf" width="100%" height="100%">` +
            `<iframe id="pdfIframe" src="${currentPDFBlobUrl}#toolbar=0&navpanes=0" style="width:100%;height:100%;border:none"></iframe>` +
            `</object>`;

        // Detect whether embedding actually rendered; if not, surface a clear fallback
        const obj = viewer.querySelector('#pdfObject');
        const ifr = viewer.querySelector('#pdfIframe');
        let loaded = false;

        const onSuccess = () => {
            loaded = true;
        };
        const onFail = () => {
            if (loaded) return;
            // show friendly fallback UI inside viewer (keeps download button below)
            viewer.innerHTML = `<div style="padding:22px;text-align:center;color:#333;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;height:100%">` +
                `<div>Просмотр в модалке недоступен в этом браузере. Откройте файл в новой вкладке или скачайте.</div>` +
                `<div style="width:220px"><button id="openNewTabBtn" style="width:100%;padding:10px;border-radius:6px;border:1px solid rgba(0,0,0,.08);background:#666;color:#fff;cursor:pointer">Открыть в новой вкладке</button></div>` +
                `</div>`;
            const btn = document.getElementById('openNewTabBtn');
            if (btn) btn.addEventListener('click', () => { window.open(currentPDFBlobUrl, '_blank', 'noopener'); });
        };

        try {
            if (obj) obj.addEventListener('load', onSuccess);
            if (ifr) ifr.addEventListener('load', onSuccess);
        } catch (e) { /* ignore */ }

        // If neither loads within 1s, assume embed failed (common with local file origins)
        setTimeout(() => { if (!loaded) onFail(); }, 1000);
    } catch (err) {
        console.error('PDF load error', err);
        viewer.innerHTML = `<div style="padding:20px;color:#333">Не удалось загрузить PDF: ${err.message}. ` +
            `<a href="${pdfUrl}" target="_blank" rel="noreferrer">Открыть в новой вкладке</a></div>`;
    }
};

window.closePDFModal = function() {
    const overlay = document.getElementById('pdfModalOverlay');
    overlay.classList.remove('show');
    document.getElementById('pdfModalViewer').innerHTML = '';
    document.body.style.overflow = '';
    if (currentPDFBlobUrl) { URL.revokeObjectURL(currentPDFBlobUrl); currentPDFBlobUrl = null; currentPDFBlob = null; }
    currentPDFUrl = '';
};

window.downloadPDF = function() {
    // Prefer downloading the fetched blob if available
    if (currentPDFBlob) {
        const a = document.createElement('a');
        const blobUrl = URL.createObjectURL(currentPDFBlob);
        a.href = blobUrl;
        try {
            const parts = currentPDFUrl.split('/');
            const name = decodeURIComponent(parts[parts.length-1].split('?')[0]);
            a.download = name || 'document.pdf';
        } catch (e) { a.download = 'document.pdf'; }
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(blobUrl);
        return;
    }

    // Fallback to direct link
    if (!currentPDFUrl) return;
    const a = document.createElement('a');
    a.href = currentPDFUrl;
    try {
        const parts = currentPDFUrl.split('/');
        const name = decodeURIComponent(parts[parts.length-1].split('?')[0]);
        a.download = name || 'document.pdf';
    } catch (e) { a.download = 'document.pdf'; }
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
};

document.getElementById('pdfModalOverlay').addEventListener('click', function(e){ if (e.target===this) closePDFModal(); });

// ============================================================
// INTERACTIVE ECG CANVAS ANIMATION
// ============================================================
let currentHeartRate = 72; // Global variable for heart rate

function initECGCanvas() {
    const canvas = document.getElementById('ecgCanvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    let animationId;
    
    // Set canvas size
    function resizeCanvas() {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
    }
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // Animation variables
    let time = 0;
    const baseWaveSpeed = 0.015;
    const amplitude = canvas.height * 0.12;
    const baselineY = canvas.height * 0.5;
    
    // Gradient colors (freedom grain style)
    const gradientColors = [
        'rgba(153, 153, 153, 0.8)',
        'rgba(153, 153, 153, 0.6)',
        'rgba(153, 153, 153, 0.4)',
        'rgba(153, 153, 153, 0.2)',
        'rgba(153, 153, 153, 0.1)'
    ];
    
    function drawECGWave() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Calculate wave speed and amplitude based on heart rate
        // Higher heart rate = faster animation and higher amplitude
        // Lower heart rate = slower animation and lower amplitude
        const heartRateRatio = currentHeartRate / 72; // 72 BPM as baseline
        const waveSpeed = baseWaveSpeed * heartRateRatio; // Speed scales with heart rate
        const dynamicAmplitude = amplitude * (0.5 + heartRateRatio * 0.5); // Amplitude: 50% to 150% of base
        
        // Create gradient along the grid boundaries
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
        gradient.addColorStop(0, 'rgba(153, 153, 153, 0.1)');
        gradient.addColorStop(0.2, 'rgba(153, 153, 153, 0.4)');
        gradient.addColorStop(0.5, 'rgba(153, 153, 153, 0.8)');
        gradient.addColorStop(0.8, 'rgba(153, 153, 153, 0.4)');
        gradient.addColorStop(1, 'rgba(153, 153, 153, 0.1)');
        
        // Draw ECG waveform
        ctx.beginPath();
        ctx.strokeStyle = gradient;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        for (let x = 0; x < canvas.width; x += 1) {
            const normalizedX = x / canvas.width;
            const waveX = normalizedX * Math.PI * 8 + time;
            
            // Create ECG-like pattern with spikes
            let y = baselineY;
            
            // Main heartbeat pattern - simpler frequency calculation
            const heartbeatCycle = Math.PI * 4; // One complete heartbeat cycle
            const cyclesPerSecond = currentHeartRate / 60; // BPM to Hz
            const adjustedWaveX = waveX * cyclesPerSecond;
            const heartbeatPhase = adjustedWaveX % heartbeatCycle;
            
            if (heartbeatPhase > 0.5 && heartbeatPhase < 1.5) {
                // P wave (small) - scales with heart rate
                y += Math.sin((heartbeatPhase - 0.5) * Math.PI * 2) * dynamicAmplitude * 0.2;
            } else if (heartbeatPhase > 2 && heartbeatPhase < 3) {
                // QRS complex (large spike) - scales with heart rate
                const qrsPhase = (heartbeatPhase - 2) * Math.PI;
                if (qrsPhase < Math.PI * 0.3) {
                    y -= Math.sin(qrsPhase * 3.33) * dynamicAmplitude * 0.3; // Q wave
                } else if (qrsPhase < Math.PI * 0.7) {
                    y += Math.sin((qrsPhase - Math.PI * 0.3) * 2.5) * dynamicAmplitude * 1.2; // R wave
                } else {
                    y -= Math.sin((qrsPhase - Math.PI * 0.7) * 3.33) * dynamicAmplitude * 0.4; // S wave
                }
            } else if (heartbeatPhase > 4 && heartbeatPhase < 5) {
                // T wave (medium) - scales with heart rate
                y += Math.sin((heartbeatPhase - 4) * Math.PI) * dynamicAmplitude * 0.4;
            }
            
            // Add subtle noise for realism (also scales with heart rate)
            y += (Math.random() - 0.5) * 2 * heartRateRatio;
            
            if (x === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        
        ctx.stroke();
        
        // Draw gradient fill under the wave
        ctx.beginPath();
        const fillGradient = ctx.createLinearGradient(0, baselineY - dynamicAmplitude, 0, baselineY + dynamicAmplitude);
        fillGradient.addColorStop(0, 'rgba(153, 153, 153, 0.1)');
        fillGradient.addColorStop(0.5, 'rgba(153, 153, 153, 0.05)');
        fillGradient.addColorStop(1, 'rgba(153, 153, 153, 0.02)');
        ctx.fillStyle = fillGradient;
        
        // Redraw the path for fill
        for (let x = 0; x < canvas.width; x += 1) {
            const normalizedX = x / canvas.width;
            const waveX = normalizedX * Math.PI * 8 + time;
            
            let y = baselineY;
            const heartbeatCycle = Math.PI * 4; // One complete heartbeat cycle
            const cyclesPerSecond = currentHeartRate / 60; // BPM to Hz
            const adjustedWaveX = waveX * cyclesPerSecond;
            const heartbeatPhase = adjustedWaveX % heartbeatCycle;
            
            if (heartbeatPhase > 0.5 && heartbeatPhase < 1.5) {
                y += Math.sin((heartbeatPhase - 0.5) * Math.PI * 2) * dynamicAmplitude * 0.2;
            } else if (heartbeatPhase > 2 && heartbeatPhase < 3) {
                const qrsPhase = (heartbeatPhase - 2) * Math.PI;
                if (qrsPhase < Math.PI * 0.3) {
                    y -= Math.sin(qrsPhase * 3.33) * dynamicAmplitude * 0.3;
                } else if (qrsPhase < Math.PI * 0.7) {
                    y += Math.sin((qrsPhase - Math.PI * 0.3) * 2.5) * dynamicAmplitude * 1.2;
                } else {
                    y -= Math.sin((qrsPhase - Math.PI * 0.7) * 3.33) * dynamicAmplitude * 0.4;
                }
            } else if (heartbeatPhase > 4 && heartbeatPhase < 5) {
                y += Math.sin((heartbeatPhase - 4) * Math.PI) * dynamicAmplitude * 0.4;
            }
            
            if (x === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        
        // Close the path to baseline for fill
        ctx.lineTo(canvas.width, baselineY);
        ctx.lineTo(0, baselineY);
        ctx.closePath();
        ctx.fill();
        
        time += waveSpeed; // Now uses dynamic speed based on heart rate
    }
    
    function animate() {
        drawECGWave();
        animationId = requestAnimationFrame(animate);
    }
    
    // Start animation
    animate();
    
    // Store animation ID for cleanup
    canvas.animationId = animationId;
}

// ============================================================
// ANIMATED VITAL SIGNS VALUES
// ============================================================
let vitalSignsIntervals = []; // Store interval IDs for cleanup

function initVitalSignsAnimation() {
    // Base values for vital signs
    const baseValues = {
        pulse: 72,
        hrr: 68,
        oxygen: 98
    };
    
    // Fluctuation ranges (±)
    const fluctuations = {
        pulse: 3,    // ±3 bpm
        hrr: 2,      // ±2 bpm
        oxygen: 1    // ±1%
    };
    
    // Update intervals (much slower for natural feel)
    const intervals = {
        pulse: 8000,   // 8 seconds
        hrr: 12000,    // 12 seconds
        oxygen: 15000  // 15 seconds
    };
    
    function updateValue(elementId, baseValue, fluctuation) {
        const element = document.getElementById(elementId);
        if (element) {
            // Use currentHeartRate for pulse calculations if it's been manually set
            let actualBaseValue = baseValue;
            if (elementId === 'pulseValue' && currentHeartRate !== 72) {
                actualBaseValue = currentHeartRate;
            }
            if (elementId === 'hrrValue' && currentHeartRate !== 72) {
                actualBaseValue = currentHeartRate - Math.floor(Math.random() * 3 + 4);
            }
            
            // Generate random fluctuation
            const change = (Math.random() - 0.5) * 2 * fluctuation;
            const newValue = Math.round(actualBaseValue + change);
            
            // Very smooth and slow transition effect
            element.style.transition = 'all 1.5s ease-in-out';
            element.style.opacity = '0.7';
            
            setTimeout(() => {
                element.textContent = newValue;
                element.style.opacity = '1';
            }, 750); // Half of the transition time
        }
    }
    
    // Clear existing intervals
    vitalSignsIntervals.forEach(id => clearInterval(id));
    vitalSignsIntervals = [];
    
    // Start animations for each vital sign
    vitalSignsIntervals.push(setInterval(() => updateValue('pulseValue', baseValues.pulse, fluctuations.pulse), intervals.pulse));
    vitalSignsIntervals.push(setInterval(() => updateValue('hrrValue', baseValues.hrr, fluctuations.hrr), intervals.hrr));
    vitalSignsIntervals.push(setInterval(() => updateValue('oxygenValue', baseValues.oxygen, fluctuations.oxygen), intervals.oxygen));
    
    // Initial random delay to stagger the updates (longer delays)
    setTimeout(() => updateValue('pulseValue', baseValues.pulse, fluctuations.pulse), Math.random() * 5000);
    setTimeout(() => updateValue('hrrValue', baseValues.hrr, fluctuations.hrr), Math.random() * 7000);
    setTimeout(() => updateValue('oxygenValue', baseValues.oxygen, fluctuations.oxygen), Math.random() * 10000);
}

// ============================================================
// HEART RATE CONTROL FUNCTIONS
// ============================================================
function updateHeartRate(newRate) {
    // Update global heart rate variable
    currentHeartRate = Math.max(30, Math.min(220, newRate)); // Clamp between 30-220 BPM
    
    console.log(`Updating heart rate to: ${currentHeartRate} BPM`);
    
    // Check if Monitor mode is active (elements are visible)
    const hiddenModule = document.getElementById('hiddenModule');
    const isMonitorActive = hiddenModule && hiddenModule.style.opacity !== '0';
    
    console.log('Monitor mode active:', isMonitorActive);
    
    // If Monitor mode is not active, activate it first
    if (!isMonitorActive) {
        console.log('Activating Monitor mode first...');
        toggleMonitorMode();
        
        // Wait for Monitor mode to activate, then update values
        setTimeout(() => {
            updateHeartRateValues();
        }, 1000);
    } else {
        // Monitor mode is already active, update immediately
        updateHeartRateValues();
    }
}

function updateHeartRateValues() {
    // Update pulse display immediately
    const pulseElement = document.getElementById('pulseValue');
    console.log('Pulse element found:', pulseElement);
    if (pulseElement) {
        pulseElement.style.transition = 'all 0.8s ease-in-out';
        pulseElement.style.transform = 'scale(1.1)';
        pulseElement.textContent = currentHeartRate;
        
        setTimeout(() => {
            pulseElement.style.transform = 'scale(1)';
        }, 400);
    } else {
        console.log('Pulse element not found - Monitor mode may not be active');
    }
    
    // Update HRR (Heart Rate Reserve) - typically 4-6 BPM lower than pulse
    const hrrElement = document.getElementById('hrrValue');
    console.log('HRR element found:', hrrElement);
    if (hrrElement) {
        const hrrValue = Math.max(25, currentHeartRate - Math.floor(Math.random() * 3 + 4));
        hrrElement.style.transition = 'all 0.8s ease-in-out';
        hrrElement.style.transform = 'scale(1.1)';
        hrrElement.textContent = hrrValue;
        
        setTimeout(() => {
            hrrElement.style.transform = 'scale(1)';
        }, 400);
    } else {
        console.log('HRR element not found - Monitor mode may not be active');
    }
    
    console.log(`Heart rate values updated to: ${currentHeartRate} BPM`);
}

// Initialize ECG canvas and vital signs animation when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    initECGCanvas();
    initVitalSignsAnimation();
});

// Also initialize if DOM is already loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        initECGCanvas();
        initVitalSignsAnimation();
    });
} else {
    initECGCanvas();
    initVitalSignsAnimation();
}

// ============================================================
// BROWSER SEARCH FUNCTIONALITY
// ============================================================
let isSearchActive = false;

function toggleBrowserSearch() {
    const wrap = document.getElementById('browserSearchWrap');
    const input = document.getElementById('browserSearchInput');
    const mainContent = document.getElementById('main-content');
    
    if (wrap.style.display === 'none') {
        wrap.style.display = 'block';
        input.focus();
        isSearchActive = true;
        // Update items list
        updateAllBrowserItems();
    } else {
        wrap.style.display = 'none';
        input.value = '';
        isSearchActive = false;
        // Restore current tab content
        mainContent.innerHTML = getTabHTML(activeInnerTab);
        attachMaterialClickHandlers(activeInnerTab);
    }
}

function renderSearchResults(query) {
    updateAllBrowserItems();
    
    const filtered = allBrowserItems.filter(item => {
        const title = item.title.toLowerCase();
        const desc = item.desc.toLowerCase();
        return title.includes(query) || desc.includes(query);
    });
    
    let html = '<div class="materials-list">';
    
    filtered.forEach(item => {
        const lockIcon = (item.subtype === 'achievement' && !item.unlocked) ? `
            <img class="icon-gray" src="https://raw.githubusercontent.com/CakeBoxDeveloper/MSE/e886b5b608c07e53417b231e710e7ace8dbb3932/padlock.svg" 
                 alt="Заблокировано" style="width:16px;height:16px;opacity:0.5;margin-left:auto;">
        ` : '';
        
        const opacity = (item.subtype === 'achievement' && !item.unlocked) ? '0.5' : '1';
        
        const dataAttrs = item.subtype ? 
            `data-search-type="${item.type}" data-search-subtype="${item.subtype}" data-search-id="${item.id}"` :
            `data-search-type="${item.type}" data-search-index="${item.index}"`;
        
        const itemClass = item.subtype ? 'material-item' : 'material-item clickable-item';
        
        html += `
            <div class="${itemClass} search-result-item" ${dataAttrs} style="opacity:${opacity};cursor:pointer;">
                <div class="material-icon">
                    <img class="icon-gray" src="${item.icon}" alt="">
                </div>
                <div class="material-info" style="flex:1;">
                    <h3>${item.title}</h3>
                    <p>${item.desc}</p>
                </div>
                ${lockIcon}
            </div>
        `;
    });
    
    html += '</div>';
    
    return html;
}

document.addEventListener('DOMContentLoaded', () => {
    const browserSearchInput = document.getElementById('browserSearchInput');
    if (browserSearchInput) {
        browserSearchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            const mainContent = document.getElementById('main-content');
            
            if (query === '') {
                // Show current tab content
                mainContent.innerHTML = getTabHTML(activeInnerTab);
                attachMaterialClickHandlers(activeInnerTab);
            } else {
                // Show search results
                mainContent.innerHTML = renderSearchResults(query);
                attachSearchResultHandlers();
            }
        });
    }
});

function attachSearchResultHandlers() {
    const items = document.querySelectorAll('.search-result-item');
    items.forEach(item => {
        item.addEventListener('click', () => {
            const type = item.dataset.searchType;
            const subtype = item.dataset.searchSubtype;
            const id = item.dataset.searchId;
            const index = item.dataset.searchIndex;
            
            // Close search and clear input
            const wrap = document.getElementById('browserSearchWrap');
            const input = document.getElementById('browserSearchInput');
            if (wrap && input) {
                wrap.style.display = 'none';
                input.value = '';
                isSearchActive = false;
            }
            
            // Switch to appropriate tab and highlight item
            if (type === 'progress') {
                switchToTab('progress');
                setTimeout(() => {
                    if (subtype === 'achievement') {
                        highlightInBrowser('achievement', parseInt(id));
                    } else if (subtype === 'note') {
                        highlightInBrowser('note', parseInt(id));
                    }
                }, 400);
            } else {
                // For materials and workouts, switch to tab and highlight
                switchToTab(type);
                setTimeout(() => {
                    highlightMaterialItem(type, parseInt(index));
                }, 400);
            }
        });
    });
}

function highlightMaterialItem(tabType, itemIndex) {
    // Find the item by its index in the current tab
    const items = document.querySelectorAll('.material-item');
    const element = items[itemIndex];
    
    if (element) {
        // Scroll to element
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Add shimmer effect
        element.classList.add('shimmer');
        
        // Remove shimmer class after animation completes
        setTimeout(() => {
            element.classList.remove('shimmer');
        }, 1000);
    }
}

function switchToTab(tabName) {
    const tab = document.querySelector(`.inner-tab[data-inner="${tabName}"]`);
    if (tab && !tab.classList.contains('active')) {
        tab.click();
    }
}

// ============================================================
// HIGHLIGHT IN BROWSER FUNCTIONALITY
// ============================================================
function highlightInBrowser(type, id) {
    setTimeout(() => {
        // Check if browser is minimized and expand it first
        const browserBlock = document.getElementById('browserBlock');
        const isMinimized = browserBlock && browserBlock.classList.contains('collapsed');
        
        if (isMinimized) {
            toggleMinimize('browserBlock');
            // Wait for expansion animation
            setTimeout(() => {
                switchAndHighlight(type, id);
            }, 800);
        } else {
            switchAndHighlight(type, id);
        }
    }, 0);
}

function switchAndHighlight(type, id) {
    // Switch to progress tab if not already there
    if (activeInnerTab !== 'progress') {
        switchToTab('progress');
        setTimeout(() => {
            highlightElement(type, id);
        }, 400);
    } else {
        highlightElement(type, id);
    }
}

function highlightElement(type, id) {
    let selector;
    if (type === 'achievement') {
        selector = `.material-item[data-achievement-id="${id}"]`;
    } else if (type === 'note') {
        selector = `.material-item[data-note-id="${id}"]`;
    }
    
    const element = document.querySelector(selector);
    if (element) {
        // Scroll to element
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Add shimmer effect
        element.classList.add('shimmer');
        
        // Remove shimmer class after animation completes
        setTimeout(() => {
            element.classList.remove('shimmer');
        }, 1000);
    }
}

// ============================================================
// ACHIEVEMENTS AND NOTES SYSTEM
// ============================================================

// 25 Random achievements
const ACHIEVEMENTS = [
    { id: 1, title: "Первый шаг", description: "Начало пути к здоровому образу жизни", unlocked: false },
    { id: 2, title: "Знаток анатомии", description: "Разбирается в строении мышечной системы", unlocked: false },
    { id: 3, title: "Мастер кардио", description: "Понимает принципы аэробных тренировок", unlocked: false },
    { id: 4, title: "Силовой атлет", description: "Освоил базовые силовые упражнения", unlocked: false },
    { id: 5, title: "Гибкость тела", description: "Знает важность растяжки и мобильности", unlocked: false },
    { id: 6, title: "Нутрициолог", description: "Понимает основы правильного питания", unlocked: false },
    { id: 7, title: "Баланс БЖУ", description: "Разбирается в макронутриентах", unlocked: false },
    { id: 8, title: "Гидратация", description: "Знает важность водного баланса", unlocked: false },
    { id: 9, title: "Восстановление", description: "Понимает роль отдыха в прогрессе", unlocked: false },
    { id: 10, title: "Сон - основа", description: "Осознает важность качественного сна", unlocked: false },
    { id: 11, title: "Зоны пульса", description: "Разбирается в тренировочных зонах ЧСС", unlocked: false },
    { id: 12, title: "Прогрессивная нагрузка", description: "Знает принцип постепенного увеличения", unlocked: false },
    { id: 13, title: "Техника превыше всего", description: "Понимает важность правильной формы", unlocked: false },
    { id: 14, title: "Разминка и заминка", description: "Не пропускает подготовку к тренировке", unlocked: false },
    { id: 15, title: "Дыхание", description: "Освоил правильное дыхание при нагрузках", unlocked: false },
    { id: 16, title: "Метаболизм", description: "Понимает процессы обмена веществ", unlocked: false },
    { id: 17, title: "Гормональный баланс", description: "Знает роль гормонов в тренировках", unlocked: false },
    { id: 18, title: "Суперкомпенсация", description: "Разбирается в адаптации организма", unlocked: false },
    { id: 19, title: "Периодизация", description: "Понимает циклирование нагрузок", unlocked: false },
    { id: 20, title: "Ментальная сила", description: "Развивает психологическую устойчивость", unlocked: false },
    { id: 21, title: "Постановка целей", description: "Умеет ставить SMART-цели", unlocked: false },
    { id: 22, title: "Дисциплина", description: "Следует плану тренировок регулярно", unlocked: false },
    { id: 23, title: "Биомеханика", description: "Понимает механику движений тела", unlocked: false },
    { id: 24, title: "Профилактика травм", description: "Знает как избежать повреждений", unlocked: false },
    { id: 25, title: "Холистический подход", description: "Видит связь тела, разума и духа", unlocked: false }
];

const SAMPLE_NOTES = [
    { title: "Прогресс в приседаниях", description: "Заметила улучшение техники и глубины приседа" },
    { title: "Водный баланс", description: "Рекомендую увеличить потребление воды до 2.5л в день" },
    { title: "Качество сна", description: "Обрати внимание на режим - ложись до 23:00" },
    { title: "Восстановление", description: "Добавь день отдыха между силовыми тренировками" },
    { title: "Питание до тренировки", description: "Углеводы за 1-2 часа дадут больше энергии" },
    { title: "Растяжка", description: "Не забывай про 10 минут стретчинга после тренировки" },
    { title: "Прогресс в весе", description: "Стабильное снижение - продолжай в том же духе" },
    { title: "Техника дыхания", description: "Выдох на усилии помогает стабилизировать корпус" },
    { title: "Разнообразие нагрузок", description: "Попробуй добавить плавание раз в неделю" },
    { title: "Ментальное состояние", description: "Медитация 10 минут улучшит фокус на тренировках" }
];

let userAchievements = [...ACHIEVEMENTS];
let userNotes = [];

function unlockAchievement(achievementTitle) {
    const achievement = userAchievements.find(a => 
        a.title.toLowerCase() === achievementTitle.toLowerCase()
    );
    
    if (achievement && !achievement.unlocked) {
        achievement.unlocked = true;
        
        // Save to Firebase if user is logged in
        if (currentUser) {
            saveAchievementsToFirebase(currentUser.id, userAchievements);
        }
        
        return achievement;
    }
    return null;
}

function addNote(title, description) {
    const note = {
        id: Date.now(),
        title: title || SAMPLE_NOTES[Math.floor(Math.random() * SAMPLE_NOTES.length)].title,
        description: description || SAMPLE_NOTES[Math.floor(Math.random() * SAMPLE_NOTES.length)].description,
        date: new Date()
    };
    userNotes.unshift(note);
    
    // Save to Firebase if user is logged in
    if (currentUser) {
        saveNotesToFirebase(currentUser.id, userNotes);
    }
    
    return note;
}

// ============================================================
// DYNAMIC FADE GRADIENTS FOR CHAT AND BROWSER
// ============================================================

// Update chat fade gradient based on scroll position
function updateChatFadeGradient() {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    
    const atTop = container.scrollTop <= 5;
    const atBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 5;
    
    if (atTop && atBottom) {
        // No scroll needed - no gradient
        container.style.maskImage = 'none';
        container.style.webkitMaskImage = 'none';
    } else if (atTop) {
        // At top - only bottom gradient
        container.style.maskImage = 'linear-gradient(to bottom, black 0%, black 92%, transparent 100%)';
        container.style.webkitMaskImage = 'linear-gradient(to bottom, black 0%, black 92%, transparent 100%)';
    } else if (atBottom) {
        // At bottom - only top gradient
        container.style.maskImage = 'linear-gradient(to bottom, transparent 0%, black 8%, black 100%)';
        container.style.webkitMaskImage = 'linear-gradient(to bottom, transparent 0%, black 8%, black 100%)';
    } else {
        // In middle - both gradients
        container.style.maskImage = 'linear-gradient(to bottom, transparent 0%, black 8%, black 92%, transparent 100%)';
        container.style.webkitMaskImage = 'linear-gradient(to bottom, transparent 0%, black 8%, black 92%, transparent 100%)';
    }
}

// Update browser fade gradient based on scroll position
function updateBrowserFadeGradient() {
    const container = document.querySelector('.materials-list');
    if (!container) return;
    
    const atTop = container.scrollTop <= 5;
    const atBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 5;
    
    if (atTop && atBottom) {
        // No scroll needed - no gradient
        container.style.maskImage = 'none';
        container.style.webkitMaskImage = 'none';
    } else if (atTop) {
        // At top - only bottom gradient
        container.style.maskImage = 'linear-gradient(to bottom, black 0%, black 92%, transparent 100%)';
        container.style.webkitMaskImage = 'linear-gradient(to bottom, black 0%, black 92%, transparent 100%)';
    } else if (atBottom) {
        // At bottom - only top gradient
        container.style.maskImage = 'linear-gradient(to bottom, transparent 0%, black 8%, black 100%)';
        container.style.webkitMaskImage = 'linear-gradient(to bottom, transparent 0%, black 8%, black 100%)';
    } else {
        // In middle - both gradients
        container.style.maskImage = 'linear-gradient(to bottom, transparent 0%, black 8%, black 92%, transparent 100%)';
        container.style.webkitMaskImage = 'linear-gradient(to bottom, transparent 0%, black 8%, black 92%, transparent 100%)';
    }
}

// Add scroll listeners and update on render
const originalRenderChatMessages = renderChatMessages;
renderChatMessages = function() {
    originalRenderChatMessages();
    setTimeout(updateChatFadeGradient, 100);
};

// Observer for materials-list (since it's dynamically created)
const browserObserver = new MutationObserver(() => {
    const materialsList = document.querySelector('.materials-list');
    if (materialsList && !materialsList.hasScrollListener) {
        materialsList.addEventListener('scroll', updateBrowserFadeGradient);
        materialsList.hasScrollListener = true;
        // Initial check
        setTimeout(updateBrowserFadeGradient, 100);
    }
});

document.addEventListener('DOMContentLoaded', () => {
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        chatMessages.addEventListener('scroll', updateChatFadeGradient);
        // Initial check
        setTimeout(updateChatFadeGradient, 100);
    }
    
    const mainContent = document.getElementById('main-content');
    if (mainContent) {
        browserObserver.observe(mainContent, { childList: true, subtree: true });
    }
});

</script>
</body>
</html>
